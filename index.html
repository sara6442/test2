<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهامي - تطبيق إدارة المهام المتقدم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    /* ========== المتغيرات والأساسيات ========== */
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --accent-color: #7209b7;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --warning-color: #f8961e;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --gray-color: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        
        /* ثيم افتراضي (رمادي) */
        --theme-bg: #ffffff;
        --theme-sidebar: linear-gradient(180deg, #5a6268, #495057);
        --theme-text: #212529;
        --theme-card: white;
        --theme-border: #dee2e6;
        --theme-primary: #6c757d;
        --theme-hover: #5a6268;
        --theme-text-light: #6c757d; /* لون نص فاتح للثيمات الداكنة */
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--theme-bg);
        color: var(--theme-text);
        direction: rtl;
        min-height: 100vh;
        transition: var(--transition);
        position: relative;
    }
   
    /* ========== تنسيقات الثيمات ========== */
    .theme-gray {
        --theme-bg: #ffffff;
        --theme-sidebar: linear-gradient(180deg, #5a6268, #495057);
        --theme-text: #212529;
        --theme-text-light: #6c757d;
        --theme-card: white;
        --theme-border: #dee2e6;
        --theme-primary: #6c757d;
        --theme-hover: #5a6268;
    }
    
    .theme-black {
        --theme-bg: #121212;
        --theme-sidebar: linear-gradient(180deg, #1e1e1e, #2d2d2d);
        --theme-text: #f0f0f0; /* لون فاتح للقراءة */
        --theme-text-light: #b0b0b0; /* لون فاتح أكثر */
        --theme-card: #1e1e1e;
        --theme-border: #333333;
        --theme-primary: #444444;
        --theme-hover: #555555;
    }
    
    .theme-blue {
        --theme-bg: #f0f7ff;
        --theme-sidebar: linear-gradient(180deg, #4361ee, #3a56d4);
        --theme-text: #212529;
        --theme-text-light: #5a6268;
        --theme-card: #ffffff;
        --theme-border: #c2d6ff;
        --theme-primary: #4361ee;
        --theme-hover: #3a56d4;
    }
    
    .theme-beige {
        --theme-bg: #fefaf6;
        --theme-sidebar: linear-gradient(180deg, #d7ccc8, #bcaaa4);
        --theme-text: #5d4037;
        --theme-text-light: #8d6e63;
        --theme-card: white;
        --theme-border: #d7ccc8;
        --theme-primary: #8d6e63;
        --theme-hover: #6d4c41;
    }
    
    /* ========== الهيكل الرئيسي ========== */
    .app-container {
        display: flex;
        min-height: 100vh;
    }
    
    /* الشريط الجانبي */
    .sidebar {
        width: 280px;
        background: var(--theme-sidebar);
        color: white;
        padding: 20px 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        height: 100vh;
        z-index: 100;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
    }
    
    .logo {
        padding: 0 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
    }
    
    .logo h1 {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.5rem;
        color: white;
    }
    
    .nav-menu {
        padding: 0 15px;
        flex: 1;
    }
    
    .nav-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        border-radius: 10px;
        margin-bottom: 8px;
        transition: var(--transition);
        cursor: pointer;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .nav-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(-5px);
    }
    
    .nav-item.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: 600;
        border-right: 4px solid white;
    }
    
    .nav-item i {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
    }
    
    /* زر الإعدادات في الأسفل */
    .sidebar-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .settings-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        width: 100%;
        font-size: 1rem;
    }
    
    .settings-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    /* نافذة اختيار الثيم */
    .settings-popup {
        position: absolute;
        bottom: 70px;
        right: 20px;
        background: var(--theme-card);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--theme-border);
        display: none;
        z-index: 1000;
        min-width: 200px;
    }
    
    .settings-popup.active {
        display: block;
    }
    
    .settings-popup h4 {
        margin-bottom: 15px;
        color: var(--theme-text);
        text-align: center;
    }
    
    .theme-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .theme-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid transparent;
    }
    
    .theme-option:hover {
        background: var(--theme-border);
    }
    
    .theme-option.active {
        border-color: var(--theme-primary);
        background: rgba(67, 97, 238, 0.1);
    }
    
    .theme-preview {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--theme-border);
    }
    
    .theme-name {
        font-size: 0.85rem;
        color: var(--theme-text);
    }
     
    .theme-gray-preview { background: linear-gradient(45deg, #5a6268, #495057); }
    .theme-black-preview { background: linear-gradient(45deg, #1e1e1e, #2d2d2d); }
    .theme-blue-preview { background: linear-gradient(45deg, #4361ee, #3a56d4); }
    .theme-beige-preview { background: linear-gradient(45deg, #d7ccc8, #bcaaa4); }
    
    /* المحتوى الرئيسي */
    .main-content {
        flex: 1;
        margin-right: 280px;
        padding: 25px;
        transition: var(--transition);
    }
    
    /* ========== الهيدر ========== */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 25px;
        background: var(--theme-card);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid var(--theme-border);
    }
    
    .header-left h1 {
        color: var(--theme-primary);
        margin-bottom: 8px;
        font-size: 1.8rem;
    }
    
    .current-date {
        color: var(--gray-color);
        font-size: 0.95rem;
    }
    
    /* ========== الأزرار ========== */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: var(--transition);
        font-weight: 500;
    }
    
    .btn-primary {
        background: var(--theme-primary);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--theme-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-secondary {
        background: var(--theme-card);
        color: var(--theme-text);
        border: 1px solid var(--theme-border);
    }
    
    .btn-secondary:hover {
        background: var(--theme-border);
        transform: translateY(-2px);
    }
    
    .btn-danger {
        background: #edd8df;
        color: #8a4b5c;
        border: 1px solid #d9c2ca;
    }
    
    .btn-danger:hover {
        background: #dec9d1;
        color: #7a3b4c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 75, 92, 0.15);
    }
    
    .btn-success {
        background: var(--success-color);
        color: white;
    }
        
    .btn-success:hover {
        background: #3ab5e0;
        transform: translateY(-2px);
    }
    
    .btn-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .btn-warning:hover {
        background: #ffeaa7;
        transform: translateY(-2px);
    }
    
    .btn-sm {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 8px;
    }
    
    .btn-xs {
        padding: 4px 10px;
        font-size: 0.8rem;
        border-radius: 6px;
    }
    
    /* ========== منطقة المحتوى ========== */
    .content-area {
        background: var(--theme-card);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: var(--box-shadow);
        min-height: 500px;
        border: 1px solid var(--theme-border);
        transition: var(--transition);
    }
    
    .view {
        display: none;
    }
    
    .view.active {
        display: block;
    }
    
    /* ========== عرض حالة الفئات ========== */
    .categories-status-container {
        background: var(--theme-card);
        border-radius: var(--border-radius);
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid var(--theme-border);
        box-shadow: var(--box-shadow);
    }
    
    .categories-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .categories-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .category-status-card {
        background: var(--theme-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--theme-border);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .category-status-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    
    .category-status-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--theme-border);
    }
    
    .category-status-color {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .category-status-name {
        font-weight: 600;
        flex: 1;
        font-size: 1.1rem;
        color: var(--theme-text);
    }
    
    .category-status-message {
        padding: 15px;
        border-radius: 8px;
        background: var(--theme-bg);
        border: 1px solid var(--theme-border);
        margin-top: 15px;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--theme-text);
    }
    
    .category-status-info {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    
    .category-status-timeframe {
        display: inline-block;
        padding: 4px 10px;
        background: var(--theme-bg);
        border-radius: 15px;
        font-size: 0.8rem;
        margin-top: 10px;
        color: var(--theme-text-light);
        border: 1px solid var(--theme-border);
    }
    
    /* ========== عرض المهام ========== */
    .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .task-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: var(--theme-card);
        border-radius: 12px;
        border-right: 5px solid var(--theme-primary);
        transition: var(--transition);
        position: relative;
        border: 1px solid var(--theme-border);
    }
    
    .task-card:hover {
        transform: translateX(-8px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    .task-card.completed {
        opacity: 0.7;
        border-color: var(--success-color);
        order: 999; /* يجعل المهام المكتملة في الأسفل */
    }
    
    .task-card.overdue {
        border-color: var(--danger-color);
        background: rgba(247, 37, 133, 0.05);
        order: -1; /* يجعل المهام المتأخرة في الأعلى */
    }
    
    .task-card.completed .task-title {
        text-decoration: line-through;
        color: var(--theme-text-light);
    }
    
    .task-checkbox {
        width: 22px;
        height: 22px;
        cursor: pointer;
        accent-color: var(--theme-primary);
    }
    
    .task-content {
        flex: 1;
    }
    
    .task-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }
    
    .task-description {
        color: var(--theme-text-light);
        font-size: 0.95rem;
        margin-bottom: 12px;
        line-height: 1.5;
    }
    
    .task-meta {
        display: flex;
        gap: 20px;
        font-size: 0.9rem;
        color: var(--theme-text-light);
    }
    
    .task-meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .task-actions {
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: var(--transition);
    }
    
    .task-card:hover .task-actions {
        opacity: 1;
    }
    
    /* ========== مرشحات المهام ========== */
    .task-filters {
        display: flex;
        gap: 15px;
        margin-top: 40px;
        padding: 25px;
        background: var(--theme-card);
        border-radius: var(--border-radius);
        border: 1px solid var(--theme-border);
        flex-wrap: wrap;
    }
    
    .filter-btn {
        padding: 10px 24px;
        border: 2px solid var(--theme-border);
        background: var(--theme-card);
        border-radius: 25px;
        cursor: pointer;
        transition: var(--transition);
        color: var(--theme-text);
        font-weight: 500;
    }
    
    .filter-btn:hover {
        border-color: var(--theme-primary);
        color: var(--theme-primary);
        transform: translateY(-2px);
    }
    
    .filter-btn.active {
        background: var(--theme-primary);
        color: white;
        border-color: var(--theme-primary);
    }
    
    /* ========== عرض الفئات ========== */
    .categories-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 25px;
    }
    
    .category-card {
        background: var(--theme-card);
        border-radius: 12px;
        padding: 25px;
        border: 1px solid var(--theme-border);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .category-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .category-color {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        cursor: pointer;
    }
    
    .category-name {
        font-weight: 600;
        flex: 1;
        font-size: 1.2rem;
        color: var(--theme-text);
    }
    
    .category-stats {
        font-size: 0.9rem;
        color: var(--theme-text-light);
    }
    
    .category-timeframe {
        display: inline-block;
        padding: 5px 12px;
        background: var(--theme-bg);
        border-radius: 15px;
        font-size: 0.8rem;
        margin-top: 10px;
        color: var(--theme-text-light);
        border: 1px solid var(--theme-border);
    }
    
    .category-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: var(--transition);
    }
    
    .category-card:hover .category-actions {
        opacity: 1;
    }
    
    /* شريط التقدم داخل الفئة */
    .category-progress-container {
        width: 100%;
        height: 8px;
        background: var(--theme-border);
        border-radius: 4px;
        margin: 15px 0;
        overflow: hidden;
        position: relative;
    }
    
    .category-progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
        background: var(--theme-primary);
    }
    
    .category-progress-bar.completed {
        background: var(--success-color);
    }
    
    .category-progress-bar.empty {
        width: 0%;
    }
    
    .category-progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: var(--theme-text-light);
        margin-bottom: 15px;
    }
    
    /* زر إضافة مهمة داخل الفئة */
    .category-add-task-btn {
        width: 100%;
        margin-top: 15px;
    }
    
    /* شريط المهام داخل الفئة */
    .category-tasks-container {
        margin: 15px 0;
        max-height: 300px;
        overflow-y: auto;
        padding-right: 10px;
        border: 1px solid var(--theme-border);
        border-radius: 8px;
        padding: 15px;
        background: var(--theme-card);
    }
    
    .category-task-item {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-right: 3px solid;
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        background: var(--theme-card);
        border: 1px solid var(--theme-border);
        border-bottom: 1px solid var(--theme-border);
    }
    
    .category-task-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .category-task-item:hover {
        transform: translateX(-5px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        background: var(--theme-border);
    }
    
    .category-task-item.completed {
        opacity: 0.6;
        border-color: var(--success-color);
    }
    
    .category-task-title {
        font-weight: 500;
        margin-bottom: 5px;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .category-task-meta {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    
    /* ========== عرض الملاحظات ========== */
    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 25px;
    }
    
    .note-card {
        background: var(--theme-card);
        border-radius: 12px;
        padding: 25px;
        border: 1px solid var(--theme-border);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        min-height: 200px;
        display: flex;
        flex-direction: column;
    }
    
    .note-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--theme-primary);
    }
    
    .note-title {
        font-weight: 600;
        font-size: 1.2rem;
        color: var(--theme-primary);
        border: none;
        background: transparent;
        width: 70%;
        padding: 5px;
        border-radius: 4px;
        transition: var(--transition);
    }
    
    .note-title:focus {
        outline: none;
        background: var(--theme-border);
    }
    
    .note-date {
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    
    .note-content {
        flex: 1;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        background: var(--theme-bg);
        overflow-y: auto;
        min-height: 100px;
        border: 1px solid var(--theme-border);
        transition: var(--transition);
        line-height: 1.6;
        color: var(--theme-text) !important; /* إجبار اللون على التكيف مع الثيم */
    }
    
    .note-content:focus {
        outline: none;
        border-color: var(--theme-primary);
    }
    
    /* خانة الاختيار في الملاحظات */
    .note-checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 6px;
        transition: var(--transition);
    }
    
    .note-checkbox-item:hover {
        background: rgba(var(--theme-primary-rgb, 67, 97, 238), 0.05);
    }
    
    .note-checkbox-item.completed {
        opacity: 0.7;
    }
    
    .note-checkbox-item.completed .note-checkbox-text {
        text-decoration: line-through;
        color: var(--theme-text-light);
    }
    
    .note-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--theme-primary);
    }
    
    .note-checkbox-text {
        flex: 1;
        font-size: 0.95rem;
        color: var(--theme-text);
    }
    
    .note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
    }
    
    .note-font {
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    
    .note-actions {
        display: flex;
        gap: 8px;
    }
    
    /* محرر الملاحظات المتقدم */
    .notes-editor-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--theme-card);
        z-index: 10000;
        display: none;
        flex-direction: column;
    }
    
    .notes-editor-container.active {
        display: flex;
    }
    
    .notes-toolbar {
        background: var(--theme-card);
        padding: 15px 25px;
        border-bottom: 1px solid var(--theme-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .notes-toolbar-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .notes-title-input {
        font-size: 1.5rem;
        font-weight: 600;
        border: none;
        background: transparent;
        color: var(--theme-text);
        min-width: 300px;
        padding: 5px 10px;
        border-radius: 6px;
        border: 2px solid transparent;
    }
    
    .notes-title-input:focus {
        outline: none;
        border-color: var(--theme-primary);
    }
    
    .notes-toolbar-right {
        display: flex;
        gap: 10px;
    }
    
    /* أدوات التنسيق */
    .formatting-tools {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        background: var(--theme-card);
        padding: 10px 25px;
        border-bottom: 1px solid var(--theme-border);
        align-items: center;
    }
    
    .format-btn {
        padding: 8px 12px;
        border: 1px solid var(--theme-border);
        background: var(--theme-card);
        border-radius: 6px;
        cursor: pointer;
        color: var(--theme-text);
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .format-btn:hover {
        background: var(--theme-border);
    }
    
    .format-btn.active {
        background: var(--theme-primary);
        color: white;
        border-color: var(--theme-primary);
    }
    
    .font-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .font-select, .font-size-input {
        padding: 6px 10px;
        border: 1px solid var(--theme-border);
        border-radius: 6px;
        background: var(--theme-card);
        color: var(--theme-text);
        min-width: 120px;
    }
    
    .font-color-input {
        width: 40px;
        height: 34px;
        border: 1px solid var(--theme-border);
        border-radius: 6px;
        background: var(--theme-card);
        cursor: pointer;
    }
    
    .font-weight-select, .font-style-select {
        padding: 6px 10px;
        border: 1px solid var(--theme-border);
        border-radius: 6px;
        background: var(--theme-card);
        color: var(--theme-text);
        min-width: 100px;
    }
    
    /* محتوى المحرر */
    .notes-content {
        flex: 1;
        padding: 30px;
        font-size: 16px;
        line-height: 1.8;
        outline: none;
        background: var(--theme-card);
        color: var(--theme-text) !important; /* إجبار اللون على التكيف مع الثيم */
        overflow-y: auto;
        min-height: 300px;
        border: none;
        resize: none;
        width: 100%;
        font-family: inherit;
    }
    
    .notes-content:focus {
        outline: none;
    }
    
    /* ========== الجدول الزمني ========== */
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 20px;
        background: var(--theme-card);
        border-radius: var(--border-radius);
        border: 1px solid var(--theme-border);
    }
    
    .calendar-tabs {
        display: flex;
        gap: 10px;
    }
    
    .calendar-tab {
        padding: 10px 24px;
        border: 2px solid var(--theme-border);
        background: var(--theme-card);
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        color: var(--theme-text);
        font-weight: 500;
    }
    
    .calendar-tab:hover {
        border-color: var(--theme-primary);
        color: var(--theme-primary);
    }
    
    .calendar-tab.active {
        background: var(--theme-primary);
        color: white;
        border-color: var(--theme-primary);
    }
    
    .calendar-nav {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* الجدول اليومي */
    .daily-calendar {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 20px;
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .time-slot {
        background: var(--theme-card);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--theme-border);
        min-height: 100px;
    }
    
    .time-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--theme-primary);
    }
    
    .time-title {
        font-weight: 600;
        color: var(--theme-primary);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .time-tasks {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .calendar-task-card {
        background: var(--theme-card);
        border-radius: 8px;
        padding: 12px;
        border-left: 4px solid;
        border-right: 4px solid;
        transition: var(--transition);
        cursor: pointer;
        position: relative;
        border: 1px solid var(--theme-border);
    }
    
    .calendar-task-card:hover {
        transform: translateX(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background: var(--theme-border);
    }
    
    .calendar-task-card.no-time {
        border-left-color: #999;
        border-right-color: #999;
        background-color: rgba(0,0,0,0.03);
    }
    
    .calendar-task-title {
        font-weight: 500;
        margin-bottom: 5px;
        font-size: 0.95rem;
    }
    
    .calendar-task-meta {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
        color: var(--theme-text-light);
    }
    
    /* الجدول الأسبوعي */
    .weekly-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
        margin-top: 20px;
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .day-column {
        background: var(--theme-card);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--theme-border);
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .day-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--theme-primary);
        position: sticky;
        top: 0;
        background: var(--theme-card);
        z-index: 1;
    }
    
    .day-name {
        font-weight: 600;
        color: var(--theme-primary);
        font-size: 1.1rem;
    }
    
    .day-date {
        color: var(--theme-text-light);
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .day-tasks {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    /* الجدول الشهري */
    .monthly-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-top: 20px;
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .month-day {
        background: var(--theme-card);
        border-radius: 8px;
        padding: 10px;
        min-height: 120px;
        border: 1px solid var(--theme-border);
        position: relative;
        overflow-y: auto;
        max-height: 150px;
    }
    
    .day-number {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--theme-text);
        font-size: 1.2rem;
        position: sticky;
        top: 0;
        background: var(--theme-card);
        padding: 2px 0;
    }
    
    .today .day-number {
        color: var(--theme-primary);
        font-weight: bold;
        background: rgba(67, 97, 238, 0.1);
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
    }
    
    .month-tasks {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .month-task-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
        display: inline-block;
    }
    
    .month-task-item {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: var(--transition);
        background: rgba(0,0,0,0.05);
        margin-bottom: 4px;
    }
    
    .month-task-item:hover {
        background: rgba(0,0,0,0.1);
    }
    
    /* ========== النوافذ المنبثقة ========== */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: var(--theme-card);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--theme-border);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--theme-border);
    }
    
    .modal-header h3 {
        color: var(--theme-primary);
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--theme-text-light);
        transition: var(--transition);
    }
    
    .close-btn:hover {
        color: var(--danger-color);
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid var(--theme-border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    /* نماذج الإدخال */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--theme-text);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--theme-border);
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
        background: var(--theme-card);
        color: var(--theme-text);
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }
    
    .form-row {
        display: flex;
        gap: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    /* ========== التلميحات المحسنة ========== */
    .tooltip {
        position: fixed; /* ثابتة في الشاشة */
        background: var(--theme-card);
        color: var(--theme-text);
        padding: 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        border: 1px solid var(--theme-border);
        display: none;
        pointer-events: none;
        line-height: 1.5;
        backdrop-filter: blur(5px);
    }
    
    .tooltip-content {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .tooltip-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--theme-primary);
        font-size: 1rem;
        border-bottom: 2px solid var(--theme-primary);
        padding-bottom: 5px;
    }
    
    .tooltip-info {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px;
        font-size: 0.85rem;
    }
    
    .tooltip-label {
        color: var(--theme-text-light);
        min-width: 70px;
    }
    
    .tooltip-value {
        color: var(--theme-text);
        font-weight: 500;
    }
    
    /* ========== التصميم المتجاوب ========== */
    @media (max-width: 1200px) {
        .sidebar {
            width: 70px;
            padding: 15px 0;
        }
        
        .sidebar .logo h1 span,
        .sidebar .nav-item span,
        .sidebar .settings-btn span {
            display: none;
        }
        
        .logo h1 {
            justify-content: center;
        }
        
        .nav-item {
            justify-content: center;
            padding: 15px 0;
        }
        
        .settings-btn {
            justify-content: center;
        }
        
        .settings-popup {
            right: 5px;
            left: 5px;
            width: auto;
        }
        
        .main-content {
            margin-right: 70px;
        }
        
        .weekly-calendar {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .monthly-calendar {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .categories-status-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .app-container {
            flex-direction: column;
        }
        
        .sidebar {
            position: static;
            width: 100%;
            height: auto;
            padding: 10px;
        }
        
        .nav-menu {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
        }
        
        .nav-item {
            flex-shrink: 0;
        }
        
        .main-content {
            margin-right: 0;
            padding: 15px;
        }
        
        .categories-grid, .notes-grid, .categories-status-grid {
            grid-template-columns: 1fr;
        }
        
        .weekly-calendar {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .monthly-calendar {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .calendar-tabs {
            flex-direction: column;
        }
        
        .formatting-tools {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .font-controls {
            flex-wrap: wrap;
        }
    }
    
    @media (max-width: 480px) {
        .weekly-calendar {
            grid-template-columns: 1fr;
        }
        
        .monthly-calendar {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .task-filters {
            flex-direction: column;
        }
        
        .filter-btn {
            width: 100%;
            text-align: center;
        }
    }
    
    /* ========== تأثيرات خاصة ========== */
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
        100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ========== شريط التمرير المخصص ========== */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--theme-card);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--theme-primary);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--theme-hover);
    }
    </style>
</head>
<body class="theme-gray">
    <div class="app-container">
        <!-- الشريط الجانبي -->
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-tasks"></i> <span>مهامي</span></h1>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-view="tasks">
                    <i class="fas fa-list-check"></i>
                    <span>المهام</span>
                </a>
                <a href="#" class="nav-item" data-view="calendar">
                    <i class="fas fa-calendar-days"></i>
                    <span>الجدول</span>
                </a>
                <a href="#" class="nav-item" data-view="categories">
                    <i class="fas fa-tags"></i>
                    <span>الفئات</span>
                </a>
                <a href="#" class="nav-item" data-view="categories-status">
                    <i class="fas fa-chart-bar"></i>
                    <span>حالة الفئات</span>
                </a>
                <a href="#" class="nav-item" data-view="notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>الملاحظات</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="settings-btn" id="settings-btn">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </button>
            </div>
            
            <!-- نافذة الإعدادات (الثيمات فقط) -->
            <div class="settings-popup" id="settings-popup">
                <h4>اختر الثيم</h4>
                <div class="theme-options">
                    <div class="theme-option active" data-theme="gray">
                        <div class="theme-preview theme-gray-preview"></div>
                        <span class="theme-name">رمادي</span>
                    </div>
                    <div class="theme-option" data-theme="black">
                        <div class="theme-preview theme-black-preview"></div>
                        <span class="theme-name">أسود</span>
                    </div>
                    <div class="theme-option" data-theme="blue">
                        <div class="theme-preview theme-blue-preview"></div>
                        <span class="theme-name">أزرق</span>
                    </div>
                    <div class="theme-option" data-theme="beige">
                        <div class="theme-preview theme-beige-preview"></div>
                        <span class="theme-name">بيج</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 id="page-title">المهام</h1>
                    <div id="current-date" class="current-date"></div>
                </div>
                <div>
                    <!-- زر إضافة مهمة رئيسي فقط هنا -->
                    <button class="btn btn-primary" id="add-task-btn">
                        <i class="fas fa-plus"></i> إضافة مهمة
                    </button>
                </div>
            </header>

            <!-- منطقة المحتوى -->
            <div class="content-area">
                <!-- عرض المهام -->
                <div id="tasks-view" class="view active">
                    <div class="tasks-list" id="tasks-list">
                        <!-- المهام ستظهر هنا -->
                    </div>
                    
                    <!-- مرشحات المهام -->
                    <div class="task-filters">
                        <button class="filter-btn active" data-filter="pending">المهام النشطة</button>
                        <button class="filter-btn" data-filter="completed">المكتملة</button>
                        <button class="filter-btn" data-filter="deleted">المحذوفة</button>
                        <button class="filter-btn" data-filter="overdue">المتأخرة</button>
                        <button class="filter-btn" data-filter="all">الكل</button>
                    </div>
                </div>

                <!-- عرض الجدول -->
                <div id="calendar-view" class="view">
                    <div class="calendar-controls">
                        <div class="calendar-tabs">
                            <button class="calendar-tab active" data-range="daily">يومي</button>
                            <button class="calendar-tab" data-range="weekly">أسبوعي</button>
                            <button class="calendar-tab" data-range="monthly">شهري</button>
                        </div>
                    </div>
                    <div id="calendar-content">
                        <!-- محتوى الجدول -->
                    </div>
                </div>

                <!-- عرض الفئات -->
                <div id="categories-view" class="view">
                    <div class="categories-header">
                        <div>
                            <h2 style="color: var(--theme-text);">إدارة الفئات</h2>
                            <p style="color: var(--theme-text-light); margin-top: 10px;">إدارة فئات المهام وإضافة مهام جديدة لها</p>
                        </div>
                        <button class="btn btn-primary" id="add-category-btn">
                            <i class="fas fa-plus"></i> فئة جديدة
                        </button>
                    </div>
                    <div class="categories-grid" id="categories-list">
                        <!-- الفئات ستظهر هنا -->
                    </div>
                </div>

                <!-- عرض حالة الفئات -->
                <div id="categories-status-view" class="view">
                    <div class="categories-status-header">
                        <div>
                            <h2 style="color: var(--theme-text);">حالة الفئات</h2>
                            <p style="color: var(--theme-text-light); margin-top: 10px;">عرض حالة الفئات والرسائل الخاصة بكل فئة</p>
                        </div>
                        <button class="btn btn-secondary" id="refresh-status-btn">
                            <i class="fas fa-sync-alt"></i> تحديث الحالة
                        </button>
                    </div>
                    <div class="categories-status-container">
                        <div class="categories-status-grid" id="categories-status-list">
                            <!-- حالة الفئات ستظهر هنا -->
                        </div>
                    </div>
                </div>

                <!-- عرض الملاحظات -->
                <div id="notes-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h2 style="color: var(--theme-text);">الملاحظات</h2>
                            <p style="color: var(--theme-text-light); margin-top: 10px;">إدارة ملاحظاتك الخاصة مع تنسيق متكامل</p>
                        </div>
                        <button class="btn btn-primary" id="add-note-btn">
                            <i class="fas fa-plus"></i> ملاحظة جديدة
                        </button>
                    </div>
                    <div class="notes-grid" id="notes-list">
                        <!-- الملاحظات ستظهر هنا -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== النوافذ المنبثقة ========== -->
    
    <!-- نافذة إضافة مهمة -->
    <div class="modal" id="add-task-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>إضافة مهمة جديدة</h3>
                <button class="close-btn" id="close-task-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-title">عنوان المهمة *</label>
                        <input type="text" id="task-title" placeholder="أدخل عنوان المهمة" required>
                    </div>
                    <div class="form-group">
                        <label for="task-category">الفئة *</label>
                        <select id="task-category" required>
                            <option value="">-- اختر الفئة --</option>
                            <!-- الفئات ستضاف هنا -->
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-date">تاريخ الاستحقاق</label>
                            <input type="date" id="task-date">
                        </div>
                        <div class="form-group">
                            <label for="task-time">الوقت</label>
                            <input type="time" id="task-time">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-duration">المدة (دقائق)</label>
                            <input type="number" id="task-duration" min="1" value="30">
                        </div>
                        <div class="form-group">
                            <label for="task-priority">الأولوية</label>
                            <select id="task-priority">
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-description">الوصف</label>
                        <textarea id="task-description" placeholder="أدخل وصف المهمة" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-task">إلغاء</button>
                <button class="btn btn-primary" id="save-task">حفظ المهمة</button>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل مهمة -->
    <div class="modal" id="edit-task-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>تعديل المهمة</h3>
                <button class="close-btn" id="close-edit-task-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-task-form">
                    <div class="form-group">
                        <label for="edit-task-title">عنوان المهمة *</label>
                        <input type="text" id="edit-task-title" placeholder="أدخل عنوان المهمة" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-category">الفئة *</label>
                        <select id="edit-task-category" required>
                            <option value="">-- اختر الفئة --</option>
                            <!-- الفئات ستضاف هنا -->
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-task-date">تاريخ الاستحقاق</label>
                            <input type="date" id="edit-task-date">
                        </div>
                        <div class="form-group">
                            <label for="edit-task-time">الوقت</label>
                            <input type="time" id="edit-task-time">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-task-duration">المدة (دقائق)</label>
                            <input type="number" id="edit-task-duration" min="1" value="30">
                        </div>
                        <div class="form-group">
                            <label for="edit-task-priority">الأولوية</label>
                            <select id="edit-task-priority">
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-description">الوصف</label>
                        <textarea id="edit-task-description" placeholder="أدخل وصف المهمة" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-task">إلغاء</button>
                <button class="btn btn-primary" id="save-edit-task">حفظ التعديلات</button>
                <button class="btn btn-danger" id="delete-edit-task">حذف المهمة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة/تعديل فئة -->
    <div class="modal" id="category-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="category-modal-title">إضافة فئة جديدة</h3>
                <button class="close-btn" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name">اسم الفئة *</label>
                        <input type="text" id="category-name" placeholder="أدخل اسم الفئة" required>
                    </div>
                    <div class="form-group">
                        <label for="category-color">لون الفئة *</label>
                        <input type="color" id="category-color" value="#5a76e8" required>
                    </div>
                    <div class="form-group">
                        <label for="category-timeframe">الحيز الزمني (اختياري)</label>
                        <select id="category-timeframe">
                            <option value="">بدون حيز زمني</option>
                            <option value="daily">يومي</option>
                            <option value="weekly">أسبوعي</option>
                            <option value="monthly">شهري</option>
                            <option value="quarterly">ربع سنوي</option>
                            <option value="yearly">سنوي</option>
                            <option value="custom">مخصص</option>
                        </select>
                    </div>
                    <div id="custom-timeframe-container" style="display: none;">
                        <div class="form-group">
                            <label for="custom-timeframe-days">عدد الأيام (للفترة المخصصة)</label>
                            <input type="number" id="custom-timeframe-days" min="1" value="7" placeholder="عدد الأيام">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="category-message-empty">رسالة الفئة (حالة فارغة) *</label>
                        <textarea id="category-message-empty" rows="2" placeholder="أدخل رسالة الفئة عندما تكون فارغة أو بها مهام غير مكتملة" required>لا توجد مهام في هذه الفئة بعد. أضف مهام جديدة لبدء العمل!</textarea>
                    </div>
                    <div class="form-group">
                        <label for="category-message-completed">رسالة الفئة (حالة الإكمال) *</label>
                        <textarea id="category-message-completed" rows="2" placeholder="أدخل رسالة الفئة عند اكتمال جميع المهام" required>ممتاز! لقد أكملت جميع المهام في هذه الفئة. استمر في العمل الجيد!</textarea>
                    </div>
                    <div class="form-group">
                        <label for="category-message-pending">رسالة الفئة (مهام معلقة) *</label>
                        <textarea id="category-message-pending" rows="2" placeholder="أدخل رسالة الفئة عندما تكون هناك مهام معلقة" required>هناك مهام معلقة في هذه الفئة. واصل العمل لإنجازها!</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-category">إلغاء</button>
                <button class="btn btn-primary" id="save-category">حفظ الفئة</button>
            </div>
        </div>
    </div>

    <!-- محرر الملاحظات المتقدم -->
    <div class="notes-editor-container" id="notes-editor">
        <div class="notes-toolbar">
            <div class="notes-toolbar-left">
                <input type="text" id="notes-editor-title" class="notes-title-input" placeholder="عنوان الملاحظة">
                <div class="font-controls">
                    <select id="notes-font-family" class="font-select">
                        <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">سجوي يو آي</option>
                        <option value="'Cairo', sans-serif">قاهرة</option>
                        <option value="'Tajawal', sans-serif">تاجوال</option>
                        <option value="'Arial', sans-serif">أريال</option>
                        <option value="'Georgia', serif">جورجيا</option>
                    </select>
                    <input type="number" id="notes-font-size" class="font-size-input" min="8" max="72" value="16">
                    <select id="notes-font-weight" class="font-weight-select">
                        <option value="normal">عادي</option>
                        <option value="bold">غامق</option>
                        <option value="300">خفيف</option>
                        <option value="500">متوسط</option>
                        <option value="700">ثقيل</option>
                    </select>
                    <select id="notes-font-style" class="font-style-select">
                        <option value="normal">عادي</option>
                        <option value="italic">مائل</option>
                    </select>
                    <input type="color" id="notes-font-color" class="font-color-input" value="#000000">
                </div>
            </div>
            <div class="notes-toolbar-right">
                <button class="btn btn-warning" id="add-checkbox-btn" title="إضافة خانة اختيار">
                    <i class="fas fa-square-check"></i> خانة اختيار
                </button>
                <button class="btn btn-secondary" id="save-notes-btn">
                    <i class="fas fa-save"></i> حفظ
                </button>
                <button class="btn btn-danger" id="close-notes-btn">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
        
        <div class="formatting-tools">
            <button class="format-btn" data-command="bold" title="عريض">
                <i class="fas fa-bold"></i>
            </button>
            <button class="format-btn" data-command="italic" title="مائل">
                <i class="fas fa-italic"></i>
            </button>
            <button class="format-btn" data-command="underline" title="تحته خط">
                <i class="fas fa-underline"></i>
            </button>
            <div style="width: 1px; height: 24px; background: var(--theme-border); margin: 0 10px;"></div>
            <button class="format-btn" data-command="justifyLeft" title="محاذاة لليسار">
                <i class="fas fa-align-left"></i>
            </button>
            <button class="format-btn" data-command="justifyCenter" title="محاذاة للوسط">
                <i class="fas fa-align-center"></i>
            </button>
            <button class="format-btn" data-command="justifyRight" title="محاذاة لليمين">
                <i class="fas fa-align-right"></i>
            </button>
            <div style="width: 1px; height: 24px; background: var(--theme-border); margin: 0 10px;"></div>
            <button class="format-btn" data-command="insertUnorderedList" title="قائمة غير مرقمة">
                <i class="fas fa-list-ul"></i>
            </button>
            <button class="format-btn" data-command="insertOrderedList" title="قائمة مرقمة">
                <i class="fas fa-list-ol"></i>
            </button>
        </div>
        
        <div contenteditable="true" class="notes-content" id="notes-editor-content" placeholder="اكتب ملاحظاتك هنا..."></div>
    </div>

    <!-- تلميحات محسنة -->
    <div id="global-tooltip" class="tooltip">
        <div class="tooltip-content">
            <div class="tooltip-title" id="tooltip-title"></div>
            <div class="tooltip-info" id="tooltip-info"></div>
        </div>
    </div>

    <!-- إضافة خطوط عربية -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
    // ========== حالة التطبيق ==========
    const AppState = {
        tasks: [],
        categories: [],
        deletedTasks: [],
        notes: [],
        currentView: 'tasks',
        currentFilter: 'pending',
        currentCalendarView: 'daily',
        currentCalendarDate: new Date(),
        currentTaskId: null,
        currentNoteId: null,
        currentCategoryId: null,
        themes: ['gray', 'black', 'blue', 'beige'],
        currentTheme: 'gray',
        showCategoriesStatus: false
    };
    
    // ========== إدارة الثيمات ==========
    function initializeThemes() {
        // تحميل الثيم المحفوظ
        const savedTheme = localStorage.getItem('mytasks_theme');
        if (savedTheme && AppState.themes.includes(savedTheme)) {
            AppState.currentTheme = savedTheme;
            document.body.className = `theme-${savedTheme}`;
        }
        
        // تحديث الأزرار النشطة
        document.querySelectorAll('.theme-option').forEach(option => {
            option.classList.remove('active');
            if (option.dataset.theme === AppState.currentTheme) {
                option.classList.add('active');
            }
        });
        
        // إضافة أحداث تغيير الثيم
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', function() {
                const theme = this.dataset.theme;
                AppState.currentTheme = theme;
                document.body.className = `theme-${theme}`;
                localStorage.setItem('mytasks_theme', theme);
                
                document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                
                // إعادة تحميل البيانات للتأكد من التحديث
                refreshCurrentView();
                
                // إعادة ضبط ألوان النص في الملاحظات
                updateNotesTextColor();
            });
        });
        
        // زر الإعدادات
        document.getElementById('settings-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            const popup = document.getElementById('settings-popup');
            popup.classList.toggle('active');
        });
        
        // إغلاق النافذة عند النقر خارجها
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('settings-popup');
            if (popup && !popup.contains(e.target) && e.target.id !== 'settings-btn') {
                popup.classList.remove('active');
            }
        });
        
        // تعديل ألوان النص في الملاحظات بناءً على الثيم
        updateNotesTextColor();
    }
    
    // تحديث ألوان النص في الملاحظات بناءً على الثيم
    function updateNotesTextColor() {
        // إذا كان الثيم أسود، نجعل لون النص فاتح
        if (AppState.currentTheme === 'black') {
            // تحديث جميع الملاحظات
            AppState.notes.forEach(note => {
                if (!note.color || note.color === '#000000' || note.color === '#212529') {
                    note.color = '#f0f0f0';
                }
            });
            saveNotes();
            
            // تحديث محرر الملاحظات
            const editor = document.getElementById('notes-editor-content');
            if (editor) {
                editor.style.color = '#f0f0f0';
            }
        }
    }
    
    // ========== إدارة البيانات ==========
    function initializeData() {
        console.log("تهيئة البيانات...");
        
        // تحميل المهام
        try {
            const savedTasks = localStorage.getItem('mytasks_tasks');
            AppState.tasks = savedTasks ? JSON.parse(savedTasks) : [];
        } catch (e) {
            console.error("خطأ في تحميل المهام:", e);
            AppState.tasks = [];
        }
        
        // تحميل المهام المحذوفة
        try {
            const savedDeleted = localStorage.getItem('mytasks_deleted');
            AppState.deletedTasks = savedDeleted ? JSON.parse(savedDeleted) : [];
        } catch (e) {
            console.error("خطأ في تحميل المهام المحذوفة:", e);
            AppState.deletedTasks = [];
        }
        
        // تحميل الفئات
        try {
            const savedCategories = localStorage.getItem('mytasks_categories');
            AppState.categories = savedCategories ? JSON.parse(savedCategories) : [];
            
            if (!Array.isArray(AppState.categories) || AppState.categories.length === 0) {
                AppState.categories = [
                    { 
                        id: 'work', 
                        name: 'عمل', 
                        color: '#5a76e8',
                        timeframe: 'daily',
                        messageEmpty: 'لا توجد مهام في فئة العمل اليوم. أضف مهام جديدة لبدء العمل!',
                        messageCompleted: 'ممتاز! لقد أكملت جميع مهام العمل لهذا اليوم. استمر في العمل الجيد!',
                        messagePending: 'هناك مهام عمل معلقة. واصل العمل لإنجازها!',
                        customDays: 0
                    },
                    { 
                        id: 'personal', 
                        name: 'شخصي', 
                        color: '#4cc9f0',
                        timeframe: 'weekly',
                        messageEmpty: 'لا توجد مهام شخصية هذا الأسبوع. يمكنك إضافة مهام جديدة!',
                        messageCompleted: 'رائع! لقد أكملت جميع المهام الشخصية لهذا الأسبوع.',
                        messagePending: 'لا يزال لديك مهام شخصية معلقة. حاول إنجازها قريباً!',
                        customDays: 0
                    },
                    { 
                        id: 'study', 
                        name: 'دراسة', 
                        color: '#f72585',
                        timeframe: 'monthly',
                        messageEmpty: 'لا توجد مهام دراسية لهذا الشهر. خطط لجدولك الدراسي!',
                        messageCompleted: 'تهانينا! لقد أنجزت جميع المهام الدراسية لهذا الشهر.',
                        messagePending: 'هناك مهام دراسية تحتاج للإنجاز. ركز على دراستك!',
                        customDays: 0
                    }
                ];
                saveCategories();
            }
        } catch (e) {
            console.error("خطأ في تحميل الفئات:", e);
            AppState.categories = [
                { 
                    id: 'work', 
                    name: 'عمل', 
                    color: '#5a76e8',
                    timeframe: 'daily',
                    messageEmpty: 'لا توجد مهام في فئة العمل اليوم. أضف مهام جديدة لبدء العمل!',
                    messageCompleted: 'ممتاز! لقد أكملت جميع مهام العمل لهذا اليوم. استمر في العمل الجيد!',
                    messagePending: 'هناك مهام عمل معلقة. واصل العمل لإنجازها!',
                    customDays: 0
                },
                { 
                    id: 'personal', 
                    name: 'شخصي', 
                    color: '#4cc9f0',
                    timeframe: 'weekly',
                    messageEmpty: 'لا توجد مهام شخصية هذا الأسبوع. يمكنك إضافة مهام جديدة!',
                    messageCompleted: 'رائع! لقد أكملت جميع المهام الشخصية لهذا الأسبوع.',
                    messagePending: 'لا يزال لديك مهام شخصية معلقة. حاول إنجازها قريباً!',
                    customDays: 0
                },
                { 
                    id: 'study', 
                    name: 'دراسة', 
                    color: '#f72585',
                    timeframe: 'monthly',
                    messageEmpty: 'لا توجد مهام دراسية لهذا الشهر. خطط لجدولك الدراسي!',
                    messageCompleted: 'تهانينا! لقد أنجزت جميع المهام الدراسية لهذا الشهر.',
                    messagePending: 'هناك مهام دراسية تحتاج للإنجاز. ركز على دراستك!',
                    customDays: 0
                }
            ];
            saveCategories();
        }
        
        // تحميل الملاحظات
        try {
            const savedNotes = localStorage.getItem('mytasks_notes');
            AppState.notes = savedNotes ? JSON.parse(savedNotes) : [];
        } catch (e) {
            console.error("خطأ في تحميل الملاحظات:", e);
            AppState.notes = [];
        }
        
        // بيانات تجريبية إذا لم تكن هناك مهام
        if (AppState.tasks.length === 0) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            AppState.tasks = [
                {
                    id: Date.now().toString(),
                    title: 'مراجعة التقرير الشهري',
                    description: 'مراجعة وإرسال التقرير الشهري للإدارة',
                    categoryId: 'work',
                    duration: 60,
                    date: today,
                    time: '10:00',
                    priority: 'high',
                    completed: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: (Date.now() + 1).toString(),
                    title: 'مقابلة العملاء الجدد',
                    description: 'مقابلة مع العملاء الجدد لمناقشة المشروع',
                    categoryId: 'work',
                    duration: 90,
                    date: today,
                    time: '14:30',
                    priority: 'medium',
                    completed: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: (Date.now() + 2).toString(),
                    title: 'شراء مستلزمات المنزل',
                    description: 'شراء الخضار والفواكه والمنظفات',
                    categoryId: 'personal',
                    duration: 45,
                    date: tomorrowStr,
                    time: '16:00',
                    priority: 'low',
                    completed: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: (Date.now() + 3).toString(),
                    title: 'مهمة متأخرة',
                    description: 'مهمة يجب أن تكون مكتملة بالأمس',
                    categoryId: 'personal',
                    duration: 30,
                    date: yesterdayStr,
                    time: '09:00',
                    priority: 'high',
                    completed: false,
                    createdAt: new Date().toISOString()
                },
                {
                    id: (Date.now() + 4).toString(),
                    title: 'مهمة مكتملة',
                    description: 'مهمة تم إنجازها بالفعل',
                    categoryId: 'study',
                    duration: 60,
                    date: today,
                    time: '16:00',
                    priority: 'low',
                    completed: true,
                    createdAt: new Date().toISOString()
                }
            ];
            saveTasks();
        }
        
        // بيانات تجريبية للملاحظات إذا لم تكن موجودة
        if (AppState.notes.length === 0) {
            AppState.notes = [
                {
                    id: Date.now().toString(),
                    title: 'ملاحظة ترحيبية',
                    content: '<div class="note-checkbox-item"><input type="checkbox" class="note-checkbox"> <span class="note-checkbox-text">مراجعة التقرير الشهري</span></div><div class="note-checkbox-item"><input type="checkbox" class="note-checkbox"> <span class="note-checkbox-text">مقابلة العملاء الجدد</span></div><div class="note-checkbox-item"><input type="checkbox" class="note-checkbox"> <span class="note-checkbox-text">شراء مستلزمات المنزل</span></div>',
                    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                    fontSize: '16',
                    fontWeight: 'normal',
                    fontStyle: 'normal',
                    color: AppState.currentTheme === 'black' ? '#f0f0f0' : '#000000',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },
                {
                    id: (Date.now() + 1).toString(),
                    title: 'قائمة مهام مهمة',
                    content: '<ul><li>شراء مستلزمات المنزل</li><li>مراجعة التقارير الشهرية</li><li>مكالمة مع العميل الجديد</li></ul>',
                    fontFamily: "'Cairo', sans-serif",
                    fontSize: '18',
                    fontWeight: '500',
                    fontStyle: 'normal',
                    color: AppState.currentTheme === 'black' ? '#f0f0f0' : '#333333',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];
            saveNotes();
        }
    }
    
    function saveTasks() {
        try {
            localStorage.setItem('mytasks_tasks', JSON.stringify(AppState.tasks));
        } catch (e) {
            console.error("خطأ في حفظ المهام:", e);
        }
    }
    
    function saveDeletedTasks() {
        try {
            localStorage.setItem('mytasks_deleted', JSON.stringify(AppState.deletedTasks));
        } catch (e) {
            console.error("خطأ في حفظ المهام المحذوفة:", e);
        }
    }
    
    function saveCategories() {
        try {
            localStorage.setItem('mytasks_categories', JSON.stringify(AppState.categories));
        } catch (e) {
            console.error("خطأ في حفظ الفئات:", e);
        }
    }
    
    function saveNotes() {
        try {
            localStorage.setItem('mytasks_notes', JSON.stringify(AppState.notes));
        } catch (e) {
            console.error("خطأ في حفظ الملاحظات:", e);
        }
    }
    
    // ========== وظائف المساعدة ==========
    function getCategoryById(categoryId) {
        return AppState.categories.find(cat => cat.id === categoryId) || 
               { name: 'عام', color: '#6c757d', timeframe: '', messageEmpty: '', messageCompleted: '', messagePending: '', customDays: 0 };
    }
    
    function isTaskOverdue(task) {
        if (!task.date || task.completed) return false;
        const today = new Date().toISOString().split('T')[0];
        return task.date < today;
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return 'بدون تاريخ';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ar-SA');
    }
    
    function formatTime(timeStr) {
        if (!timeStr) return 'بدون وقت';
        return timeStr;
    }
    
    function getTaskTimeInMinutes(task) {
        if (!task.time) return 0;
        const [hours, minutes] = task.time.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    function refreshCurrentView() {
        if (AppState.currentView === 'tasks') renderTasks();
        else if (AppState.currentView === 'calendar') renderCalendar();
        else if (AppState.currentView === 'categories') renderCategories();
        else if (AppState.currentView === 'categories-status') renderCategoriesStatus();
        else if (AppState.currentView === 'notes') renderNotes();
    }
    
    // توليد معرف فريد
    function generateId() {
        return Date.now().toString() + Math.random().toString(36).substr(2, 9);
    }
    
    // ========== إدارة المهام ==========
    function addTask(taskData) {
        console.log("إضافة مهمة:", taskData);
        const newTask = {
            id: generateId(),
            title: taskData.title,
            description: taskData.description || '',
            categoryId: taskData.categoryId,
            duration: parseInt(taskData.duration) || 30,
            date: taskData.date || new Date().toISOString().split('T')[0],
            time: taskData.time || '',
            priority: taskData.priority || 'medium',
            completed: false,
            createdAt: new Date().toISOString()
        };
        
        AppState.tasks.push(newTask);
        saveTasks();
        refreshCurrentView();
        
        closeModal('add-task-modal');
        document.getElementById('task-form').reset();
    }
    
    function updateTask(taskId, taskData) {
        const taskIndex = AppState.tasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) return;
        
        AppState.tasks[taskIndex] = {
            ...AppState.tasks[taskIndex],
            title: taskData.title,
            description: taskData.description || '',
            categoryId: taskData.categoryId,
            duration: parseInt(taskData.duration) || 30,
            date: taskData.date || new Date().toISOString().split('T')[0],
            time: taskData.time || '',
            priority: taskData.priority || 'medium',
            updatedAt: new Date().toISOString()
        };
        
        saveTasks();
        refreshCurrentView();
        
        closeModal('edit-task-modal');
    }
    
    function deleteTask(taskId) {
        const taskIndex = AppState.tasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) {
            const deletedIndex = AppState.deletedTasks.findIndex(task => task.id === taskId);
            if (deletedIndex !== -1) {
                if (confirm('هذه المهمة محذوفة بالفعل. هل تريد حذفها نهائياً؟')) {
                    AppState.deletedTasks.splice(deletedIndex, 1);
                    saveDeletedTasks();
                    renderTasks();
                }
            } else {
                alert('هذه المهمة غير موجودة.');
            }
            return;
        }
        
        const task = AppState.tasks[taskIndex];
        if (!confirm(`هل أنت متأكد من حذف المهمة: "${task.title}"؟`)) return;
        
        AppState.deletedTasks.push({
            ...task,
            deletedAt: new Date().toISOString()
        });
        
        AppState.tasks.splice(taskIndex, 1);
        
        saveTasks();
        saveDeletedTasks();
        
        refreshCurrentView();
    }
    
    function toggleTaskCompletion(taskId) {
        const task = AppState.tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            saveTasks();
            refreshCurrentView();
        }
    }
    
    function restoreTask(taskId) {
        const taskIndex = AppState.deletedTasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) return;
        
        const task = AppState.deletedTasks[taskIndex];
        AppState.tasks.push(task);
        AppState.deletedTasks.splice(taskIndex, 1);
        
        saveTasks();
        saveDeletedTasks();
        renderTasks();
    }
    
    function openEditTaskModal(taskId) {
        const task = AppState.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        AppState.currentTaskId = taskId;
        
        document.getElementById('edit-task-title').value = task.title;
        document.getElementById('edit-task-description').value = task.description || '';
        document.getElementById('edit-task-date').value = task.date || '';
        document.getElementById('edit-task-time').value = task.time || '';
        document.getElementById('edit-task-duration').value = task.duration || 30;
        document.getElementById('edit-task-priority').value = task.priority || 'medium';
        
        const categorySelect = document.getElementById('edit-task-category');
        categorySelect.innerHTML = '<option value="">-- اختر الفئة --</option>';
        
        AppState.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (task.categoryId === category.id) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
        
        document.getElementById('edit-task-modal').classList.add('active');
    }
    
    // ========== عرض المهام ==========
    function renderTasks() {
        const container = document.getElementById('tasks-list');
        
        let tasksToShow = [];
        
        switch(AppState.currentFilter) {
            case 'pending':
                tasksToShow = AppState.tasks.filter(task => !task.completed);
                break;
            case 'completed':
                tasksToShow = AppState.tasks.filter(task => task.completed);
                break;
            case 'deleted':
                tasksToShow = AppState.deletedTasks;
                break;
            case 'overdue':
                tasksToShow = AppState.tasks.filter(task => isTaskOverdue(task));
                break;
            case 'all':
                tasksToShow = AppState.tasks;
                break;
        }
        
        // ترتيب المهام
        tasksToShow.sort((a, b) => {
            const aOverdue = isTaskOverdue(a);
            const bOverdue = isTaskOverdue(b);
            if (aOverdue && !bOverdue) return -1;
            if (!aOverdue && bOverdue) return 1;
            
            if (a.completed && !b.completed) return 1;
            if (!a.completed && b.completed) return -1;
            
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            }
            
            const dateA = a.date ? new Date(a.date) : new Date(0);
            const dateB = b.date ? new Date(b.date) : new Date(0);
            if (dateA < dateB) return -1;
            if (dateA > dateB) return 1;
            
            return 0;
        });
        
        if (tasksToShow.length === 0) {
            let message = 'لا توجد مهام';
            if (AppState.currentFilter === 'pending') message = 'لا توجد مهام نشطة';
            else if (AppState.currentFilter === 'completed') message = 'لا توجد مهام مكتملة';
            else if (AppState.currentFilter === 'deleted') message = 'لا توجد مهام محذوفة';
            else if (AppState.currentFilter === 'overdue') message = 'لا توجد مهام متأخرة';
            
            container.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--theme-text-light);">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                    <h3 style="color: var(--theme-text); margin-bottom: 10px;">${message}</h3>
                    ${AppState.currentFilter === 'pending' ? '<p>اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى</p>' : ''}
                </div>
            `;
            return;
        }
        
        let html = '';
        
        tasksToShow.forEach(task => {
            const category = getCategoryById(task.categoryId);
            const isDeleted = AppState.currentFilter === 'deleted';
            const isOverdue = isTaskOverdue(task);
            
            if (isDeleted) {
                html += `
                    <div class="task-card deleted" data-id="${task.id}">
                        <div class="task-content">
                            <div class="task-title" style="color: #999; text-decoration: line-through;">${task.title}</div>
                            ${task.description ? `<div class="task-description" style="color: #aaa;">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <i class="fas fa-tag" style="color: ${category.color}"></i>
                                    <span>${category.name}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${formatDate(task.date)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-success btn-sm restore-task-btn" data-id="${task.id}" title="استعادة">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-danger btn-sm permanent-delete-btn" data-id="${task.id}" title="حذف نهائي">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="task-card ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" 
                         data-id="${task.id}"
                         onmouseover="showEnhancedTooltip(event, '${task.id}')"
                         onmouseout="hideTooltip()">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <i class="fas fa-tag" style="color: ${category.color}"></i>
                                    <span>${category.name}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${formatDate(task.date)}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${task.duration} دقيقة</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-flag" style="color: ${
                                        task.priority === 'high' ? '#f72585' : 
                                        task.priority === 'medium' ? '#f8961e' : '#4cc9f0'
                                    }"></i>
                                    <span>${task.priority === 'high' ? 'عالية' : task.priority === 'medium' ? 'متوسطة' : 'منخفضة'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-secondary btn-sm edit-task-btn" data-id="${task.id}" title="تعديل المهمة">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-task-btn" data-id="${task.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        
        // إضافة الأحداث
        if (AppState.currentFilter === 'deleted') {
            document.querySelectorAll('.restore-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    restoreTask(taskId);
                });
            });
            
            document.querySelectorAll('.permanent-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    if (confirm('هل أنت متأكد من الحذف النهائي؟ لا يمكن استعادة المهمة بعد ذلك.')) {
                        const index = AppState.deletedTasks.findIndex(t => t.id === taskId);
                        if (index !== -1) {
                            AppState.deletedTasks.splice(index, 1);
                            saveDeletedTasks();
                            renderTasks();
                        }
                    }
                });
            });
        } else {
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = e.target.closest('.task-card').dataset.id;
                    toggleTaskCompletion(taskId);
                });
            });
            
            document.querySelectorAll('.delete-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    deleteTask(taskId);
                });
            });
            
            document.querySelectorAll('.edit-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    openEditTaskModal(taskId);
                });
            });
        }
    }
    
    // ========== عرض حالة الفئات ==========
    function renderCategoriesStatus() {
        const container = document.getElementById('categories-status-list');
        
        if (AppState.categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--theme-text-light); grid-column: 1 / -1;">
                    <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                    <h3 style="color: var(--theme-text); margin-bottom: 10px;">لا توجد فئات</h3>
                    <p>اضغط على "فئة جديدة" في عرض الفئات لإنشاء فئتك الأولى</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        AppState.categories.forEach(category => {
            const categoryTasks = AppState.tasks.filter(task => task.categoryId === category.id);
            const completedTasks = categoryTasks.filter(task => task.completed).length;
            const totalTasks = categoryTasks.length;
            
            // تحديد حالة الفئة
            let statusMessage = '';
            let statusClass = '';
            
            if (totalTasks === 0) {
                statusMessage = category.messageEmpty || 'لا توجد مهام في هذه الفئة بعد.';
                statusClass = 'empty';
            } else if (completedTasks === totalTasks && totalTasks > 0) {
                statusMessage = category.messageCompleted || 'ممتاز! لقد أكملت جميع المهام في هذه الفئة.';
                statusClass = 'completed';
            } else {
                statusMessage = category.messagePending || `هناك ${totalTasks - completedTasks} مهام معلقة في هذه الفئة.`;
                statusClass = 'pending';
            }
            
            // تحديد نص الحيز الزمني
            let timeframeText = '';
            switch(category.timeframe) {
                case 'daily':
                    timeframeText = 'يومي';
                    break;
                case 'weekly':
                    timeframeText = 'أسبوعي';
                    break;
                case 'monthly':
                    timeframeText = 'شهري';
                    break;
                case 'quarterly':
                    timeframeText = 'ربع سنوي';
                    break;
                case 'yearly':
                    timeframeText = 'سنوي';
                    break;
                case 'custom':
                    timeframeText = `${category.customDays || 7} يوم`;
                    break;
                default:
                    timeframeText = 'بدون حيز زمني';
            }
            
            html += `
                <div class="category-status-card ${statusClass}">
                    <div class="category-status-header">
                        <div class="category-status-color" style="background: ${category.color}"></div>
                        <div class="category-status-name">${category.name}</div>
                        <div class="category-status-timeframe">${timeframeText}</div>
                    </div>
                    
                    <div class="category-status-message">
                        ${statusMessage}
                    </div>
                    
                    <div class="category-status-info">
                        <span>المهام: ${completedTasks}/${totalTasks}</span>
                        <span>الإنجاز: ${totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0}%</span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // ========== إدارة الفئات ==========
    function renderCategories() {
        const container = document.getElementById('categories-list');
        
        if (AppState.categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--theme-text-light);">
                    <i class="fas fa-tags" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                    <h3 style="color: var(--theme-text); margin-bottom: 10px;">لا توجد فئات</h3>
                    <p>اضغط على "فئة جديدة" لإنشاء فئتك الأولى</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        AppState.categories.forEach(category => {
            const categoryTasks = AppState.tasks.filter(task => task.categoryId === category.id);
            const completedTasks = categoryTasks.filter(task => task.completed).length;
            const totalTasks = categoryTasks.length;
            
            let totalDuration = 0;
            let completedDuration = 0;
            categoryTasks.forEach(task => {
                totalDuration += task.duration || 30;
                if (task.completed) {
                    completedDuration += task.duration || 30;
                }
            });
            
            const progressPercent = totalDuration > 0 ? Math.round((completedDuration / totalDuration) * 100) : 0;
            
            // تحديد نص الحيز الزمني
            let timeframeText = '';
            switch(category.timeframe) {
                case 'daily':
                    timeframeText = 'يومي';
                    break;
                case 'weekly':
                    timeframeText = 'أسبوعي';
                    break;
                case 'monthly':
                    timeframeText = 'شهري';
                    break;
                case 'quarterly':
                    timeframeText = 'ربع سنوي';
                    break;
                case 'yearly':
                    timeframeText = 'سنوي';
                    break;
                case 'custom':
                    timeframeText = `${category.customDays || 7} يوم`;
                    break;
                default:
                    timeframeText = 'بدون حيز زمني';
            }
            
            html += `
                <div class="category-card" data-id="${category.id}">
                    <div class="category-header">
                        <div class="category-color" style="background: ${category.color}" 
                             onclick="event.stopPropagation(); openEditCategoryModal('${category.id}')"
                             title="تعديل لون الفئة"></div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-stats">${totalTasks} مهام</div>
                        <div class="category-actions">
                            <button class="btn btn-warning btn-xs edit-category-btn" data-id="${category.id}" title="تعديل الفئة">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-xs delete-category-btn" data-id="${category.id}" title="حذف الفئة">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="category-timeframe">الحيز الزمني: ${timeframeText}</div>
                    
                    <div class="category-progress-info">
                        <span>الإنجاز: ${progressPercent}%</span>
                        <span>مكتملة: ${completedTasks}/${totalTasks}</span>
                    </div>
                    
                    <div class="category-progress-container">
                        <div class="category-progress-bar ${completedDuration === totalDuration && totalTasks > 0 ? 'completed' : completedDuration === 0 ? 'empty' : ''}" 
                             style="width: ${progressPercent}%; background: ${completedDuration === totalDuration && totalTasks > 0 ? 'var(--success-color)' : category.color};">
                        </div>
                    </div>
                    
                    <div class="category-tasks-container">
            `;
            
            if (categoryTasks.length === 0) {
                html += `
                    <div style="text-align: center; padding: 20px; color: var(--theme-text-light);">
                        <i class="fas fa-tasks" style="opacity: 0.3;"></i>
                        <p>لا توجد مهام في هذه الفئة</p>
                    </div>
                `;
            } else {
                categoryTasks.forEach(task => {
                    const isOverdue = isTaskOverdue(task);
                    
                    html += `
                        <div class="category-task-item ${task.completed ? 'completed' : ''}" 
                             data-id="${task.id}"
                             onclick="openEditTaskModal('${task.id}')"
                             onmouseover="showEnhancedTooltip(event, '${task.id}')"
                             onmouseout="hideTooltip()">
                            <div class="category-task-title">
                                <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleTaskCompletion('${task.id}')">
                                ${task.title}
                            </div>
                            <div class="category-task-meta">
                                <span><i class="fas fa-calendar"></i> ${formatDate(task.date)}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration} دقيقة</span>
                                ${isOverdue ? '<span style="color: #f72585;"><i class="fas fa-exclamation-circle"></i> متأخرة</span>' : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                    
                    <button class="btn btn-secondary category-add-task-btn" data-category-id="${category.id}">
                        <i class="fas fa-plus"></i> إضافة مهمة جديدة
                    </button>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // إضافة الأحداث
        document.querySelectorAll('.category-add-task-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const categoryId = e.target.closest('button').dataset.categoryId;
                openAddTaskModal(categoryId);
            });
        });
        
        document.querySelectorAll('.edit-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const categoryId = e.target.closest('button').dataset.id;
                openEditCategoryModal(categoryId);
            });
        });
        
        document.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const categoryId = e.target.closest('button').dataset.id;
                deleteCategory(categoryId);
            });
        });
    }
    
    function openAddCategoryModal() {
        AppState.currentCategoryId = null;
        document.getElementById('category-modal-title').textContent = 'إضافة فئة جديدة';
        document.getElementById('category-name').value = '';
        document.getElementById('category-color').value = '#5a76e8';
        document.getElementById('category-timeframe').value = '';
        document.getElementById('custom-timeframe-days').value = '7';
        document.getElementById('custom-timeframe-container').style.display = 'none';
        document.getElementById('category-message-empty').value = 'لا توجد مهام في هذه الفئة بعد. أضف مهام جديدة لبدء العمل!';
        document.getElementById('category-message-completed').value = 'ممتاز! لقد أكملت جميع المهام في هذه الفئة. استمر في العمل الجيد!';
        document.getElementById('category-message-pending').value = 'هناك مهام معلقة في هذه الفئة. واصل العمل لإنجازها!';
        document.getElementById('category-modal').classList.add('active');
    }
    
    function openEditCategoryModal(categoryId) {
        const category = AppState.categories.find(c => c.id === categoryId);
        if (!category) return;
        
        AppState.currentCategoryId = categoryId;
        document.getElementById('category-modal-title').textContent = 'تعديل الفئة';
        document.getElementById('category-name').value = category.name;
        document.getElementById('category-color').value = category.color;
        document.getElementById('category-timeframe').value = category.timeframe || '';
        document.getElementById('custom-timeframe-days').value = category.customDays || '7';
        
        if (category.timeframe === 'custom') {
            document.getElementById('custom-timeframe-container').style.display = 'block';
        } else {
            document.getElementById('custom-timeframe-container').style.display = 'none';
        }
        
        document.getElementById('category-message-empty').value = category.messageEmpty || 'لا توجد مهام في هذه الفئة بعد. أضف مهام جديدة لبدء العمل!';
        document.getElementById('category-message-completed').value = category.messageCompleted || 'ممتاز! لقد أكملت جميع المهام في هذه الفئة. استمر في العمل الجيد!';
        document.getElementById('category-message-pending').value = category.messagePending || 'هناك مهام معلقة في هذه الفئة. واصل العمل لإنجازها!';
        
        document.getElementById('category-modal').classList.add('active');
    }
    
    function saveCategory() {
        const name = document.getElementById('category-name').value.trim();
        const color = document.getElementById('category-color').value;
        const timeframe = document.getElementById('category-timeframe').value;
        const customDays = document.getElementById('custom-timeframe-days').value;
        const messageEmpty = document.getElementById('category-message-empty').value.trim();
        const messageCompleted = document.getElementById('category-message-completed').value.trim();
        const messagePending = document.getElementById('category-message-pending').value.trim();
        
        if (!name) {
            alert('يرجى إدخال اسم الفئة');
            return;
        }
        
        if (!messageEmpty || !messageCompleted || !messagePending) {
            alert('يرجى إدخال جميع رسائل الفئة');
            return;
        }
        
        if (AppState.currentCategoryId) {
            // تعديل فئة موجودة
            const categoryIndex = AppState.categories.findIndex(c => c.id === AppState.currentCategoryId);
            if (categoryIndex !== -1) {
                AppState.categories[categoryIndex] = {
                    ...AppState.categories[categoryIndex],
                    name: name,
                    color: color,
                    timeframe: timeframe,
                    customDays: timeframe === 'custom' ? parseInt(customDays) : 0,
                    messageEmpty: messageEmpty,
                    messageCompleted: messageCompleted,
                    messagePending: messagePending
                };
                saveCategories();
                renderCategories();
                if (AppState.currentView === 'categories-status') {
                    renderCategoriesStatus();
                }
            }
        } else {
            // إضافة فئة جديدة
            const newCategory = {
                id: generateId(),
                name: name,
                color: color,
                timeframe: timeframe,
                customDays: timeframe === 'custom' ? parseInt(customDays) : 0,
                messageEmpty: messageEmpty,
                messageCompleted: messageCompleted,
                messagePending: messagePending
            };
            
            AppState.categories.push(newCategory);
            saveCategories();
            renderCategories();
        }
        
        closeModal('category-modal');
    }
    
    function deleteCategory(categoryId) {
        const category = AppState.categories.find(c => c.id === categoryId);
        if (!category) return;
        
        // التحقق من وجود مهام مرتبطة بالفئة
        const categoryTasks = AppState.tasks.filter(task => task.categoryId === categoryId);
        if (categoryTasks.length > 0) {
            if (!confirm(`هذه الفئة تحتوي على ${categoryTasks.length} مهام. هل تريد حذف الفئة مع جميع المهام المرتبطة بها؟`)) {
                return;
            }
            
            // حذف جميع المهام المرتبطة بالفئة
            AppState.tasks = AppState.tasks.filter(task => task.categoryId !== categoryId);
            saveTasks();
        } else {
            if (!confirm(`هل أنت متأكد من حذف الفئة: "${category.name}"؟`)) {
                return;
            }
        }
        
        AppState.categories = AppState.categories.filter(c => c.id !== categoryId);
        saveCategories();
        renderCategories();
        
        if (AppState.currentView === 'categories-status') {
            renderCategoriesStatus();
        }
    }
    
    // ========== التلميحات المحسنة ==========
    function showEnhancedTooltip(event, taskId) {
        const task = AppState.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        const category = getCategoryById(task.categoryId);
        const tooltip = document.getElementById('global-tooltip');
        const tooltipTitle = document.getElementById('tooltip-title');
        const tooltipInfo = document.getElementById('tooltip-info');
        
        tooltipTitle.textContent = task.title;
        
        let infoHtml = '';
        
        if (task.description) {
            infoHtml += `
                <div class="tooltip-label">الوصف:</div>
                <div class="tooltip-value">${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</div>
            `;
        }
        
        infoHtml += `
            <div class="tooltip-label">الفئة:</div>
            <div class="tooltip-value">${category.name}</div>
            <div class="tooltip-label">التاريخ:</div>
            <div class="tooltip-value">${formatDate(task.date)}</div>
            <div class="tooltip-label">الوقت:</div>
            <div class="tooltip-value">${task.time || 'بدون وقت'}</div>
            <div class="tooltip-label">المدة:</div>
            <div class="tooltip-value">${task.duration} دقيقة</div>
            <div class="tooltip-label">الأولوية:</div>
            <div class="tooltip-value">${task.priority === 'high' ? 'عالية' : task.priority === 'medium' ? 'متوسطة' : 'منخفضة'}</div>
            <div class="tooltip-label">الحالة:</div>
            <div class="tooltip-value">${task.completed ? 'مكتملة' : isTaskOverdue(task) ? 'متأخرة' : 'نشطة'}</div>
        `;
        
        tooltipInfo.innerHTML = infoHtml;
        
        // حساب موضع التلميحة
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const tooltipWidth = 320;
        const tooltipHeight = 250;
        
        let left = event.clientX + 15;
        let top = event.clientY + 15;
        
        // التأكد من بقاء التلميحة داخل الشاشة
        if (left + tooltipWidth > viewportWidth) {
            left = event.clientX - tooltipWidth - 15;
        }
        
        if (top + tooltipHeight > viewportHeight) {
            top = event.clientY - tooltipHeight - 15;
        }
        
        // الحد الأدنى للموضع
        left = Math.max(10, left);
        top = Math.max(10, top);
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        tooltip.style.display = 'block';
    }
    
    function hideTooltip() {
        const tooltip = document.getElementById('global-tooltip');
        tooltip.style.display = 'none';
    }
    
    // ========== إدارة العروض ==========
    function switchView(viewName) {
        AppState.currentView = viewName;
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.view === viewName) {
                item.classList.add('active');
            }
        });
        
        const titles = {
            tasks: 'المهام',
            calendar: 'الجدول الزمني',
            categories: 'الفئات',
            'categories-status': 'حالة الفئات',
            notes: 'الملاحظات'
        };
        document.getElementById('page-title').textContent = titles[viewName] || viewName;
        
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.getElementById(`${viewName}-view`).classList.add('active');
        
        refreshCurrentView();
    }
    
    // ========== تهيئة الصفحة ==========
    function initializePage() {
        console.log("تهيئة الصفحة...");
        
        // تحديث التاريخ
        const now = new Date();
        const arabicDate = now.toLocaleDateString('ar-SA', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-date').textContent = arabicDate;
        
        // تحميل البيانات
        initializeData();
        initializeThemes();
        
        // إعداد أحداث الحيز الزمني
        const timeframeSelect = document.getElementById('category-timeframe');
        if (timeframeSelect) {
            timeframeSelect.addEventListener('change', function() {
                const customContainer = document.getElementById('custom-timeframe-container');
                if (this.value === 'custom') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                }
            });
        }
        
        // زر تحديث حالة الفئات
        const refreshStatusBtn = document.getElementById('refresh-status-btn');
        if (refreshStatusBtn) {
            refreshStatusBtn.addEventListener('click', () => {
                renderCategoriesStatus();
            });
        }
        
        // إعداد محرر الملاحظات
        setupNotesEditorEvents();
        
        // ========== أحداث التنقل ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                switchView(this.dataset.view);
            });
        });
        
        // ========== أحداث المرشحات ==========
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setFilter(this.dataset.filter);
            });
        });
        
        // ========== أحداث الجدول الزمني ==========
        document.querySelectorAll('.calendar-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                AppState.currentCalendarView = this.dataset.range;
                renderCalendar();
            });
        });
        
        // ========== زر إضافة مهمة ==========
        document.getElementById('add-task-btn').addEventListener('click', () => {
            openAddTaskModal();
        });
        
        // ========== زر إضافة فئة ==========
        document.getElementById('add-category-btn').addEventListener('click', () => {
            openAddCategoryModal();
        });
        
        // ========== زر إضافة ملاحظة ==========
        document.getElementById('add-note-btn').addEventListener('click', () => {
            addNote();
        });
        
        // ========== نافذة إضافة مهمة ==========
        const closeTaskModalBtn = document.getElementById('close-task-modal');
        const cancelTaskBtn = document.getElementById('cancel-task');
        
        if (closeTaskModalBtn) {
            closeTaskModalBtn.addEventListener('click', () => {
                closeModal('add-task-modal');
            });
        }
        
        if (cancelTaskBtn) {
            cancelTaskBtn.addEventListener('click', () => {
                closeModal('add-task-modal');
            });
        }
        
        const saveTaskBtn = document.getElementById('save-task');
        if (saveTaskBtn) {
            saveTaskBtn.addEventListener('click', () => {
                const titleInput = document.getElementById('task-title');
                const categorySelect = document.getElementById('task-category');
                
                if (!titleInput || !categorySelect) return;
                
                const title = titleInput.value.trim();
                const category = categorySelect.value;
                
                if (!title) {
                    alert('يرجى إدخال عنوان المهمة');
                    return;
                }
                
                if (!category) {
                    alert('يرجى اختيار فئة للمهمة');
                    return;
                }
                
                const durationInput = document.getElementById('task-duration');
                const dateInput = document.getElementById('task-date');
                const timeInput = document.getElementById('task-time');
                const prioritySelect = document.getElementById('task-priority');
                const descriptionTextarea = document.getElementById('task-description');
                
                addTask({
                    title: title,
                    description: descriptionTextarea ? descriptionTextarea.value.trim() : '',
                    categoryId: category,
                    duration: durationInput ? durationInput.value : 30,
                    date: dateInput ? dateInput.value : new Date().toISOString().split('T')[0],
                    time: timeInput ? timeInput.value : '',
                    priority: prioritySelect ? prioritySelect.value : 'medium'
                });
            });
        }
        
        // ========== نافذة تعديل مهمة ==========
        const closeEditTaskModalBtn = document.getElementById('close-edit-task-modal');
        const cancelEditTaskBtn = document.getElementById('cancel-edit-task');
        
        if (closeEditTaskModalBtn) {
            closeEditTaskModalBtn.addEventListener('click', () => {
                closeModal('edit-task-modal');
            });
        }
        
        if (cancelEditTaskBtn) {
            cancelEditTaskBtn.addEventListener('click', () => {
                closeModal('edit-task-modal');
            });
        }
        
        const deleteEditTaskBtn = document.getElementById('delete-edit-task');
        if (deleteEditTaskBtn) {
            deleteEditTaskBtn.addEventListener('click', () => {
                if (AppState.currentTaskId) {
                    deleteTask(AppState.currentTaskId);
                    closeModal('edit-task-modal');
                }
            });
        }
        
        const saveEditTaskBtn = document.getElementById('save-edit-task');
        if (saveEditTaskBtn) {
            saveEditTaskBtn.addEventListener('click', () => {
                if (!AppState.currentTaskId) return;
                
                const titleInput = document.getElementById('edit-task-title');
                const categorySelect = document.getElementById('edit-task-category');
                
                if (!titleInput || !categorySelect) return;
                
                const title = titleInput.value.trim();
                const category = categorySelect.value;
                
                if (!title) {
                    alert('يرجى إدخال عنوان المهمة');
                    return;
                }
                
                if (!category) {
                    alert('يرجى اختيار فئة للمهمة');
                    return;
                }
                
                const durationInput = document.getElementById('edit-task-duration');
                const dateInput = document.getElementById('edit-task-date');
                const timeInput = document.getElementById('edit-task-time');
                const prioritySelect = document.getElementById('edit-task-priority');
                const descriptionTextarea = document.getElementById('edit-task-description');
                
                updateTask(AppState.currentTaskId, {
                    title: title,
                    description: descriptionTextarea ? descriptionTextarea.value.trim() : '',
                    categoryId: category,
                    duration: durationInput ? durationInput.value : 30,
                    date: dateInput ? dateInput.value : new Date().toISOString().split('T')[0],
                    time: timeInput ? timeInput.value : '',
                    priority: prioritySelect ? prioritySelect.value : 'medium'
                });
            });
        }
        
        // ========== نافذة الفئة ==========
        const closeCategoryModalBtn = document.getElementById('close-category-modal');
        const cancelCategoryBtn = document.getElementById('cancel-category');
        
        if (closeCategoryModalBtn) {
            closeCategoryModalBtn.addEventListener('click', () => {
                closeModal('category-modal');
            });
        }
        
        if (cancelCategoryBtn) {
            cancelCategoryBtn.addEventListener('click', () => {
                closeModal('category-modal');
            });
        }
        
        const saveCategoryBtn = document.getElementById('save-category');
        if (saveCategoryBtn) {
            saveCategoryBtn.addEventListener('click', saveCategory);
        }
        
        // ========== إغلاق النوافذ عند النقر خارجها ==========
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });
        
        // ========== تحميل العرض الأولي ==========
        renderTasks();
        console.log("✅ التطبيق جاهز للاستخدام!");
    }
    
    function openAddTaskModal(preselectedCategory = null) {
        const categorySelect = document.getElementById('task-category');
        categorySelect.innerHTML = '<option value="">-- اختر الفئة --</option>';
        
        AppState.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (preselectedCategory === category.id) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
        
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('task-date');
        if (dateInput) {
            dateInput.value = today;
        }
        
        document.getElementById('add-task-modal').classList.add('active');
        
        const titleInput = document.getElementById('task-title');
        if (titleInput) {
            setTimeout(() => {
                titleInput.focus();
            }, 100);
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
        }
    }
    
    // جعل الوظائف متاحة عالمياً
    window.openEditTaskModal = openEditTaskModal;
    window.openAddTaskModal = openAddTaskModal;
    window.openEditCategoryModal = openEditCategoryModal;
    window.showEnhancedTooltip = showEnhancedTooltip;
    window.hideTooltip = hideTooltip;
    window.toggleTaskCompletion = toggleTaskCompletion;
    
    // بدء التطبيق عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
