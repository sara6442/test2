<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهامي - نظام إدارة المهام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        --primary: #4361ee; --secondary: #3a0ca3; --accent: #7209b7;
        --success: #4cc9f0; --danger: #f72585; --light: #f8f9fa;
        --dark: #212529; --gray: #6c757d;
    }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fb; min-height: 100vh; }
    .container { display: flex; min-height: 100vh; direction: rtl; }
    
    /* الشريط الجانبي */
    .sidebar { width: 250px; background: linear-gradient(180deg, var(--primary), var(--secondary)); color: white; padding: 20px 0; }
    .logo { padding: 0 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .logo h1 { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; }
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 8px; margin: 0 15px 5px; transition: 0.3s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: rgba(255,255,255,0.2); color: white; font-weight: bold; }
    .nav-item i { width: 24px; text-align: center; }
    
    /* المحتوى الرئيسي */
    .main-content { flex: 1; margin-right: 250px; padding: 20px; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-left h2 { color: var(--primary); margin-bottom: 5px; }
    .date-display { color: var(--gray); font-size: 0.9rem; }
    
    /* أزرار */
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.3s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--secondary); transform: translateY(-2px); }
    .btn-secondary { background: var(--light); color: var(--dark); border: 1px solid #dee2e6; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: #f8961e; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.9rem; }
    
    /* شريط الوقت */
    .time-navigation { display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .time-btn { flex: 1; padding: 10px; border: 2px solid #e9ecef; background: white; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .time-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .time-btn:hover { border-color: var(--primary); }
    
    /* المحتوى */
    .content-area { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .view { display: none; }
    .active-view { display: block; }
    
    /* المهام */
    .tasks-list { display: flex; flex-direction: column; gap: 10px; }
    .task-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--light); border-radius: 8px; border-right: 4px solid var(--primary); transition: 0.3s; }
    .task-item:hover { transform: translateX(-5px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .task-item.completed { opacity: 0.7; border-color: var(--success); }
    .task-item.completed .task-title { text-decoration: line-through; }
    .task-checkbox { width: 20px; height: 20px; cursor: pointer; }
    .task-content { flex: 1; }
    .task-title { font-weight: bold; margin-bottom: 5px; }
    .task-description { color: var(--gray); font-size: 0.9rem; margin-bottom: 10px; }
    .task-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--gray); }
    .task-actions { display: flex; gap: 10px; }
    
    /* الفئات */
    .category-card { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        padding: 15px; 
        background: #f8f9fa; 
        border-radius: 8px; 
        margin-bottom: 15px;
        border-right: 4px solid;
    }
    .category-info { flex: 1; }
    .category-name { font-weight: bold; margin-bottom: 5px; }
    .category-stats { font-size: 0.85rem; color: #6c757d; }
    .category-actions { display: flex; gap: 5px; }
    
    /* شريط التقدم */
    .progress-container { 
        width: 100%; 
        height: 8px; 
        background: #e9ecef; 
        border-radius: 4px; 
        overflow: hidden; 
        margin: 10px 0;
    }
    .progress-bar { 
        height: 100%; 
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    /* النوافذ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #dee2e6; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 20px; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 10px; }
    
    /* النماذج */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }
    
    /* الإحصائيات */
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
        gap: 20px; 
        margin-top: 20px;
    }
    .stat-card { 
        background: #f8f9fa; 
        padding: 20px; 
        border-radius: 10px; 
        text-align: center;
        border-top: 4px solid;
    }
    
    /* الحالة الفارغة */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
    .empty-state i { margin-bottom: 20px; opacity: 0.5; }
    .empty-state h4 { margin-bottom: 10px; color: var(--dark); }
    
    /* رسائل التنبيه */
    .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffcd39; color: #856404; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo"><h1><i class="fas fa-tasks"></i> مهامي</h1></div>
            <nav class="main-nav">
                <a href="#" class="nav-item active" data-view="tasks"><i class="fas fa-list-check"></i> المهام</a>
                <a href="#" class="nav-item" data-view="calendar"><i class="fas fa-calendar-days"></i> الجدول</a>
                <a href="#" class="nav-item" data-view="stats"><i class="fas fa-chart-pie"></i> الإحصائيات</a>
                <a href="#" class="nav-item" data-view="categories"><i class="fas fa-tags"></i> الفئات</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="header-left">
                    <h2 id="current-view-title">المهام</h2>
                    <div id="current-date" class="date-display"></div>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" id="add-task-btn"><i class="fas fa-plus"></i> إضافة مهمة</button>
                </div>
            </header>

            <div class="time-navigation" id="time-navigation" style="display: none;">
                <button class="time-btn active" data-range="daily"><i class="fas fa-calendar-day"></i> اليومي</button>
                <button class="time-btn" data-range="weekly"><i class="fas fa-calendar-week"></i> الأسبوعي</button>
                <button class="time-btn" data-range="monthly"><i class="fas fa-calendar-alt"></i> الشهري</button>
            </div>

            <div class="content-area">
                <!-- عرض المهام -->
                <div id="tasks-view" class="view active-view">
                    <div class="tasks-container">
                        <h3>مهام اليوم</h3>
                        <div id="time-alert" style="display: none;"></div>
                        <div class="tasks-list" id="tasks-list">
                            <div class="empty-state">
                                <i class="fas fa-tasks fa-3x"></i>
                                <h4>لا توجد مهام</h4>
                                <p>اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- عرض الجدول -->
                <div id="calendar-view" class="view">
                    <div class="calendar-container">
                        <h3>الجدول الزمني</h3>
                        <p>اختر عرضاً زمنياً من الأعلى</p>
                    </div>
                </div>

                <!-- عرض الإحصائيات -->
                <div id="stats-view" class="view">
                    <div class="stats-container">
                        <h3>إحصائيات المهام</h3>
                        <div id="stats-grid" class="stats-grid"></div>
                    </div>
                </div>

                <!-- عرض الفئات -->
                <div id="categories-view" class="view">
                    <div class="categories-container">
                        <h3>إدارة الفئات</h3>
                        <button class="btn btn-primary" id="add-category-btn"><i class="fas fa-plus"></i> إضافة فئة</button>
                        <div class="categories-list" id="categories-list" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- نافذة إضافة مهمة -->
    <div class="modal" id="add-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة مهمة جديدة</h3>
                <button class="close-btn" id="close-task-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-title">عنوان المهمة *</label>
                        <input type="text" id="task-title" placeholder="أدخل عنوان المهمة" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">وصف المهمة (اختياري)</label>
                        <textarea id="task-description" placeholder="أدخل وصف المهمة" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-category">الفئة</label>
                            <select id="task-category"></select>
                        </div>
                        <div class="form-group">
                            <label for="task-duration">المدة (دقائق) *</label>
                            <input type="number" id="task-duration" min="1" value="30" required>
                        </div>
                    </div>
                    <div id="time-check-result"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-task">إلغاء</button>
                <button class="btn btn-primary" id="save-task">حفظ المهمة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة/تعديل فئة -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-modal-title">إضافة فئة جديدة</h3>
                <button class="close-btn" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="form-group">
                        <label for="category-name">اسم الفئة *</label>
                        <input type="text" id="category-name" placeholder="أدخل اسم الفئة" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category-color">لون الفئة</label>
                            <input type="color" id="category-color" value="#4361ee">
                        </div>
                        <div class="form-group">
                            <label for="category-time-limit">الحصة اليومية (دقائق) *</label>
                            <input type="number" id="category-time-limit" min="1" value="60" required>
                            <small style="color: #6c757d; font-size: 0.85rem;">الحد الأقصى من الدقائق يوميًا</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-category">إلغاء</button>
                <button class="btn btn-primary" id="save-category">حفظ الفئة</button>
            </div>
        </div>
    </div>

    <script>
    // ========== نظام التخزين ==========
    class TaskManager {
        constructor() {
            console.log("تهيئة TaskManager...");
            
            // تحميل المهام مع التحقق
            const tasksData = this.loadFromStorage('tasks');
            this.tasks = Array.isArray(tasksData) ? tasksData : [];
            console.log("المهام المحملة:", this.tasks);
            
            // تحميل الفئات مع التحقق الشديد
            const categoriesData = this.loadFromStorage('categories');
            console.log("بيانات الفئات الخام:", categoriesData);
            
            if (Array.isArray(categoriesData) && categoriesData.length > 0) {
                this.categories = categoriesData;
                console.log("الفئات المحملة من التخزين:", this.categories);
            } else {
                console.log("استخدام الفئات الافتراضية");
                this.categories = this.getDefaultCategories();
            }
            
            // التأكد النهائي
            if (!Array.isArray(this.categories)) {
                console.error("الفئات ليست مصفوفة، إعادة تعيين:", this.categories);
                this.categories = this.getDefaultCategories();
            }
            
            console.log("الفئات النهائية:", this.categories);
            this.initSampleData();
        }

        loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                if (!data) return null;
                return JSON.parse(data);
            } catch (e) {
                console.error(`خطأ في تحميل ${key}:`, e);
                return null;
            }
        }

        saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`خطأ في حفظ ${key}:`, e);
            }
        }

        getDefaultCategories() {
            return [
                {
                    id: 'personal',
                    name: 'مهام شخصية',
                    color: '#4361ee',
                    timeLimit: 120, // ساعتين بالدقائق
                    icon: 'fas fa-home'
                },
                {
                    id: 'work',
                    name: 'عمل',
                    color: '#f72585',
                    timeLimit: 480, // 8 ساعات
                    icon: 'fas fa-briefcase'
                },
                {
                    id: 'study',
                    name: 'دراسة',
                    color: '#4cc9f0',
                    timeLimit: 180, // 3 ساعات
                    icon: 'fas fa-graduation-cap'
                },
                {
                    id: 'health',
                    name: 'صحية',
                    color: '#38b000',
                    timeLimit: 60, // ساعة واحدة
                    icon: 'fas fa-heartbeat'
                }
            ];
        }

        initSampleData() {
            // إذا لم تكن هناك مهام، أضف مهمة تجريبية
            if (this.tasks.length === 0) {
                this.tasks = [{
                    id: '1',
                    title: 'مهمة تجريبية',
                    description: 'هذه مهمة للاختبار',
                    categoryId: 'personal',
                    duration: 30,
                    date: this.getTodayDate(),
                    completed: false
                }];
                this.saveTasks();
            }
            
            // حفظ الفئات دائماً للتأكد
            this.saveCategories();
        }

        getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // وظائف المهام
        addTask(task) {
            if (!task.id) task.id = Date.now().toString();
            task.date = this.getTodayDate();
            this.tasks.push(task);
            this.saveTasks();
            console.log("تمت إضافة مهمة:", task);
            return task;
        }

        deleteTask(taskId) {
            this.tasks = this.tasks.filter(task => task.id !== taskId);
            this.saveTasks();
        }

        getTasks(date = null) {
            if (!date) date = this.getTodayDate();
            return this.tasks.filter(task => task.date === date);
        }

        getTaskById(taskId) {
            return this.tasks.find(task => task.id === taskId);
        }

        toggleTaskCompletion(taskId) {
            const task = this.getTaskById(taskId);
            if (task) {
                task.completed = !task.completed;
                this.saveTasks();
            }
        }

        saveTasks() {
            this.saveToStorage('tasks', this.tasks);
        }

        // التحقق من الوقت المتاح في الفئة
        checkCategoryTimeAvailability(categoryId, taskDuration, excludeTaskId = null) {
            const category = this.getCategoryById(categoryId);
            if (!category || !category.timeLimit) return { available: true, remaining: 0 };
            
            const todayTasks = this.getTasks().filter(task => 
                task.categoryId === categoryId && 
                (!excludeTaskId || task.id !== excludeTaskId)
            );
            
            const totalUsedTime = todayTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
            const remainingTime = category.timeLimit - totalUsedTime;
            
            return {
                available: remainingTime >= taskDuration,
                remaining: remainingTime,
                used: totalUsedTime,
                limit: category.timeLimit
            };
        }

        // وظائف الفئات
        addCategory(category) {
            if (!category.id) category.id = Date.now().toString();
            if (!category.timeLimit) category.timeLimit = 60; // قيمة افتراضية: ساعة واحدة
            this.categories.push(category);
            this.saveCategories();
            console.log("تمت إضافة فئة:", category);
            return category;
        }

        updateCategory(categoryId, updatedData) {
            const index = this.categories.findIndex(cat => cat.id === categoryId);
            if (index !== -1) {
                this.categories[index] = { ...this.categories[index], ...updatedData };
                this.saveCategories();
                console.log("تم تحديث الفئة:", this.categories[index]);
                return this.categories[index];
            }
            return null;
        }

        deleteCategory(categoryId) {
            // لا يمكن حذف فئة تحتوي على مهام
            const tasksInCategory = this.tasks.filter(task => task.categoryId === categoryId);
            if (tasksInCategory.length > 0) {
                return { success: false, message: 'لا يمكن حذف فئة تحتوي على مهام' };
            }
            
            this.categories = this.categories.filter(cat => cat.id !== categoryId);
            this.saveCategories();
            return { success: true };
        }

        getCategories() {
            // التأكد من إرجاع مصفوفة
            return Array.isArray(this.categories) ? [...this.categories] : [];
        }

        getCategoryById(categoryId) {
            if (!Array.isArray(this.categories)) {
                console.error("this.categories ليس مصفوفة:", this.categories);
                return null;
            }
            return this.categories.find(cat => cat.id === categoryId);
        }

        saveCategories() {
            this.saveToStorage('categories', this.categories);
        }

        // إحصائيات بسيطة
        getStatistics() {
            const tasks = this.getTasks();
            const categories = this.getCategories();
            
            // حساب الإحصائيات لكل فئة
            const categoryStats = categories.map(cat => {
                const catTasks = tasks.filter(t => t.categoryId === cat.id);
                const usedTime = catTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
                const percentage = cat.timeLimit ? Math.min(100, Math.round((usedTime / cat.timeLimit) * 100)) : 0;
                
                return {
                    ...cat,
                    taskCount: catTasks.length,
                    usedTime,
                    percentage,
                    remainingTime: cat.timeLimit - usedTime,
                    isFull: cat.timeLimit ? usedTime >= cat.timeLimit : false
                };
            });
            
            return {
                totalTasks: tasks.length,
                completedTasks: tasks.filter(t => t.completed).length,
                pendingTasks: tasks.filter(t => !t.completed).length,
                totalTime: tasks.reduce((sum, task) => sum + (task.duration || 0), 0),
                categories: categoryStats
            };
        }
    }

    // ========== واجهة المستخدم ==========
    class UI {
        constructor(taskManager) {
            this.taskManager = taskManager;
            this.currentView = 'tasks';
            this.editingCategoryId = null;
            this.initializeElements();
            this.setupEventListeners();
            this.initializeApp();
        }

        initializeElements() {
            this.elements = {
                currentDate: document.getElementById('current-date'),
                currentViewTitle: document.getElementById('current-view-title'),
                addTaskBtn: document.getElementById('add-task-btn'),
                addTaskModal: document.getElementById('add-task-modal'),
                closeTaskModal: document.getElementById('close-task-modal'),
                saveTaskBtn: document.getElementById('save-task'),
                taskTitle: document.getElementById('task-title'),
                taskDescription: document.getElementById('task-description'),
                taskCategory: document.getElementById('task-category'),
                taskDuration: document.getElementById('task-duration'),
                cancelTask: document.getElementById('cancel-task'),
                timeCheckResult: document.getElementById('time-check-result'),
                timeAlert: document.getElementById('time-alert'),
                
                categoryModal: document.getElementById('category-modal'),
                categoryModalTitle: document.getElementById('category-modal-title'),
                closeCategoryModal: document.getElementById('close-category-modal'),
                saveCategoryBtn: document.getElementById('save-category'),
                categoryId: document.getElementById('category-id'),
                categoryName: document.getElementById('category-name'),
                categoryColor: document.getElementById('category-color'),
                categoryTimeLimit: document.getElementById('category-time-limit'),
                cancelCategory: document.getElementById('cancel-category'),
                addCategoryBtn: document.getElementById('add-category-btn'),
                
                navItems: document.querySelectorAll('.nav-item'),
                views: document.querySelectorAll('.view'),
                timeNavigation: document.getElementById('time-navigation'),
                timeButtons: document.querySelectorAll('.time-btn'),
                tasksList: document.getElementById('tasks-list'),
                statsGrid: document.getElementById('stats-grid'),
                categoriesList: document.getElementById('categories-list')
            };
        }

        setupEventListeners() {
            // التنقل
            this.elements.navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchView(item.dataset.view);
                });
            });

            // إضافة مهمة
            this.elements.addTaskBtn.addEventListener('click', () => this.openAddTaskModal());
            this.elements.closeTaskModal.addEventListener('click', () => this.closeModal('add-task-modal'));
            this.elements.saveTaskBtn.addEventListener('click', () => this.saveTask());
            this.elements.cancelTask.addEventListener('click', () => this.closeModal('add-task-modal'));
            
            // التحقق من الوقت عند تغيير الفئة أو المدة
            this.elements.taskCategory.addEventListener('change', () => this.checkTimeAvailability());
            this.elements.taskDuration.addEventListener('input', () => this.checkTimeAvailability());

            // إدارة الفئات
            this.elements.addCategoryBtn.addEventListener('click', () => this.openCategoryModal());
            this.elements.closeCategoryModal.addEventListener('click', () => this.closeModal('category-modal'));
            this.elements.saveCategoryBtn.addEventListener('click', () => this.saveCategory());
            this.elements.cancelCategory.addEventListener('click', () => this.closeModal('category-modal'));

            // الوقت
            this.elements.timeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    this.elements.timeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        initializeApp() {
            console.log("تهيئة التطبيق...");
            this.updateDate();
            this.switchView('tasks');
        }

        updateDate() {
            const now = new Date();
            const arabicDate = now.toLocaleDateString('ar-SA', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            this.elements.currentDate.textContent = arabicDate;
        }

        switchView(viewName) {
            console.log("تبديل العرض إلى:", viewName);
            this.currentView = viewName;
            
            // تحديث التنقل
            this.elements.navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });
            
            // تحديث العنوان
            const titles = {
                tasks: 'المهام',
                calendar: 'الجدول الزمني',
                stats: 'الإحصائيات',
                categories: 'إدارة الفئات'
            };
            this.elements.currentViewTitle.textContent = titles[viewName];
            
            // التحكم بشريط الوقت
            this.elements.timeNavigation.style.display = (viewName === 'calendar') ? 'flex' : 'none';
            
            // إظهار/إخفاء العروض
            this.elements.views.forEach(view => {
                view.classList.remove('active-view');
                if (view.id === `${viewName}-view`) {
                    view.classList.add('active-view');
                }
            });
            
            // تحميل المحتوى
            switch(viewName) {
                case 'tasks':
                    this.loadTasksView();
                    break;
                case 'stats':
                    this.loadStatsView();
                    break;
                case 'categories':
                    this.loadCategoriesView();
                    break;
            }
        }

        // تحميل المهام
        loadTasksView() {
            console.log("تحميل عرض المهام...");
            const tasks = this.taskManager.getTasks();
            console.log("المهام:", tasks);
            
            // عرض التحذيرات الزمنية
            this.showTimeWarnings();
            
            if (!tasks || tasks.length === 0) {
                this.elements.tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks fa-3x"></i>
                        <h4>لا توجد مهام</h4>
                        <p>اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tasks.forEach(task => {
                const category = this.taskManager.getCategoryById(task.categoryId);
                console.log(`المهمة ${task.id} - الفئة:`, category);
                
                html += `
                    <div class="task-item ${task.completed ? 'completed' : ''}" data-id="${task.id}">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-content">
                            <div class="task-title">${task.title || 'بدون عنوان'}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <span><i class="fas fa-tag" style="color: ${category?.color || '#000'}"></i> ${category?.name || 'عام'}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration || 30} دقيقة</span>
                                <span><i class="fas ${task.completed ? 'fa-check-circle' : 'fa-hourglass-half'}"></i> ${task.completed ? 'مكتملة' : 'قيد التنفيذ'}</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-danger btn-sm delete-task" data-id="${task.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            this.elements.tasksList.innerHTML = html;
            
            // أحداث المهام
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = e.target.closest('.task-item').dataset.id;
                    this.taskManager.toggleTaskCompletion(taskId);
                    this.loadTasksView();
                });
            });
            
            document.querySelectorAll('.delete-task').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
                        this.taskManager.deleteTask(taskId);
                        this.loadTasksView();
                        this.showTimeWarnings();
                    }
                });
            });
        }

        // عرض التحذيرات الزمنية
        showTimeWarnings() {
            const categories = this.taskManager.getCategories();
            let warningsHtml = '';
            
            categories.forEach(category => {
                const timeCheck = this.taskManager.checkCategoryTimeAvailability(category.id, 0);
                const percentage = timeCheck.limit ? Math.round((timeCheck.used / timeCheck.limit) * 100) : 0;
                
                if (percentage >= 100) {
                    warningsHtml += `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>${category.name}</strong> ممتلئة بالكامل! (${timeCheck.used}/${timeCheck.limit} دقيقة)
                        </div>
                    `;
                } else if (percentage >= 80) {
                    warningsHtml += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>${category.name}</strong> قريبة من الامتلاء (${percentage}% - ${timeCheck.remaining} دقيقة متبقية)
                        </div>
                    `;
                }
            });
            
            this.elements.timeAlert.innerHTML = warningsHtml;
            this.elements.timeAlert.style.display = warningsHtml ? 'block' : 'none';
        }

        // تحميل الإحصائيات
        loadStatsView() {
            console.log("تحميل الإحصائيات...");
            const stats = this.taskManager.getStatistics();
            
            let html = '';
            
            // بطاقات إحصائية عامة
            html += `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card" style="border-color: #4361ee;">
                        <div style="font-size: 2rem; color: #4361ee; font-weight: bold;">${stats.totalTasks}</div>
                        <div style="color: #6c757d;">إجمالي المهام</div>
                    </div>
                    <div class="stat-card" style="border-color: #4cc9f0;">
                        <div style="font-size: 2rem; color: #4cc9f0; font-weight: bold;">${stats.completedTasks}</div>
                        <div style="color: #6c757d;">مهام مكتملة</div>
                    </div>
                    <div class="stat-card" style="border-color: #f8961e;">
                        <div style="font-size: 2rem; color: #f8961e; font-weight: bold;">${stats.pendingTasks}</div>
                        <div style="color: #6c757d;">مهام قيد الانتظار</div>
                    </div>
                </div>
            `;
            
            // إحصائيات الفئات
            html += `<h4 style="margin-bottom: 15px;">الحصص الزمنية للفئات</h4>`;
            
            stats.categories.forEach(category => {
                const percentage = category.percentage || 0;
                const remainingText = category.remainingTime > 0 ? 
                    `${category.remainingTime} دقيقة متبقية` : 
                    'ممتلئة بالكامل';
                
                html += `
                    <div class="stat-card" style="border-color: ${category.color}; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: ${category.color};">${category.name}</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">${category.taskCount} مهمة - ${category.usedTime}/${category.timeLimit} دقيقة</div>
                            </div>
                            <div style="font-weight: bold;">${percentage}%</div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${percentage}%; background: ${category.color};"></div>
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 5px;">
                            ${remainingText}
                        </div>
                    </div>
                `;
            });
            
            this.elements.statsGrid.innerHTML = html;
        }

        // تحميل الفئات
        loadCategoriesView() {
            console.log("تحميل الفئات...");
            const categories = this.taskManager.getCategories();
            console.log("الفئات المحملة:", categories);
            
            if (!categories || categories.length === 0) {
                this.elements.categoriesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tags fa-3x"></i>
                        <h4>لا توجد فئات</h4>
                        <p>اضغط على "إضافة فئة" لإنشاء فئتك الأولى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            categories.forEach(category => {
                // حساب الوقت المستخدم
                const tasks = this.taskManager.getTasks();
                const categoryTasks = tasks.filter(task => task.categoryId === category.id);
                const usedTime = categoryTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
                const percentage = category.timeLimit ? Math.min(100, Math.round((usedTime / category.timeLimit) * 100)) : 0;
                
                html += `
                    <div class="category-card" style="border-right-color: ${category.color}">
                        <div style="width: 40px; height: 40px; background: ${category.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-tag"></i>
                        </div>
                        <div class="category-info">
                            <div class="category-name">${category.name}</div>
                            <div class="category-stats">
                                <div>${categoryTasks.length} مهمة</div>
                                <div>${usedTime}/${category.timeLimit} دقيقة (${percentage}%)</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${percentage}%; background: ${category.color};"></div>
                            </div>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-secondary edit-category" data-id="${category.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-category" data-id="${category.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            this.elements.categoriesList.innerHTML = html;
            
            // أحداث الفئات
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.closest('button').dataset.id;
                    this.editCategory(categoryId);
                });
            });
            
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.closest('button').dataset.id;
                    this.deleteCategory(categoryId);
                });
            });
        }

        // فتح نافذة إضافة مهمة
        openAddTaskModal() {
            console.log("فتح نافذة إضافة مهمة");
            this.loadCategoryOptions();
            this.elements.taskTitle.value = '';
            this.elements.taskDescription.value = '';
            this.elements.taskDuration.value = '30';
            this.elements.timeCheckResult.innerHTML = '';
            this.elements.addTaskModal.classList.add('active');
        }

        // التحقق من الوقت المتاح
        checkTimeAvailability() {
            const categoryId = this.elements.taskCategory.value;
            const duration = parseInt(this.elements.taskDuration.value) || 0;
            
            if (!categoryId || duration <= 0) {
                this.elements.timeCheckResult.innerHTML = '';
                return;
            }
            
            const timeCheck = this.taskManager.checkCategoryTimeAvailability(categoryId, duration);
            const category = this.taskManager.getCategoryById(categoryId);
            
            let message = '';
            let alertClass = '';
            
            if (timeCheck.available) {
                alertClass = 'alert-success';
                message = `
                    <i class="fas fa-check-circle"></i>
                    الوقت متاح! ${timeCheck.remaining} دقيقة متبقية في فئة "${category.name}"
                `;
            } else {
                alertClass = 'alert-danger';
                message = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تجاوز الحصة!</strong> تحتاج ${duration} دقيقة لكن المتاح فقط ${timeCheck.remaining} دقيقة في فئة "${category.name}"
                `;
            }
            
            this.elements.timeCheckResult.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
        }

        loadCategoryOptions() {
            const categories = this.taskManager.getCategories();
            console.log("خيارات الفئات:", categories);
            
            const select = this.elements.taskCategory;
            select.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            
            // إذا لم تكن هناك فئات، أضف خياراً افتراضياً
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = 'general';
                option.textContent = 'عام';
                select.appendChild(option);
            }
            
            // تحقق من الوقت بعد تحميل الخيارات
            setTimeout(() => this.checkTimeAvailability(), 100);
        }

        saveTask() {
            const title = this.elements.taskTitle.value.trim();
            if (!title) {
                alert('يرجى إدخال عنوان المهمة');
                return;
            }
            
            const duration = parseInt(this.elements.taskDuration.value) || 0;
            if (duration <= 0) {
                alert('يرجى إدخال مدة صحيحة للمهمة');
                return;
            }
            
            const categoryId = this.elements.taskCategory.value;
            if (!categoryId) {
                alert('يرجى اختيار فئة للمهمة');
                return;
            }
            
            // التحقق من الوقت المتاح
            const timeCheck = this.taskManager.checkCategoryTimeAvailability(categoryId, duration);
            if (!timeCheck.available) {
                alert(`لا يمكن إضافة المهمة. الحصة اليومية للفئة ممتلئة. الوقت المتاح: ${timeCheck.remaining} دقيقة فقط`);
                return;
            }
            
            const task = {
                id: Date.now().toString(),
                title: title,
                description: this.elements.taskDescription.value.trim(),
                categoryId: categoryId,
                duration: duration,
                completed: false
            };
            
            console.log("حفظ المهمة:", task);
            this.taskManager.addTask(task);
            this.closeModal('add-task-modal');
            
            // تحديث العرض
            if (this.currentView === 'tasks') {
                this.loadTasksView();
            } else if (this.currentView === 'stats') {
                this.loadStatsView();
            }
        }

        // فتح نافذة إضافة/تعديل فئة
        openCategoryModal(categoryId = null) {
            this.editingCategoryId = categoryId;
            
            if (categoryId) {
                // وضع التعديل
                this.elements.categoryModalTitle.textContent = 'تعديل الفئة';
                const category = this.taskManager.getCategoryById(categoryId);
                if (category) {
                    this.elements.categoryId.value = category.id;
                    this.elements.categoryName.value = category.name;
                    this.elements.categoryColor.value = category.color || '#4361ee';
                    this.elements.categoryTimeLimit.value = category.timeLimit || 60;
                }
            } else {
                // وضع الإضافة
                this.elements.categoryModalTitle.textContent = 'إضافة فئة جديدة';
                this.elements.categoryId.value = '';
                this.elements.categoryName.value = '';
                this.elements.categoryColor.value = '#4361ee';
                this.elements.categoryTimeLimit.value = 60;
            }
            
            console.log("فتح نافذة الفئة");
            this.elements.categoryModal.classList.add('active');
        }

        // تعديل فئة
        editCategory(categoryId) {
            this.openCategoryModal(categoryId);
        }

        saveCategory() {
            const name = this.elements.categoryName.value.trim();
            if (!name) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }
            
            const timeLimit = parseInt(this.elements.categoryTimeLimit.value) || 0;
            if (timeLimit <= 0) {
                alert('يرجى إدخال حصة زمنية صحيحة');
                return;
            }
            
            const categoryData = {
                name: name,
                color: this.elements.categoryColor.value,
                timeLimit: timeLimit
            };
            
            if (this.editingCategoryId) {
                // تحديث فئة موجودة
                this.taskManager.updateCategory(this.editingCategoryId, categoryData);
            } else {
                // إضافة فئة جديدة
                categoryData.id = Date.now().toString();
                this.taskManager.addCategory(categoryData);
            }
            
            this.closeModal('category-modal');
            
            // تحديث العروض
            if (this.currentView === 'categories') {
                this.loadCategoriesView();
            } else if (this.currentView === 'stats') {
                this.loadStatsView();
            }
            
            // إعادة تعيين حالة التعديل
            this.editingCategoryId = null;
        }

        // حذف فئة
        deleteCategory(categoryId) {
            const result = this.taskManager.deleteCategory(categoryId);
            
            if (result.success) {
                // تحديث العرض
                this.loadCategoriesView();
                
                // إعادة تحميل خيارات الفئات في نموذج المهام
                this.loadCategoryOptions();
            } else {
                alert(result.message);
            }
        }

        closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
    }

    // ========== بدء التطبيق ==========
    document.addEventListener('DOMContentLoaded', () => {
        console.log("بدء تحميل التطبيق...");
        
        try {
            const taskManager = new TaskManager();
            const ui = new UI(taskManager);
            
            console.log("✅ تم تحميل التطبيق بنجاح!");
            
            // فتح Console للمستخدم
            console.log("=========================================");
            console.log("🎯 تطبيق إدارة المهام مع التحكم الزمني!");
            console.log("📱 الميزات المتاحة:");
            console.log("   - إضافة وحذف المهام مع التحقق الزمني");
            console.log("   - إضافة/تعديل/حذف الفئات مع تحديد الحصص");
            console.log("   - عرض مستوى امتلاء الفئات في الرسم البياني");
            console.log("   - منع إضافة مهام تتجاوز الحصة الزمنية");
            console.log("   - تخزين محلي للبيانات");
            console.log("=========================================");
            
        } catch (error) {
            console.error("❌ خطأ في تحميل التطبيق:", error);
            alert('حدث خطأ في تحميل التطبيق. يرجى تحديث الصفحة.');
        }
    });
    </script>
</body>
</html>
