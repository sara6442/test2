<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهامي - تطبيق إدارة المهام</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #fefaf6; /* لون البيج */
        color: #5d4037;
        direction: rtl;
        min-height: 100vh;
    }
    
    .app-container {
        display: flex;
        min-height: 100vh;
    }
    
    /* الشريط الجانبي - ثيم البيج */
    .sidebar {
        width: 250px;
        background: linear-gradient(to bottom, #d7ccc8, #bcaaa4); /* درجات البيج */
        color: #5d4037;
        padding: 20px 0;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        border-left: 1px solid #a1887f;
    }
    
    .logo {
        padding: 0 20px 30px;
        border-bottom: 1px solid #a1887f;
        margin-bottom: 30px;
    }
    
    .logo h1 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.5rem;
        color: #5d4037;
    }
    
    .nav-menu {
        padding: 0 15px;
    }
    
    .nav-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        color: #5d4037;
        text-decoration: none;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.3s;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.2);
    }
    
    .nav-item:hover {
        background: rgba(255, 255, 255, 0.4);
    }
    
    .nav-item.active {
        background: rgba(255, 255, 255, 0.6);
        font-weight: bold;
        border-right: 4px solid #8d6e63;
    }
    
    .nav-item i {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
        color: #8d6e63;
    }
    
    /* المحتوى الرئيسي */
    .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fefaf6;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #d7ccc8;
    }
    
    .header h1 {
        color: #8d6e63;
        margin-bottom: 5px;
    }
    
    .current-date {
        color: #a1887f;
        font-size: 0.9rem;
    }
    
    /* أزرار - ألوان متناسقة مع البيج */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .btn-primary {
        background: #8d6e63;
        color: white;
    }
    
    .btn-primary:hover {
        background: #6d4c41;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #d7ccc8;
        color: #5d4037;
        border: 1px solid #bcaaa4;
    }
    
    .btn-secondary:hover {
        background: #bcaaa4;
    }
    
    .btn-danger {
        background: #d84315;
        color: white;
    }
    
    .btn-danger:hover {
        background: #bf360c;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.9rem;
    }
    
    .btn-success {
        background: #388e3c;
        color: white;
    }
    
    .btn-success:hover {
        background: #2e7d32;
    }
    
    /* منطقة المحتوى */
    .content-area {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        min-height: 500px;
        border: 1px solid #d7ccc8;
    }
    
    .view {
        display: none;
    }
    
    .view.active {
        display: block;
    }
    
    /* قائمة المهام */
    .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .task-card {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
        border-right: 4px solid #8d6e63;
        transition: all 0.3s;
        position: relative;
    }
    
    .task-card:hover {
        transform: translateX(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .task-card.completed {
        opacity: 0.7;
        border-color: #4caf50;
        background: #e8f5e9;
    }
    
    .task-card.completed .task-title {
        text-decoration: line-through;
    }
    
    .task-card.overdue {
        border-color: #d84315;
        background: #ffebee;
        order: -1; /* يجعل المهام المتأخرة في الأعلى */
    }
    
    .task-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .task-content {
        flex: 1;
    }
    
    .task-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #5d4037;
    }
    
    .task-description {
        color: #795548;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .task-meta {
        display: flex;
        gap: 15px;
        font-size: 0.85rem;
        color: #8d6e63;
    }
    
    .task-actions {
        display: flex;
        gap: 10px;
    }
    
    /* شريط التقدم - من اليمين لليسار */
    .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 5px;
        margin: 10px 0;
        overflow: hidden;
        height: 10px;
    }
    
    .progress-bar {
        height: 100%;
        border-radius: 5px;
        transition: width 0.3s;
    }
    
    /* العلامات للفئات */
    .category-tag {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-left: 10px;
    }
    
    /* النوافذ المنبثقة */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 1px solid #d7ccc8;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f5f5f5;
        border-radius: 12px 12px 0 0;
    }
    
    .modal-header h3 {
        color: #8d6e63;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #8d6e63;
    }
    
    .close-btn:hover {
        color: #d84315;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        background: #f5f5f5;
        border-radius: 0 0 12px 12px;
    }
    
    /* نماذج الإدخال */
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #5d4037;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #d7ccc8;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        background: white;
        color: #5d4037;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #8d6e63;
        box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.1);
    }
    
    .form-row {
        display: flex;
        gap: 15px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    /* الفئات */
    .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .category-card {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        transition: all 0.3s;
        border: 2px solid transparent;
        position: relative;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: #8d6e63;
    }
    
    .category-header {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .category-color {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .category-name {
        font-weight: bold;
        flex: 1;
        color: #5d4037;
        font-size: 1.1rem;
    }
    
    .category-stats {
        font-size: 0.85rem;
        color: #8d6e63;
    }
    
    /* شريط المهام داخل الفئة - من اليمين لليسار */
    .category-progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        height: 12px;
        direction: ltr; /* يجعل التعبئة من اليمين لليسار */
    }
    
    .category-progress-bar {
        height: 100%;
        border-radius: 5px;
        transition: width 0.3s;
        float: right; /* للتعبئة من اليمين */
    }
    
    .category-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    /* شريط التبويب الزمني */
    .time-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 10px;
        border: 1px solid #d7ccc8;
    }
    
    .time-tab {
        flex: 1;
        padding: 10px;
        border: 2px solid #d7ccc8;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
        color: #5d4037;
        font-weight: 500;
    }
    
    .time-tab:hover {
        border-color: #8d6e63;
        color: #8d6e63;
    }
    
    .time-tab.active {
        background: #8d6e63;
        color: white;
        border-color: #8d6e63;
    }
    
    /* الجدول الزمني */
    .calendar-view {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .day-column {
        background: #f5f5f5;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #d7ccc8;
    }
    
    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #8d6e63;
    }
    
    .day-title {
        font-weight: bold;
        color: #8d6e63;
        font-size: 1.1rem;
    }
    
    .day-date {
        color: #8d6e63;
        font-size: 0.9rem;
    }
    
    .day-tasks {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .calendar-task {
        background: white;
        border-radius: 8px;
        padding: 12px;
        border-right: 4px solid;
        transition: all 0.3s;
        position: relative;
    }
    
    .calendar-task:hover {
        transform: translateX(-3px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .calendar-task .task-title {
        font-size: 0.95rem;
        margin-bottom: 5px;
    }
    
    .calendar-task .task-time {
        font-size: 0.8rem;
        color: #8d6e63;
        margin-bottom: 5px;
    }
    
    .calendar-task .task-actions {
        position: absolute;
        left: 10px;
        top: 10px;
    }
    
    /* المرشحات في أسفل الصفحة */
    .task-filters {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
        border: 1px solid #d7ccc8;
    }
    
    .filter-btn {
        padding: 8px 20px;
        border: 2px solid #d7ccc8;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        color: #5d4037;
        font-weight: 500;
    }
    
    .filter-btn:hover {
        border-color: #8d6e63;
        color: #8d6e63;
    }
    
    .filter-btn.active {
        background: #8d6e63;
        color: white;
        border-color: #8d6e63;
    }
    
    /* محرر الملاحظات المتقدم */
    .notes-editor {
        border: 1px solid #d7ccc8;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 20px;
    }
    
    .editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 10px;
        background: #f5f5f5;
        border-bottom: 1px solid #d7ccc8;
    }
    
    .editor-btn {
        padding: 6px 12px;
        border: 1px solid #d7ccc8;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        color: #5d4037;
    }
    
    .editor-btn:hover {
        background: #e0e0e0;
    }
    
    .editor-btn.active {
        background: #8d6e63;
        color: white;
        border-color: #8d6e63;
    }
    
    .editor-content {
        min-height: 200px;
        padding: 20px;
        font-size: 1rem;
        line-height: 1.6;
        outline: none;
        background: white;
        color: #5d4037;
    }
    
    /* حالة فارغة */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a1887f;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .empty-state h3 {
        margin-bottom: 10px;
        color: #8d6e63;
    }
    
    /* أداة التلميح */
    .task-tooltip {
        position: absolute;
        background: #5d4037;
        color: white;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
        z-index: 1000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        pointer-events: none;
    }
    
    .task-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 20px;
        border-width: 6px;
        border-style: solid;
        border-color: #5d4037 transparent transparent transparent;
    }
    
    /* تصميم متجاوب */
    @media (max-width: 768px) {
        .app-container {
            flex-direction: column;
        }
        
        .sidebar {
            width: 100%;
            position: static;
        }
        
        .main-content {
            margin-right: 0;
        }
        
        .nav-menu {
            display: flex;
            overflow-x: auto;
            padding: 10px;
        }
        
        .nav-item {
            flex-shrink: 0;
        }
        
        .categories-grid {
            grid-template-columns: 1fr;
        }
        
        .calendar-view {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            flex-direction: column;
        }
    }
    
    /* تلميحات على أشرطة التقدم */
    .progress-tooltip {
        position: relative;
        cursor: help;
    }
    
    .progress-tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #5d4037;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 10;
    }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- الشريط الجانبي -->
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-tasks"></i> مهامي</h1>
            </div>
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-view="tasks">
                    <i class="fas fa-list-check"></i>
                    <span>المهام</span>
                </a>
                <a href="#" class="nav-item" data-view="calendar">
                    <i class="fas fa-calendar-days"></i>
                    <span>الجدول</span>
                </a>
                <a href="#" class="nav-item" data-view="categories">
                    <i class="fas fa-tags"></i>
                    <span>الفئات</span>
                </a>
            </nav>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <header class="header">
                <div>
                    <h1 id="page-title">المهام</h1>
                    <div id="current-date" class="current-date"></div>
                </div>
                <div>
                    <button class="btn btn-primary" id="add-task-btn">
                        <i class="fas fa-plus"></i> إضافة مهمة
                    </button>
                </div>
            </header>

            <!-- شريط التبويب الزمني (يظهر فقط في عرض الجدول) -->
            <div class="time-tabs" id="time-tabs" style="display: none;">
                <button class="time-tab active" data-range="daily">اليومي</button>
                <button class="time-tab" data-range="weekly">الأسبوعي</button>
                <button class="time-tab" data-range="monthly">الشهري</button>
            </div>

            <!-- منطقة المحتوى -->
            <div class="content-area">
                <!-- عرض المهام -->
                <div id="tasks-view" class="view active">
                    <h2>قائمة المهام</h2>
                    <div class="tasks-list" id="tasks-list">
                        <!-- المهام ستظهر هنا -->
                    </div>
                    
                    <!-- المرشحات في الأسفل -->
                    <div class="task-filters">
                        <button class="filter-btn active" data-filter="all">جميع المهام</button>
                        <button class="filter-btn" data-filter="completed">المهام المنجزة</button>
                        <button class="filter-btn" data-filter="deleted">المهام المحذوفة</button>
                        <button class="filter-btn" data-filter="overdue">المهام المتأخرة</button>
                    </div>
                </div>

                <!-- عرض الجدول -->
                <div id="calendar-view" class="view">
                    <h2>الجدول الزمني</h2>
                    <div id="calendar-content">
                        <!-- محتوى الجدول -->
                    </div>
                </div>

                <!-- عرض الفئات -->
                <div id="categories-view" class="view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">إدارة الفئات</h2>
                        <button class="btn btn-primary" id="add-category-btn">
                            <i class="fas fa-plus"></i> إضافة فئة
                        </button>
                    </div>
                    <button class="btn btn-secondary" id="add-task-from-category" style="margin-bottom: 20px;">
                        <i class="fas fa-plus-circle"></i> إضافة مهمة جديدة
                    </button>
                    <div class="categories-grid" id="categories-list">
                        <!-- الفئات ستظهر هنا -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- نافذة إضافة مهمة -->
    <div class="modal" id="add-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة مهمة جديدة</h3>
                <button class="close-btn" id="close-task-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-title">عنوان المهمة *</label>
                        <input type="text" id="task-title" placeholder="أدخل عنوان المهمة" required>
                    </div>
                    <div class="form-group">
                        <label for="task-category">الفئة *</label>
                        <select id="task-category" required>
                            <option value="">-- اختر الفئة --</option>
                            <!-- الفئات ستضاف هنا -->
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-date">تاريخ الاستحقاق</label>
                            <input type="date" id="task-date">
                        </div>
                        <div class="form-group">
                            <label for="task-time">الوقت</label>
                            <input type="time" id="task-time">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-duration">المدة (دقائق)</label>
                            <input type="number" id="task-duration" min="1" value="30">
                        </div>
                        <div class="form-group">
                            <label for="task-priority">الأولوية</label>
                            <select id="task-priority">
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="task-description">الوصف</label>
                        <textarea id="task-description" placeholder="أدخل وصف المهمة" rows="4"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-task">إلغاء</button>
                <button class="btn btn-primary" id="save-task">حفظ المهمة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة فئة -->
    <div class="modal" id="add-category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة فئة جديدة</h3>
                <button class="close-btn" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-name">اسم الفئة *</label>
                        <input type="text" id="category-name" placeholder="أدخل اسم الفئة" required>
                    </div>
                    <div class="form-group">
                        <label for="category-color">لون الفئة</label>
                        <input type="color" id="category-color" value="#8d6e63">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-category">إلغاء</button>
                <button class="btn btn-primary" id="save-category">حفظ الفئة</button>
            </div>
        </div>
    </div>

    <!-- نافذة الملاحظات المتقدمة -->
    <div class="modal" id="notes-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="notes-title">ملاحظات</h3>
                <button class="close-btn" id="close-notes-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="note-title">عنوان الملاحظة</label>
                    <input type="text" id="note-title" placeholder="أدخل عنوان الملاحظة">
                </div>
                <div class="notes-editor">
                    <div class="editor-toolbar" id="editor-toolbar">
                        <select id="font-size" class="editor-btn">
                            <option value="12">12px</option>
                            <option value="14">14px</option>
                            <option value="16" selected>16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                            <option value="24">24px</option>
                        </select>
                        <select id="font-family" class="editor-btn">
                            <option value="Arial">Arial</option>
                            <option value="'Segoe UI'">Segoe UI</option>
                            <option value="Tahoma">Tahoma</option>
                            <option value="'Times New Roman'">Times New Roman</option>
                        </select>
                        <button class="editor-btn" data-command="bold"><i class="fas fa-bold"></i></button>
                        <button class="editor-btn" data-command="italic"><i class="fas fa-italic"></i></button>
                        <button class="editor-btn" data-command="underline"><i class="fas fa-underline"></i></button>
                        <button class="editor-btn" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                        <button class="editor-btn" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                        <button class="editor-btn" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                        <select id="text-color" class="editor-btn">
                            <option value="#000000">أسود</option>
                            <option value="#8d6e63">بني</option>
                            <option value="#d84315">أحمر</option>
                            <option value="#388e3c">أخضر</option>
                            <option value="#1565c0">أزرق</option>
                        </select>
                        <button class="editor-btn" data-command="insertUnorderedList"><i class="fas fa-list-ul"></i></button>
                        <button class="editor-btn" data-command="insertOrderedList"><i class="fas fa-list-ol"></i></button>
                    </div>
                    <div class="editor-content" id="note-content" contenteditable="true"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-note">إلغاء</button>
                <button class="btn btn-primary" id="save-note">حفظ الملاحظة</button>
            </div>
        </div>
    </div>

    <script>
    // ========== حالة التطبيق ==========
    const AppState = {
        tasks: [],
        categories: [],
        currentView: 'tasks',
        currentFilter: 'all',
        deletedTasks: [],
        currentTaskId: null,
        notes: {}
    };
    
    // ========== إدارة البيانات ==========
    function initializeData() {
        console.log("تهيئة البيانات...");
        
        // تحميل المهام
        try {
            const savedTasks = localStorage.getItem('mytasks_tasks');
            AppState.tasks = savedTasks ? JSON.parse(savedTasks) : [];
        } catch (e) {
            console.error("خطأ في تحميل المهام:", e);
            AppState.tasks = [];
        }
        
        // تحميل المهام المحذوفة
        try {
            const savedDeleted = localStorage.getItem('mytasks_deleted');
            AppState.deletedTasks = savedDeleted ? JSON.parse(savedDeleted) : [];
        } catch (e) {
            console.error("خطأ في تحميل المهام المحذوفة:", e);
            AppState.deletedTasks = [];
        }
        
        // تحميل الفئات
        try {
            const savedCategories = localStorage.getItem('mytasks_categories');
            AppState.categories = savedCategories ? JSON.parse(savedCategories) : [];
            
            if (!Array.isArray(AppState.categories) || AppState.categories.length === 0) {
                AppState.categories = [
                    { id: 'work', name: 'عمل', color: '#8d6e63' },
                    { id: 'personal', name: 'شخصي', color: '#5d4037' },
                    { id: 'study', name: 'دراسة', color: '#a1887f' }
                ];
                saveCategories();
            }
        } catch (e) {
            console.error("خطأ في تحميل الفئات:", e);
            AppState.categories = [
                { id: 'work', name: 'عمل', color: '#8d6e63' },
                { id: 'personal', name: 'شخصي', color: '#5d4037' },
                { id: 'study', name: 'دراسة', color: '#a1887f' }
            ];
            saveCategories();
        }
        
        // تحميل الملاحظات
        try {
            const savedNotes = localStorage.getItem('mytasks_notes');
            AppState.notes = savedNotes ? JSON.parse(savedNotes) : {};
        } catch (e) {
            console.error("خطأ في تحميل الملاحظات:", e);
            AppState.notes = {};
        }
        
        // إضافة بيانات تجريبية إذا لم تكن هناك مهام
        if (AppState.tasks.length === 0) {
            AppState.tasks = [
                {
                    id: Date.now().toString(),
                    title: 'مهمة تجريبية',
                    description: 'هذه مهمة للاختبار',
                    categoryId: 'work',
                    duration: 30,
                    date: new Date().toISOString().split('T')[0],
                    time: '14:00',
                    priority: 'medium',
                    completed: false,
                    createdAt: new Date().toISOString()
                }
            ];
            saveTasks();
        }
    }
    
    function saveTasks() {
        try {
            localStorage.setItem('mytasks_tasks', JSON.stringify(AppState.tasks));
        } catch (e) {
            console.error("خطأ في حفظ المهام:", e);
        }
    }
    
    function saveDeletedTasks() {
        try {
            localStorage.setItem('mytasks_deleted', JSON.stringify(AppState.deletedTasks));
        } catch (e) {
            console.error("خطأ في حفظ المهام المحذوفة:", e);
        }
    }
    
    function saveCategories() {
        try {
            localStorage.setItem('mytasks_categories', JSON.stringify(AppState.categories));
        } catch (e) {
            console.error("خطأ في حفظ الفئات:", e);
        }
    }
    
    function saveNotes() {
        try {
            localStorage.setItem('mytasks_notes', JSON.stringify(AppState.notes));
        } catch (e) {
            console.error("خطأ في حفظ الملاحظات:", e);
        }
    }
    
    // ========== وظائف المساعدة ==========
    function getCategoryById(categoryId) {
        return AppState.categories.find(cat => cat.id === categoryId) || 
               { name: 'عام', color: '#8d6e63' };
    }
    
    function getLightColor(hexColor, percent = 30) {
        // تحويل اللون إلى أفتح بثلاث درجات
        let r = parseInt(hexColor.substr(1, 2), 16);
        let g = parseInt(hexColor.substr(3, 2), 16);
        let b = parseInt(hexColor.substr(5, 2), 16);
        
        r = Math.min(255, r + percent * 2.55);
        g = Math.min(255, g + percent * 2.55);
        b = Math.min(255, b + percent * 2.55);
        
        return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
    }
    
    function isTaskOverdue(task) {
        if (!task.date) return false;
        const today = new Date().toISOString().split('T')[0];
        return task.date < today && !task.completed;
    }
    
    // ========== إدارة المهام ==========
    function addTask(taskData) {
        const newTask = {
            id: Date.now().toString(),
            title: taskData.title,
            description: taskData.description || '',
            categoryId: taskData.categoryId,
            duration: parseInt(taskData.duration) || 30,
            date: taskData.date || new Date().toISOString().split('T')[0],
            time: taskData.time || '',
            priority: taskData.priority || 'medium',
            completed: false,
            createdAt: new Date().toISOString()
        };
        
        AppState.tasks.push(newTask);
        saveTasks();
        
        if (AppState.currentView === 'tasks') {
            renderTasks();
        } else if (AppState.currentView === 'calendar') {
            renderCalendar();
        } else if (AppState.currentView === 'categories') {
            renderCategories();
        }
        
        closeModal('add-task-modal');
        document.getElementById('task-form').reset();
    }
    
    function deleteTask(taskId) {
        const taskIndex = AppState.tasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) {
            alert('هذه المهمة غير موجودة أو تم حذفها بالفعل');
            return;
        }
        
        const task = AppState.tasks[taskIndex];
        if (!confirm(`هل أنت متأكد من حذف المهمة: "${task.title}"؟`)) return;
        
        // نقل المهمة إلى المهام المحذوفة
        AppState.deletedTasks.push({
            ...task,
            deletedAt: new Date().toISOString()
        });
        
        // حذف المهمة من القائمة الرئيسية
        AppState.tasks.splice(taskIndex, 1);
        
        saveTasks();
        saveDeletedTasks();
        
        if (AppState.currentView === 'tasks') {
            renderTasks();
        } else if (AppState.currentView === 'calendar') {
            renderCalendar();
        }
    }
    
    function toggleTaskCompletion(taskId) {
        const task = AppState.tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            saveTasks();
            
            if (AppState.currentView === 'tasks') {
                renderTasks();
            } else if (AppState.currentView === 'calendar') {
                renderCalendar();
            } else if (AppState.currentView === 'categories') {
                renderCategories();
            }
        }
    }
    
    function restoreTask(taskId) {
        const taskIndex = AppState.deletedTasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) return;
        
        const task = AppState.deletedTasks[taskIndex];
        AppState.tasks.push(task);
        AppState.deletedTasks.splice(taskIndex, 1);
        
        saveTasks();
        saveDeletedTasks();
        renderTasks();
    }
    
    // ========== إدارة الفئات ==========
    function addCategory(categoryData) {
        const newCategory = {
            id: Date.now().toString(),
            name: categoryData.name,
            color: categoryData.color,
            createdAt: new Date().toISOString()
        };
        
        AppState.categories.push(newCategory);
        saveCategories();
        
        if (AppState.currentView === 'categories') {
            renderCategories();
        }
        
        closeModal('add-category-modal');
        document.getElementById('category-form').reset();
    }
    
    function deleteCategory(categoryId) {
        if (!confirm('هل أنت متأكد من حذف هذه الفئة؟')) return;
        
        AppState.categories = AppState.categories.filter(cat => cat.id !== categoryId);
        saveCategories();
        
        if (AppState.currentView === 'categories') {
            renderCategories();
        }
    }
    
    // ========== إدارة الملاحظات ==========
    function openNotesEditor(taskId) {
        AppState.currentTaskId = taskId;
        const task = AppState.tasks.find(t => t.id === taskId);
        
        document.getElementById('notes-title').textContent = `ملاحظات: ${task.title}`;
        document.getElementById('note-title').value = AppState.notes[taskId]?.title || '';
        
        const editor = document.getElementById('note-content');
        editor.innerHTML = AppState.notes[taskId]?.content || '';
        
        openModal('notes-modal');
        
        // تركيز المحرر
        setTimeout(() => {
            editor.focus();
        }, 100);
    }
    
    function saveNote() {
        if (!AppState.currentTaskId) return;
        
        const title = document.getElementById('note-title').value;
        const content = document.getElementById('note-content').innerHTML;
        
        AppState.notes[AppState.currentTaskId] = {
            title: title,
            content: content,
            updatedAt: new Date().toISOString()
        };
        
        saveNotes();
        closeModal('notes-modal');
    }
    
    // ========== العروض ==========
    function renderTasks() {
        console.log("عرض المهام مع المرشح:", AppState.currentFilter);
        const container = document.getElementById('tasks-list');
        
        let tasksToShow = [];
        
        switch(AppState.currentFilter) {
            case 'all':
                tasksToShow = AppState.tasks;
                break;
            case 'completed':
                tasksToShow = AppState.tasks.filter(task => task.completed);
                break;
            case 'deleted':
                tasksToShow = AppState.deletedTasks;
                break;
            case 'overdue':
                tasksToShow = AppState.tasks.filter(task => isTaskOverdue(task));
                break;
        }
        
        // ترتيب المهام: المتأخرة أولاً، ثم حسب التاريخ
        tasksToShow.sort((a, b) => {
            if (isTaskOverdue(a) && !isTaskOverdue(b)) return -1;
            if (!isTaskOverdue(a) && isTaskOverdue(b)) return 1;
            
            const dateA = a.date ? new Date(a.date) : new Date(0);
            const dateB = b.date ? new Date(b.date) : new Date(0);
            
            if (dateA < dateB) return -1;
            if (dateA > dateB) return 1;
            return 0;
        });
        
        if (tasksToShow.length === 0) {
            let message = '';
            switch(AppState.currentFilter) {
                case 'all': message = 'لا توجد مهام'; break;
                case 'completed': message = 'لا توجد مهام منجزة'; break;
                case 'deleted': message = 'لا توجد مهام محذوفة'; break;
                case 'overdue': message = 'لا توجد مهام متأخرة'; break;
            }
            
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>${message}</h3>
                    <p>${AppState.currentFilter === 'all' ? 'اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى' : ''}</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        tasksToShow.forEach(task => {
            const category = getCategoryById(task.categoryId);
            const isDeleted = AppState.currentFilter === 'deleted';
            const isOverdue = isTaskOverdue(task);
            const hasNote = AppState.notes[task.id];
            
            if (isDeleted) {
                // عرض المهام المحذوفة
                html += `
                    <div class="task-card deleted" data-id="${task.id}">
                        <div class="task-content">
                            <div class="task-title" style="color: #999; text-decoration: line-through;">${task.title}</div>
                            ${task.description ? `<div class="task-description" style="color: #aaa;">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <span><i class="fas fa-tag" style="color: ${category.color}"></i> ${category.name}</span>
                                <span><i class="fas fa-calendar"></i> ${task.date || 'بدون تاريخ'}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration} دقيقة</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-success btn-sm restore-task-btn" data-id="${task.id}" title="استعادة">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-danger btn-sm permanent-delete-btn" data-id="${task.id}" title="حذف نهائي">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // عرض المهام العادية
                html += `
                    <div class="task-card ${task.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${task.id}">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <span class="category-tag" style="background: ${category.color}; color: white;">${category.name}</span>
                                <span><i class="fas fa-calendar"></i> ${task.date || 'بدون تاريخ'}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration} دقيقة</span>
                                <span><i class="fas fa-flag" style="color: ${
                                    task.priority === 'high' ? '#d84315' : 
                                    task.priority === 'medium' ? '#f57c00' : '#388e3c'
                                }"></i> ${task.priority === 'high' ? 'عالية' : task.priority === 'medium' ? 'متوسطة' : 'منخفضة'}</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            ${hasNote ? `<button class="btn btn-secondary btn-sm view-notes-btn" data-id="${task.id}" title="عرض الملاحظات">
                                <i class="fas fa-sticky-note"></i>
                            </button>` : ''}
                            <button class="btn btn-secondary btn-sm edit-notes-btn" data-id="${task.id}" title="إضافة/تعديل ملاحظات">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-task-btn" data-id="${task.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
        
        // إضافة الأحداث
        if (AppState.currentFilter === 'deleted') {
            document.querySelectorAll('.restore-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    restoreTask(taskId);
                });
            });
            
            document.querySelectorAll('.permanent-delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    if (confirm('هل أنت متأكد من الحذف النهائي؟ لا يمكن استعادة المهمة بعد ذلك.')) {
                        const index = AppState.deletedTasks.findIndex(t => t.id === taskId);
                        if (index !== -1) {
                            AppState.deletedTasks.splice(index, 1);
                            saveDeletedTasks();
                            renderTasks();
                        }
                    }
                });
            });
        } else {
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = e.target.closest('.task-card').dataset.id;
                    toggleTaskCompletion(taskId);
                });
            });
            
            document.querySelectorAll('.delete-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    deleteTask(taskId);
                });
            });
            
            document.querySelectorAll('.edit-notes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    openNotesEditor(taskId);
                });
            });
            
            document.querySelectorAll('.view-notes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    openNotesEditor(taskId);
                });
            });
        }
    }
    
    function renderCategories() {
        const container = document.getElementById('categories-list');
        
        if (!AppState.categories || AppState.categories.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tags"></i>
                    <h3>لا توجد فئات</h3>
                    <p>اضغط على "إضافة فئة" لإنشاء فئتك الأولى</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        AppState.categories.forEach(category => {
            const categoryTasks = AppState.tasks.filter(task => task.categoryId === category.id);
            const completedTasks = categoryTasks.filter(task => task.completed).length;
            const totalTasks = categoryTasks.length;
            const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const lightColor = getLightColor(category.color, 30);
            
            html += `
                <div class="category-card" data-id="${category.id}">
                    <div class="category-header">
                        <div class="category-color" style="background: ${category.color}"></div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-stats">${totalTasks} مهام</div>
                    </div>
                    
                    <div class="category-progress-container progress-tooltip" data-tooltip="تم إكمال ${completedTasks} من ${totalTasks} مهمة">
                        <div class="category-progress-bar" style="width: ${progressPercent}%; background: ${lightColor};"></div>
                    </div>
                    
                    <div class="category-actions">
                        <button class="btn btn-secondary btn-sm add-task-to-category-btn" data-category-id="${category.id}">
                            <i class="fas fa-plus"></i> إضافة مهمة
                        </button>
                        <button class="btn btn-danger btn-sm delete-category-btn" data-id="${category.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // إضافة تلميحات عند المرور على أشرطة التقدم
        document.querySelectorAll('.progress-tooltip').forEach(progressBar => {
            progressBar.addEventListener('mouseenter', function(e) {
                const tooltip = document.createElement('div');
                tooltip.className = 'task-tooltip';
                tooltip.textContent = this.dataset.tooltip;
                document.body.appendChild(tooltip);
                
                const rect = this.getBoundingClientRect();
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                tooltip.style.display = 'block';
                
                this._tooltip = tooltip;
            });
            
            progressBar.addEventListener('mouseleave', function() {
                if (this._tooltip) {
                    this._tooltip.remove();
                    this._tooltip = null;
                }
            });
        });
        
        // إضافة الأحداث للفئات
        document.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('button').dataset.id;
                deleteCategory(categoryId);
            });
        });
        
        document.querySelectorAll('.add-task-to-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const categoryId = e.target.closest('button').dataset.categoryId;
                openAddTaskModal(categoryId);
            });
        });
    }
    
    function renderCalendar() {
        const container = document.getElementById('calendar-content');
        const activeTab = document.querySelector('.time-tab.active');
        const range = activeTab ? activeTab.dataset.range : 'daily';
        
        if (range === 'daily') {
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = AppState.tasks.filter(task => task.date === today);
            
            if (todayTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-day"></i>
                        <h3>لا توجد مهام لهذا اليوم</h3>
                        <p>أضف مهام جديدة لعرضها هنا</p>
                    </div>
                `;
                return;
            }
            
            // تجميع المهام حسب الوقت
            const tasksByTime = {
                morning: [],
                afternoon: [],
                evening: [],
                night: [],
                noTime: []
            };
            
            todayTasks.forEach(task => {
                if (!task.time) {
                    tasksByTime.noTime.push(task);
                    return;
                }
                
                const hour = parseInt(task.time.split(':')[0]);
                if (hour >= 5 && hour < 12) tasksByTime.morning.push(task);
                else if (hour >= 12 && hour < 17) tasksByTime.afternoon.push(task);
                else if (hour >= 17 && hour < 22) tasksByTime.evening.push(task);
                else tasksByTime.night.push(task);
            });
            
            let html = '<div class="calendar-view">';
            
            const timeSlots = [
                { name: 'الصباح', key: 'morning', icon: 'fas fa-sun' },
                { name: 'بعد الظهر', key: 'afternoon', icon: 'fas fa-cloud-sun' },
                { name: 'المساء', key: 'evening', icon: 'fas fa-moon' },
                { name: 'الليل', key: 'night', icon: 'fas fa-star' },
                { name: 'بدون وقت', key: 'noTime', icon: 'fas fa-clock' }
            ];
            
            timeSlots.forEach(slot => {
                const tasks = tasksByTime[slot.key];
                if (tasks.length === 0) return;
                
                html += `
                    <div class="day-column">
                        <div class="day-header">
                            <div class="day-title"><i class="${slot.icon}"></i> ${slot.name}</div>
                            <div class="day-date">${tasks.length} مهام</div>
                        </div>
                        <div class="day-tasks">
                `;
                
                tasks.forEach(task => {
                    const category = getCategoryById(task.categoryId);
                    html += `
                        <div class="calendar-task" style="border-color: ${category.color}">
                            <div class="task-actions">
                                <button class="btn btn-success btn-sm complete-task-btn" data-id="${task.id}" title="إكمال">
                                    <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                                </button>
                            </div>
                            <div class="task-title">${task.title}</div>
                            ${task.time ? `<div class="task-time"><i class="fas fa-clock"></i> ${task.time}</div>` : ''}
                            <div class="task-meta">
                                <span class="category-tag" style="background: ${category.color}; color: white;">${category.name}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration} دقيقة</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // إضافة الأحداث لأزرار الإكمال في الجدول
            document.querySelectorAll('.complete-task-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    toggleTaskCompletion(taskId);
                });
            });
            
        } else if (range === 'weekly') {
            // عرض أسبوعي مبسط
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-week"></i>
                    <h3>العرض الأسبوعي</h3>
                    <p>سيتم تطوير هذا العرض في نسخة لاحقة</p>
                </div>
            `;
        } else {
            // عرض شهري مبسط
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>العرض الشهري</h3>
                    <p>سيتم تطوير هذا العرض في نسخة لاحقة</p>
                </div>
            `;
        }
    }
    
    // ========== إدارة العروض ==========
    function switchView(viewName) {
        AppState.currentView = viewName;
        
        // تحديث التنقل
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.view === viewName) {
                item.classList.add('active');
            }
        });
        
        // تحديث العنوان
        const titles = {
            tasks: 'المهام',
            calendar: 'الجدول الزمني',
            categories: 'إدارة الفئات'
        };
        document.getElementById('page-title').textContent = titles[viewName] || viewName;
        
        // التحكم بشريط الوقت
        document.getElementById('time-tabs').style.display = (viewName === 'calendar') ? 'block' : 'none';
        
        // إخفاء جميع العروض وإظهار العرض الحالي
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.getElementById(`${viewName}-view`).classList.add('active');
        
        // تحميل المحتوى المناسب
        switch(viewName) {
            case 'tasks':
                renderTasks();
                break;
            case 'calendar':
                renderCalendar();
                break;
            case 'categories':
                renderCategories();
                break;
        }
    }
    
    function setFilter(filterName) {
        AppState.currentFilter = filterName;
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filterName) {
                btn.classList.add('active');
            }
        });
        renderTasks();
    }
    
    // ========== إدارة النوافذ ==========
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    function openAddTaskModal(preselectedCategory = null) {
        const categorySelect = document.getElementById('task-category');
        categorySelect.innerHTML = '<option value="">-- اختر الفئة --</option>';
        
        AppState.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (preselectedCategory === category.id) {
                option.selected = true;
            }
            categorySelect.appendChild(option);
        });
        
        // تعيين تاريخ اليوم كافتراضي
        document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
        
        openModal('add-task-modal');
        document.getElementById('task-title').focus();
    }
    
    // ========== محرر الملاحظات ==========
    function setupNotesEditor() {
        const editor = document.getElementById('note-content');
        const toolbar = document.getElementById('editor-toolbar');
        
        // أحجام الخط
        document.getElementById('font-size').addEventListener('change', function() {
            document.execCommand('fontSize', false, this.value);
        });
        
        // خطوط
        document.getElementById('font-family').addEventListener('change', function() {
            document.execCommand('fontName', false, this.value);
        });
        
        // ألوان النص
        document.getElementById('text-color').addEventListener('change', function() {
            document.execCommand('foreColor', false, this.value);
        });
        
        // أزرار التنسيق
        toolbar.querySelectorAll('button[data-command]').forEach(btn => {
            btn.addEventListener('click', function() {
                const command = this.dataset.command;
                document.execCommand(command, false, null);
            });
        });
    }
    
    // ========== تهيئة الصفحة ==========
    function initializePage() {
        console.log("تهيئة الصفحة...");
        
        // تحديث التاريخ
        const now = new Date();
        const arabicDate = now.toLocaleDateString('ar-SA', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-date').textContent = arabicDate;
        
        // تحميل البيانات
        initializeData();
        
        // إعداد محرر الملاحظات
        setupNotesEditor();
        
        // ========== أحداث التنقل ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                switchView(this.dataset.view);
            });
        });
        
        // ========== أحداث أزرار الوقت ==========
        document.querySelectorAll('.time-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                if (AppState.currentView === 'calendar') {
                    renderCalendar();
                }
            });
        });
        
        // ========== أحداث المرشحات ==========
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setFilter(this.dataset.filter);
            });
        });
        
        // ========== إضافة مهمة ==========
        document.getElementById('add-task-btn').addEventListener('click', () => {
            openAddTaskModal();
        });
        
        document.getElementById('add-task-from-category').addEventListener('click', () => {
            openAddTaskModal();
        });
        
        document.getElementById('close-task-modal').addEventListener('click', () => {
            closeModal('add-task-modal');
        });
        
        document.getElementById('cancel-task').addEventListener('click', () => {
            closeModal('add-task-modal');
        });
        
        document.getElementById('save-task').addEventListener('click', () => {
            const title = document.getElementById('task-title').value.trim();
            const category = document.getElementById('task-category').value;
            
            if (!title) {
                alert('يرجى إدخال عنوان المهمة');
                return;
            }
            
            if (!category) {
                alert('يرجى اختيار فئة للمهمة');
                return;
            }
            
            addTask({
                title: title,
                description: document.getElementById('task-description').value.trim(),
                categoryId: category,
                duration: document.getElementById('task-duration').value,
                date: document.getElementById('task-date').value,
                time: document.getElementById('task-time').value,
                priority: document.getElementById('task-priority').value
            });
        });
        
        // ========== إضافة فئة ==========
        document.getElementById('add-category-btn').addEventListener('click', () => {
            openModal('add-category-modal');
            document.getElementById('category-name').focus();
        });
        
        document.getElementById('close-category-modal').addEventListener('click', () => {
            closeModal('add-category-modal');
        });
        
        document.getElementById('cancel-category').addEventListener('click', () => {
            closeModal('add-category-modal');
        });
        
        document.getElementById('save-category').addEventListener('click', () => {
            const name = document.getElementById('category-name').value.trim();
            if (!name) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }
            
            addCategory({
                name: name,
                color: document.getElementById('category-color').value
            });
        });
        
        // ========== إدارة الملاحظات ==========
        document.getElementById('close-notes-modal').addEventListener('click', () => {
            closeModal('notes-modal');
        });
        
        document.getElementById('cancel-note').addEventListener('click', () => {
            closeModal('notes-modal');
        });
        
        document.getElementById('save-note').addEventListener('click', saveNote);
        
        // ========== إغلاق النوافذ عند النقر خارجها ==========
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });
        
        // ========== تحميل العرض الأولي ==========
        renderTasks();
        console.log("✅ التطبيق جاهز للاستخدام!");
    }
    
    // بدء التطبيق عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
