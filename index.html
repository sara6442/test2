<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهامي - نظام إدارة المهام المتقدم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        /* الثيم الفاتح (الإفتراضي) */
        --primary: #4361ee; --secondary: #3a0ca3; --accent: #7209b7;
        --success: #4cc9f0; --danger: #f72585; --warning: #f8961e;
        --light: #f8f9fa; --dark: #424242; --gray: #6c757d; /* تغيير الأسود إلى رمادي فاتح */
        --bg-color: #f5f7fb; --card-bg: #ffffff; --text-color: #424242; /* تفتيح النص */
        --border-color: #dee2e6; --hover-bg: #f8f9fa;
        --sidebar-gradient: linear-gradient(180deg, #4361ee, #3a0ca3); /* ثابت للشريط الجانبي */
    }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); min-height: 100vh; transition: all 0.3s ease; color: var(--text-color); }
    .container { display: flex; min-height: 100vh; direction: rtl; }
    
    /* الشريط الجانبي - متغير حسب الثيم */
    .sidebar { width: 250px; background: var(--sidebar-gradient); color: white; padding: 20px 0; transition: all 0.3s; }
    .logo { padding: 0 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .logo h1 { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; }
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: rgba(255,255,255,0.9); text-decoration: none; border-radius: 8px; margin: 0 15px 5px; transition: 0.3s; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: rgba(255,255,255,0.2); color: white; font-weight: bold; }
    .nav-item i { width: 24px; text-align: center; }
    
    /* رأس الصفحة مع اختيار الثيم */
    .theme-selector { display: flex; gap: 10px; align-items: center; margin-top: 15px; }
    .theme-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; transition: 0.3s; position: relative; }
    .theme-btn:hover { transform: scale(1.1); border-color: white; }
    .theme-btn.active { border-color: white; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }
    .theme-btn.active::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; font-weight: bold; }
    .theme-light { background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
    .theme-dark { background: linear-gradient(135deg, #424242, #343a40); } /* تفتيح الأسود */
    .theme-blue { background: linear-gradient(135deg, #4361ee, #3a0ca3); }
    .theme-light-blue { background: linear-gradient(135deg, #4cc9f0, #38b6ff); } /* تغيير الأخضر إلى أزرق فاتح */
    
    /* المحتوى الرئيسي */
    .main-content { flex: 1; margin-right: 250px; padding: 20px; transition: all 0.3s; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .header-left h2 { color: var(--primary); margin-bottom: 5px; font-weight: 600; }
    .date-display { color: var(--gray); font-size: 0.9rem; }
    
    /* أزرار */
    .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.3s; background: var(--primary); color: white; font-size: 0.95rem; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-primary { background: var(--primary); }
    .btn-secondary { background: var(--gray); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); }
    .btn-info { background: #3a86ff; }
    .btn-light { background: var(--light); color: var(--text-color); border: 1px solid var(--border-color); }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
    
    /* زر حالة الفئات */
    .category-status-btn { 
        padding: 8px 16px; 
        background: rgba(67, 97, 238, 0.1); 
        color: var(--primary); 
        border: 1px solid rgba(67, 97, 238, 0.2);
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    .category-status-btn:hover { 
        background: rgba(67, 97, 238, 0.2); 
        transform: translateY(-1px);
    }
    
    /* شريط الوقت */
    .time-navigation { display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: var(--card-bg); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .time-btn { flex: 1; padding: 10px; border: 2px solid var(--border-color); background: var(--card-bg); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-color); transition: 0.3s; }
    .time-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .time-btn:hover { border-color: var(--primary); }
    
    /* المحتوى */
    .content-area { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .view { display: none; }
    .active-view { display: block; }
    
    /* المهام */
    .tasks-list { display: flex; flex-direction: column; gap: 12px; }
    .task-item { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        padding: 16px; 
        background: var(--hover-bg); 
        border-radius: 8px; 
        border-right: 4px solid var(--primary); 
        transition: 0.3s;
        cursor: pointer;
    }
    .task-item:hover { transform: translateX(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .task-item.completed { opacity: 0.9; border-color: #38b000; }
    .task-item.completed .task-title { text-decoration: line-through; color: #38b000; }
    .task-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
    .task-content { flex: 1; }
    .task-title { font-weight: 600; margin-bottom: 6px; color: var(--text-color); font-size: 1.05rem; }
    .task-description { color: var(--gray); font-size: 0.9rem; margin-bottom: 10px; line-height: 1.5; }
    .task-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--gray); flex-wrap: wrap; }
    .task-actions { display: flex; gap: 5px; }
    
    /* الفئات */
    .category-card { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        padding: 16px; 
        background: var(--hover-bg); 
        border-radius: 8px; 
        margin-bottom: 15px;
        border-right: 4px solid;
        transition: all 0.3s;
    }
    .category-info { flex: 1; }
    .category-name { font-weight: 600; margin-bottom: 6px; color: var(--text-color); font-size: 1.1rem; }
    .category-stats { font-size: 0.85rem; color: var(--gray); margin-bottom: 8px; }
    .category-actions { display: flex; gap: 5px; }
    
    /* شريط التقدم في الفئات */
    .category-progress-container { 
        width: 100%; 
        height: 10px; 
        background: var(--border-color); 
        border-radius: 5px; 
        overflow: hidden; 
        margin: 10px 0;
        position: relative;
    }
    .category-progress-bar { 
        height: 100%; 
        border-radius: 5px;
        transition: width 0.5s ease;
        background: var(--card-bg); /* الخلفية للفراغ */
    }
    .category-task-bar {
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border-radius: 5px;
        opacity: 0.7; /* باهتة */
        transition: all 0.3s ease;
    }
    .category-task-bar.completed {
        opacity: 1; /* مكتملة أكثر وضوحاً */
        background: #38b000 !important; /* أخضر للمهام المكتملة */
    }
    
    /* الجدول الزمني */
    .calendar-view { margin-top: 20px; }
    .calendar-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-body { min-height: 400px; }
    
    /* عرض يومي - 24 ساعة */
    .daily-view { display: flex; flex-direction: column; gap: 1px; background: var(--border-color); border-radius: 8px; overflow: hidden; }
    .time-slot { 
        display: flex; 
        gap: 0; 
        padding: 0;
        background: var(--card-bg);
    }
    .time-label { 
        width: 80px; 
        font-weight: 600; 
        color: var(--text-color);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        border-right: 1px solid var(--border-color);
        background: var(--hover-bg);
        font-size: 0.9rem;
    }
    .time-tasks { 
        flex: 1; 
        display: flex; 
        flex-wrap: wrap; 
        gap: 5px; 
        padding: 5px;
        min-height: 60px;
        position: relative;
    }
    .calendar-task { 
        padding: 6px 10px; 
        border-radius: 6px; 
        font-size: 0.8rem;
        color: white;
        cursor: pointer;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        transition: all 0.3s;
        border: 1px solid rgba(255,255,255,0.2);
        opacity: 0.8; /* باهتة */
    }
    .calendar-task:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); z-index: 10; opacity: 1; }
    .calendar-task.completed { opacity: 1; background: #38b000 !important; } /* أخضر للمهام المكتملة */
    
    /* معلومات عند التحويم */
    .task-tooltip {
        position: absolute;
        background: var(--card-bg);
        color: var(--text-color);
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 300px;
        display: none;
        border: 1px solid var(--border-color);
        font-size: 0.85rem;
        line-height: 1.5;
    }
    .task-tooltip h4 { margin-bottom: 6px; color: var(--primary); font-weight: 600; }
    .task-tooltip p { margin-bottom: 6px; color: var(--gray); }
    .task-tooltip .tooltip-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; margin-top: 8px; }
    
    /* عرض أسبوعي */
    .weekly-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day-column { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background: var(--card-bg); }
    .day-header { 
        text-align: center; 
        padding-bottom: 10px; 
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--text-color);
    }
    .day-today { background: rgba(67, 97, 238, 0.08); border-color: var(--primary); }
    .day-tasks { min-height: 200px; }
    
    /* عرض شهري */
    .monthly-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border-color); border-radius: 8px; overflow: hidden; }
    .month-day { 
        border: 1px solid var(--border-color); 
        padding: 8px; 
        min-height: 100px;
        position: relative;
        background: var(--card-bg);
    }
    .month-day-header { 
        display: flex; 
        justify-content: space-between; 
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    .day-number { font-weight: 600; color: var(--text-color); }
    .today-indicator { 
        background: var(--primary); 
        color: white; 
        width: 24px; 
        height: 24px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-weight: 600;
    }
    .other-month { background: var(--hover-bg); color: #adb5bd; }
    
    /* النوافذ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; color: var(--text-color); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-color); }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
    
    /* نافذة إعدادات المهمة */
    .task-settings-tabs { 
        display: flex; 
        border-bottom: 1px solid var(--border-color); 
        margin-bottom: 20px;
    }
    .tab-btn { 
        padding: 12px 20px; 
        background: none; 
        border: none; 
        cursor: pointer; 
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: 0.3s;
        color: var(--text-color);
    }
    .tab-btn.active { 
        border-bottom-color: var(--primary); 
        color: var(--primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* محرر الملاحظات */
    .notes-editor { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
    .editor-toolbar { display: flex; gap: 5px; padding: 10px; background: var(--hover-bg); border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
    .editor-btn { padding: 6px 10px; border: 1px solid var(--border-color); background: var(--card-bg); border-radius: 4px; cursor: pointer; color: var(--text-color); }
    .editor-btn:hover { background: var(--hover-bg); }
    .editor-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .notes-content { 
        min-height: 200px; 
        padding: 15px; 
        font-family: inherit; 
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-color);
        background: var(--card-bg);
        border: none;
        outline: none;
        width: 100%;
        resize: vertical;
    }
    .notes-content:focus { outline: none; }
    .note-item { 
        padding: 16px; 
        margin-bottom: 15px; 
        background: var(--hover-bg); 
        border-radius: 8px;
        border-left: 4px solid var(--primary);
    }
    .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .note-date { font-size: 0.85rem; color: var(--gray); }
    .note-actions { display: flex; gap: 5px; }
    .note-content { line-height: 1.6; }
    
    /* النماذج */
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-color); }
    .form-group input, .form-group select, .form-group textarea { 
        width: 100%; 
        padding: 10px 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        font-size: 1rem; 
        background: var(--card-bg);
        color: var(--text-color);
        transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }
    
    /* الإحصائيات */
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
        gap: 20px; 
        margin-top: 20px;
    }
    .stat-card { 
        background: var(--hover-bg); 
        padding: 20px; 
        border-radius: 10px; 
        text-align: center;
        border-top: 4px solid;
    }
    
    /* رسائل حالة الفئات */
    .category-status-container { margin-bottom: 20px; }
    .status-message { 
        padding: 16px; 
        border-radius: 8px; 
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: fadeIn 0.5s ease;
        border-right: 4px solid;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .status-empty { 
        background: rgba(67, 97, 238, 0.08); 
        border-right-color: #4361ee; 
        color: #4361ee; 
    }
    .status-progress { 
        background: rgba(248, 150, 30, 0.08); 
        border-right-color: #f8961e; 
        color: #e67700; 
    }
    .status-completed { 
        background: rgba(56, 176, 0, 0.08); 
        border-right-color: #38b000; 
        color: #2b8a3e; 
    }
    .status-full { 
        background: rgba(247, 37, 133, 0.08); 
        border-right-color: #f72585; 
        color: #c2255c; 
    }
    
    /* الحالة الفارغة */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
    .empty-state i { margin-bottom: 20px; opacity: 0.5; }
    .empty-state h4 { margin-bottom: 10px; color: var(--dark); }
    
    /* رسائل التنبيه */
    .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .alert-warning { background: #fff3cd; border: 1px solid #ffcd39; color: #856404; }
    .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    
    /* التذكيرات */
    .reminder-item { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        padding: 10px; 
        background: var(--hover-bg); 
        border-radius: 8px; 
        margin-bottom: 10px;
    }
    .reminder-icon { 
        width: 36px; 
        height: 36px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }
    
    /* مؤشرات الوقت */
    .time-indicator { 
        display: inline-block; 
        padding: 3px 8px; 
        border-radius: 4px; 
        font-size: 0.8rem; 
        font-weight: 500;
        margin-left: 5px;
    }
    .time-soon { background: #fff3cd; color: #856404; }
    .time-overdue { background: #f8d7da; color: #721c24; }
    .time-future { background: #d1ecf1; color: #0c5460; }
    
    /* شريط التصفية */
    .filter-bar { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 20px; 
        padding: 15px; 
        background: var(--hover-bg); 
        border-radius: 8px;
        flex-wrap: wrap;
    }
    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 0.85rem; color: var(--gray); }
    
    /* خصائص النص في الملاحظات */
    .text-bold { font-weight: bold; }
    .text-italic { font-style: italic; }
    .text-underline { text-decoration: underline; }
    .text-strike { text-decoration: line-through; }
    
    /* التمرير */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--hover-bg); }
    ::-webkit-scrollbar-thumb { background: var(--gray); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    
    /* مؤشرات الحالة */
    .status-indicator { 
        display: inline-flex; 
        align-items: center; 
        gap: 5px; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 0.8rem; 
        font-weight: 500;
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary);
    }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-tasks"></i> مهامي</h1>
                <div class="theme-selector">
                    <div class="theme-btn theme-light active" data-theme="light" title="فاتح"></div>
                    <div class="theme-btn theme-dark" data-theme="dark" title="داكن"></div>
                    <div class="theme-btn theme-blue" data-theme="blue" title="أزرق"></div>
                    <div class="theme-btn theme-light-blue" data-theme="light-blue" title="أزرق فاتح"></div>
                </div>
            </div>
            <nav class="main-nav">
                <a href="#" class="nav-item active" data-view="tasks"><i class="fas fa-list-check"></i> المهام</a>
                <a href="#" class="nav-item" data-view="calendar"><i class="fas fa-calendar-days"></i> الجدول</a>
                <a href="#" class="nav-item" data-view="notes"><i class="fas fa-sticky-note"></i> الملاحظات</a>
                <a href="#" class="nav-item" data-view="stats"><i class="fas fa-chart-pie"></i> الإحصائيات</a>
                <a href="#" class="nav-item" data-view="categories"><i class="fas fa-tags"></i> الفئات</a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="header-left">
                    <h2 id="current-view-title">المهام</h2>
                    <div id="current-date" class="date-display"></div>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" id="add-task-btn"><i class="fas fa-plus"></i> إضافة مهمة</button>
                    <button class="btn btn-light" id="add-note-btn" style="display: none;"><i class="fas fa-plus"></i> ملاحظة جديدة</button>
                </div>
            </header>

            <div class="time-navigation" id="time-navigation" style="display: none;">
                <button class="time-btn active" data-range="daily"><i class="fas fa-calendar-day"></i> اليومي</button>
                <button class="time-btn" data-range="weekly"><i class="fas fa-calendar-week"></i> الأسبوعي</button>
                <button class="time-btn" data-range="monthly"><i class="fas fa-calendar-alt"></i> الشهري</button>
            </div>

            <div class="content-area">
                <!-- عرض المهام -->
                <div id="tasks-view" class="view active-view">
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label>تصفية حسب التاريخ:</label>
                            <select id="date-filter" class="filter-select">
                                <option value="all">جميع المهام</option>
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                                <option value="month">هذا الشهر</option>
                                <option value="overdue">متأخرة</option>
                                <option value="upcoming">قادمة</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>تصفية حسب الحالة:</label>
                            <select id="status-filter" class="filter-select">
                                <option value="all">جميع الحالات</option>
                                <option value="pending">قيد الانتظار</option>
                                <option value="completed">مكتملة</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>تصفية حسب الفئة:</label>
                            <select id="category-filter" class="filter-select">
                                <option value="all">جميع الفئات</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" id="clear-filters"><i class="fas fa-times"></i> مسح الفلاتر</button>
                    </div>
                    
                    <div class="category-status-container">
                        <button class="category-status-btn" id="toggle-category-status">
                            <i class="fas fa-chart-bar"></i> عرض حالة الفئات
                        </button>
                        <div id="category-status-messages" style="display: none; margin-top: 15px;"></div>
                    </div>
                    
                    <div class="tasks-list" id="tasks-list">
                        <div class="empty-state">
                            <i class="fas fa-tasks fa-3x"></i>
                            <h4>لا توجد مهام</h4>
                            <p>اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى</p>
                        </div>
                    </div>
                </div>

                <!-- عرض الجدول -->
                <div id="calendar-view" class="view">
                    <div class="calendar-header">
                        <h3 id="calendar-title">الجدول الزمني اليومي</h3>
                        <div class="calendar-nav">
                            <button class="btn btn-secondary" id="prev-period"><i class="fas fa-chevron-right"></i></button>
                            <button class="btn btn-secondary" id="current-period">اليوم</button>
                            <button class="btn btn-secondary" id="next-period"><i class="fas fa-chevron-left"></i></button>
                        </div>
                    </div>
                    <div class="calendar-body" id="calendar-body">
                        <p>اختر عرضاً زمنياً من الأعلى</p>
                    </div>
                </div>

                <!-- عرض الملاحظات -->
                <div id="notes-view" class="view">
                    <div class="notes-container">
                        <h3>الملاحظات</h3>
                        <div class="notes-editor" id="notes-editor" style="display: none;">
                            <div class="editor-toolbar" id="editor-toolbar">
                                <button class="editor-btn" data-command="bold" title="عريض"><i class="fas fa-bold"></i></button>
                                <button class="editor-btn" data-command="italic" title="مائل"><i class="fas fa-italic"></i></button>
                                <button class="editor-btn" data-command="underline" title="تحته خط"><i class="fas fa-underline"></i></button>
                                <button class="editor-btn" data-command="strikeThrough" title="خط في المنتصف"><i class="fas fa-strikethrough"></i></button>
                                <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 5px;"></div>
                                <select class="editor-btn" id="font-size" title="حجم الخط">
                                    <option value="1">صغير</option>
                                    <option value="2" selected>عادي</option>
                                    <option value="3">كبير</option>
                                    <option value="4">كبير جداً</option>
                                </select>
                                <select class="editor-btn" id="text-align" title="محاذاة النص">
                                    <option value="right">يمين</option>
                                    <option value="center">وسط</option>
                                    <option value="left">يسار</option>
                                    <option value="justify">ضبط</option>
                                </select>
                                <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 5px;"></div>
                                <button class="editor-btn" data-command="insertUnorderedList" title="قائمة نقطية"><i class="fas fa-list-ul"></i></button>
                                <button class="editor-btn" data-command="insertOrderedList" title="قائمة رقمية"><i class="fas fa-list-ol"></i></button>
                                <button class="editor-btn" id="clear-format" title="مسح التنسيق"><i class="fas fa-eraser"></i></button>
                            </div>
                            <div class="notes-content" id="notes-content" contenteditable="true" placeholder="اكتب ملاحظتك هنا..."></div>
                        </div>
                        <div class="notes-list" id="notes-list">
                            <div class="empty-state">
                                <i class="fas fa-sticky-note fa-3x"></i>
                                <h4>لا توجد ملاحظات</h4>
                                <p>اضغط على "ملاحظة جديدة" لإنشاء ملاحظتك الأولى</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- عرض الإحصائيات -->
                <div id="stats-view" class="view">
                    <div class="stats-container">
                        <h3>إحصائيات المهام</h3>
                        <div id="stats-grid" class="stats-grid"></div>
                    </div>
                </div>

                <!-- عرض الفئات -->
                <div id="categories-view" class="view">
                    <div class="categories-container">
                        <h3>إدارة الفئات</h3>
                        <button class="btn btn-primary" id="add-category-btn"><i class="fas fa-plus"></i> إضافة فئة</button>
                        <div class="categories-list" id="categories-list" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- نافذة إضافة مهمة -->
    <div class="modal" id="add-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>إضافة مهمة جديدة</h3>
                <button class="close-btn" id="close-task-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <div class="form-group">
                        <label for="task-title">عنوان المهمة *</label>
                        <input type="text" id="task-title" placeholder="أدخل عنوان المهمة" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">وصف المهمة (اختياري)</label>
                        <textarea id="task-description" placeholder="أدخل وصف المهمة" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-category">الفئة *</label>
                            <select id="task-category" required></select>
                        </div>
                        <div class="form-group">
                            <label for="task-duration">المدة (دقائق) *</label>
                            <input type="number" id="task-duration" min="1" value="30" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-start-date">تاريخ البدء *</label>
                            <input type="date" id="task-start-date" required>
                        </div>
                        <div class="form-group">
                            <label for="task-end-date">تاريخ الانتهاء *</label>
                            <input type="date" id="task-end-date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="task-start-time">وقت البدء (اختياري)</label>
                            <input type="time" id="task-start-time">
                        </div>
                        <div class="form-group">
                            <label for="task-end-time">وقت الانتهاء (اختياري)</label>
                            <input type="time" id="task-end-time">
                        </div>
                    </div>
                    <div id="time-check-result"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-task">إلغاء</button>
                <button class="btn btn-primary" id="save-task">حفظ المهمة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إعدادات المهمة -->
    <div class="modal" id="task-settings-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="task-settings-title">إعدادات المهمة</h3>
                <button class="close-btn" id="close-task-settings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="task-settings-tabs">
                    <button class="tab-btn active" data-tab="basic">المعلومات الأساسية</button>
                    <button class="tab-btn" data-tab="time">الوقت والتاريخ</button>
                    <button class="tab-btn" data-tab="reminders">التذكيرات</button>
                </div>
                
                <div id="basic-tab" class="tab-content active">
                    <form id="task-settings-form">
                        <input type="hidden" id="settings-task-id">
                        <div class="form-group">
                            <label for="settings-title">عنوان المهمة *</label>
                            <input type="text" id="settings-title" required>
                        </div>
                        <div class="form-group">
                            <label for="settings-description">وصف المهمة</label>
                            <textarea id="settings-description" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="settings-category">الفئة *</label>
                                <select id="settings-category" required></select>
                            </div>
                            <div class="form-group">
                                <label for="settings-duration">المدة (دقائق) *</label>
                                <input type="number" id="settings-duration" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="settings-priority">الأولوية</label>
                            <select id="settings-priority">
                                <option value="low">منخفضة</option>
                                <option value="medium">متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                    </form>
                </div>
                
                <div id="time-tab" class="tab-content">
                    <form id="time-settings-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="settings-start-date">تاريخ البدء *</label>
                                <input type="date" id="settings-start-date" required>
                            </div>
                            <div class="form-group">
                                <label for="settings-end-date">تاريخ الانتهاء *</label>
                                <input type="date" id="settings-end-date" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="settings-start-time">وقت البدء</label>
                                <input type="time" id="settings-start-time">
                            </div>
                            <div class="form-group">
                                <label for="settings-end-time">وقت الانتهاء</label>
                                <input type="time" id="settings-end-time">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="settings-recurrence">التكرار</label>
                            <select id="settings-recurrence">
                                <option value="none">لا يوجد</option>
                                <option value="daily">يومي</option>
                                <option value="weekly">أسبوعي</option>
                                <option value="monthly">شهري</option>
                            </select>
                        </div>
                    </form>
                </div>
                
                <div id="reminders-tab" class="tab-content">
                    <div class="form-group">
                        <label>إضافة تذكير</label>
                        <div class="form-row">
                            <div class="form-group">
                                <select id="reminder-type">
                                    <option value="notification">إشعار</option>
                                    <option value="email">بريد إلكتروني</option>
                                    <option value="both">الاثنين معاً</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="reminder-time">
                                    <option value="5">5 دقائق قبل</option>
                                    <option value="15">15 دقيقة قبل</option>
                                    <option value="30">30 دقيقة قبل</option>
                                    <option value="60">ساعة قبل</option>
                                    <option value="1440">يوم قبل</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" id="add-reminder-btn"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                    <div id="reminders-list">
                        <p style="color: var(--gray); text-align: center; padding: 20px;">لا توجد تذكيرات</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-task-btn">حذف المهمة</button>
                <button class="btn btn-secondary" id="cancel-task-settings">إلغاء</button>
                <button class="btn btn-primary" id="save-task-settings">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة/تعديل فئة -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-modal-title">إضافة فئة جديدة</h3>
                <button class="close-btn" id="close-category-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="form-group">
                        <label for="category-name">اسم الفئة *</label>
                        <input type="text" id="category-name" placeholder="أدخل اسم الفئة" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category-color">لون الفئة</label>
                            <input type="color" id="category-color" value="#4361ee">
                        </div>
                        <div class="form-group">
                            <label for="category-time-limit">الحصة اليومية (دقائق) *</label>
                            <input type="number" id="category-time-limit" min="1" value="60" required>
                            <small style="color: var(--gray); font-size: 0.85rem;">الحد الأقصى من الدقائق يوميًا</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="category-icon">أيقونة الفئة</label>
                        <select id="category-icon">
                            <option value="fas fa-home">منزل</option>
                            <option value="fas fa-briefcase">عمل</option>
                            <option value="fas fa-graduation-cap">دراسة</option>
                            <option value="fas fa-heartbeat">صحة</option>
                            <option value="fas fa-shopping-cart">تسوق</option>
                            <option value="fas fa-dumbbell">رياضة</option>
                            <option value="fas fa-utensils">طعام</option>
                            <option value="fas fa-users">اجتماعي</option>
                        </select>
                    </div>
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text-color);">رسائل حالة الفئة</h4>
                    <div class="form-group">
                        <label for="category-empty-message">رسالة عندما تكون الفئة فارغة</label>
                        <input type="text" id="category-empty-message" placeholder="أكتب رسالة تشجيعية للبدء" value="فارغة، أضف مهام للبدء!">
                        <small style="color: var(--gray); font-size: 0.85rem;">ستظهر عندما لا توجد مهام في الفئة</small>
                    </div>
                    <div class="form-group">
                        <label for="category-full-message">رسالة عند امتلاء الحصة الزمنية</label>
                        <input type="text" id="category-full-message" placeholder="أكتب رسالة عندما تمتلئ الفئة" value="الحصة اليومية ممتلئة!">
                        <small style="color: var(--gray); font-size: 0.85rem;">ستظهر عند استخدام كامل الحصة اليومية</small>
                    </div>
                    <div class="form-group">
                        <label for="category-completed-message">رسالة عند إكمال جميع المهام</label>
                        <input type="text" id="category-completed-message" placeholder="أكتب رسالة تهنئة للإنجاز" value="أحسنت! جميع المهام مكتملة!">
                        <small style="color: var(--gray); font-size: 0.85rem;">ستظهر عند إنهاء جميع مهام الفئة</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-category">إلغاء</button>
                <button class="btn btn-primary" id="save-category">حفظ الفئة</button>
            </div>
        </div>
    </div>

    <!-- نافذة إعدادات الملاحظة -->
    <div class="modal" id="note-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="note-modal-title">ملاحظة جديدة</h3>
                <button class="close-btn" id="close-note-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="notes-editor">
                    <div class="editor-toolbar">
                        <button class="editor-btn" data-command="bold" title="عريض"><i class="fas fa-bold"></i></button>
                        <button class="editor-btn" data-command="italic" title="مائل"><i class="fas fa-italic"></i></button>
                        <button class="editor-btn" data-command="underline" title="تحته خط"><i class="fas fa-underline"></i></button>
                        <button class="editor-btn" data-command="strikeThrough" title="خط في المنتصف"><i class="fas fa-strikethrough"></i></button>
                        <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 5px;"></div>
                        <select class="editor-btn" id="modal-font-size" title="حجم الخط">
                            <option value="1">صغير</option>
                            <option value="2" selected>عادي</option>
                            <option value="3">كبير</option>
                            <option value="4">كبير جداً</option>
                        </select>
                        <select class="editor-btn" id="modal-text-align" title="محاذاة النص">
                            <option value="right">يمين</option>
                            <option value="center">وسط</option>
                            <option value="left">يسار</option>
                            <option value="justify">ضبط</option>
                        </select>
                        <div style="width: 1px; height: 24px; background: var(--border-color); margin: 0 5px;"></div>
                        <button class="editor-btn" data-command="insertUnorderedList" title="قائمة نقطية"><i class="fas fa-list-ul"></i></button>
                        <button class="editor-btn" data-command="insertOrderedList" title="قائمة رقمية"><i class="fas fa-list-ol"></i></button>
                        <button class="editor-btn" id="modal-clear-format" title="مسح التنسيق"><i class="fas fa-eraser"></i></button>
                    </div>
                    <div class="notes-content" id="modal-notes-content" contenteditable="true" placeholder="اكتب ملاحظتك هنا..."></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-note">إلغاء</button>
                <button class="btn btn-primary" id="save-note">حفظ الملاحظة</button>
            </div>
        </div>
    </div>

    <!-- عنصر لعرض معلومات المهمة عند التحويم -->
    <div id="task-tooltip" class="task-tooltip"></div>

    <script>
    // ========== نظام التخزين ==========
    class TaskManager {
        constructor() {
            console.log("تهيئة TaskManager...");
            
            // تحميل المهام مع التحقق
            const tasksData = this.loadFromStorage('tasks');
            this.tasks = Array.isArray(tasksData) ? tasksData : [];
            
            // تحميل الفئات مع التحقق الشديد
            const categoriesData = this.loadFromStorage('categories');
            
            if (Array.isArray(categoriesData) && categoriesData.length > 0) {
                this.categories = categoriesData;
            } else {
                console.log("استخدام الفئات الافتراضية");
                this.categories = this.getDefaultCategories();
            }
            
            // التأكد النهائي
            if (!Array.isArray(this.categories)) {
                this.categories = this.getDefaultCategories();
            }
            
            // تحميل الملاحظات
            const notesData = this.loadFromStorage('notes');
            this.notes = Array.isArray(notesData) ? notesData : [];
            
            // تحميل التذكيرات
            this.reminders = this.loadFromStorage('reminders') || [];
            
            // تحميل الثيم الحالي
            this.currentTheme = this.loadFromStorage('theme') || 'light';
            
            console.log("الفئات النهائية:", this.categories);
            this.initSampleData();
        }

        loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                if (!data) return null;
                return JSON.parse(data);
            } catch (e) {
                console.error(`خطأ في تحميل ${key}:`, e);
                return null;
            }
        }

        saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`خطأ في حفظ ${key}:`, e);
            }
        }

        getDefaultCategories() {
            return [
                {
                    id: 'personal',
                    name: 'مهام شخصية',
                    color: '#4361ee',
                    timeLimit: 120,
                    icon: 'fas fa-home',
                    emptyMessage: 'فارغة، أضف مهام شخصية للبدء!',
                    fullMessage: 'الحصة الشخصية اليومية ممتلئة!',
                    completedMessage: 'أحسنت! جميع المهام الشخصية مكتملة!'
                },
                {
                    id: 'work',
                    name: 'عمل',
                    color: '#f72585',
                    timeLimit: 480,
                    icon: 'fas fa-briefcase',
                    emptyMessage: 'لا توجد مهام عمل اليوم، أضف مهام للبدء!',
                    fullMessage: 'وقت العمل اليومي انتهى!',
                    completedMessage: 'مهام العمل مكتملة، عمل رائع!'
                },
                {
                    id: 'study',
                    name: 'دراسة',
                    color: '#4cc9f0',
                    timeLimit: 180,
                    icon: 'fas fa-graduation-cap',
                    emptyMessage: 'لا توجد مهام دراسة، أضف مهام للبدء!',
                    fullMessage: 'وقت الدراسة اليومي انتهى!',
                    completedMessage: 'لقد أتممت جلسة الدراسة بنجاح!'
                }
            ];
        }

        initSampleData() {
            // إذا لم تكن هناك مهام، أضف مهام تجريبية
            if (this.tasks.length === 0) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                this.tasks = [
                    {
                        id: '1',
                        title: 'مهمة تجريبية',
                        description: 'هذه مهمة للاختبار',
                        categoryId: 'personal',
                        duration: 30,
                        startDate: today.toISOString().split('T')[0],
                        endDate: today.toISOString().split('T')[0],
                        startTime: '09:00',
                        endTime: '09:30',
                        completed: false,
                        priority: 'medium',
                        recurrence: 'none',
                        createdAt: new Date().toISOString()
                    }
                ];
                this.saveTasks();
            }
            
            // إذا لم تكن هناك ملاحظات، أضف ملاحظة تجريبية
            if (this.notes.length === 0) {
                this.notes = [
                    {
                        id: '1',
                        title: 'ملاحظة تجريبية',
                        content: '<p>هذه ملاحظة <strong>تجريبية</strong> للاختبار.</p><p>يمكنك <u>تنسيق</u> النص كما تريد!</p>',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                this.saveNotes();
            }
            
            // حفظ الفئات دائماً للتأكد
            this.saveCategories();
        }

        getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // ========== المهام ==========
        addTask(task) {
            if (!task.id) task.id = Date.now().toString();
            if (!task.createdAt) task.createdAt = new Date().toISOString();
            this.tasks.push(task);
            this.saveTasks();
            return task;
        }

        updateTask(taskId, updatedData) {
            const index = this.tasks.findIndex(task => task.id === taskId);
            if (index !== -1) {
                this.tasks[index] = { ...this.tasks[index], ...updatedData };
                this.saveTasks();
                return this.tasks[index];
            }
            return null;
        }

        deleteTask(taskId) {
            this.tasks = this.tasks.filter(task => task.id !== taskId);
            this.saveTasks();
        }

        getTasks(filters = {}) {
            let filteredTasks = [...this.tasks];
            
            if (filters.dateFilter) {
                const today = this.getTodayDate();
                const todayDate = new Date(today);
                
                switch(filters.dateFilter) {
                    case 'today':
                        filteredTasks = filteredTasks.filter(task => 
                            task.startDate === today || task.endDate === today
                        );
                        break;
                    case 'week':
                        const weekStart = new Date(todayDate);
                        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        
                        filteredTasks = filteredTasks.filter(task => 
                            task.startDate >= weekStart.toISOString().split('T')[0] && 
                            task.startDate <= weekEnd.toISOString().split('T')[0]
                        );
                        break;
                    case 'month':
                        const monthStart = new Date(todayDate.getFullYear(), todayDate.getMonth(), 1);
                        const monthEnd = new Date(todayDate.getFullYear(), todayDate.getMonth() + 1, 0);
                        
                        filteredTasks = filteredTasks.filter(task => 
                            task.startDate >= monthStart.toISOString().split('T')[0] && 
                            task.startDate <= monthEnd.toISOString().split('T')[0]
                        );
                        break;
                    case 'overdue':
                        filteredTasks = filteredTasks.filter(task => 
                            !task.completed && task.endDate < today
                        );
                        break;
                    case 'upcoming':
                        filteredTasks = filteredTasks.filter(task => 
                            !task.completed && task.startDate > today
                        );
                        break;
                }
            }
            
            if (filters.statusFilter && filters.statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => 
                    filters.statusFilter === 'completed' ? task.completed : !task.completed
                );
            }
            
            if (filters.categoryFilter && filters.categoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => 
                    task.categoryId === filters.categoryFilter
                );
            }
            
            return filteredTasks.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        }

        getTaskById(taskId) {
            return this.tasks.find(task => task.id === taskId);
        }

        toggleTaskCompletion(taskId) {
            const task = this.getTaskById(taskId);
            if (task) {
                task.completed = !task.completed;
                this.saveTasks();
            }
        }

        saveTasks() {
            this.saveToStorage('tasks', this.tasks);
        }

        // التحقق من الوقت المتاح في الفئة
        checkCategoryTimeAvailability(categoryId, taskDuration, taskDate, excludeTaskId = null) {
            const category = this.getCategoryById(categoryId);
            if (!category || !category.timeLimit) return { available: true, remaining: 0 };
            
            const dateTasks = this.tasks.filter(task => 
                task.categoryId === categoryId && 
                task.startDate === taskDate &&
                (!excludeTaskId || task.id !== excludeTaskId)
            );
            
            const totalUsedTime = dateTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
            const remainingTime = category.timeLimit - totalUsedTime;
            
            return {
                available: remainingTime >= taskDuration,
                remaining: remainingTime,
                used: totalUsedTime,
                limit: category.timeLimit,
                percentage: Math.round((totalUsedTime / category.timeLimit) * 100)
            };
        }

        // ========== الفئات ==========
        addCategory(category) {
            if (!category.id) category.id = Date.now().toString();
            if (!category.timeLimit) category.timeLimit = 60;
            if (!category.icon) category.icon = 'fas fa-tag';
            
            // رسائل افتراضية
            if (!category.emptyMessage) category.emptyMessage = 'فارغة، أضف مهام للبدء!';
            if (!category.fullMessage) category.fullMessage = 'الحصة اليومية ممتلئة!';
            if (!category.completedMessage) category.completedMessage = 'أحسنت! جميع المهام مكتملة!';
            
            this.categories.push(category);
            this.saveCategories();
            console.log("تمت إضافة فئة:", category);
            return category;
        }

        updateCategory(categoryId, updatedData) {
            const index = this.categories.findIndex(cat => cat.id === categoryId);
            if (index !== -1) {
                this.categories[index] = { ...this.categories[index], ...updatedData };
                this.saveCategories();
                console.log("تم تحديث الفئة:", this.categories[index]);
                return this.categories[index];
            }
            return null;
        }

        deleteCategory(categoryId) {
            const tasksInCategory = this.tasks.filter(task => task.categoryId === categoryId);
            if (tasksInCategory.length > 0) {
                return { success: false, message: 'لا يمكن حذف فئة تحتوي على مهام' };
            }
            
            this.categories = this.categories.filter(cat => cat.id !== categoryId);
            this.saveCategories();
            return { success: true };
        }

        getCategories() {
            return Array.isArray(this.categories) ? [...this.categories] : [];
        }

        getCategoryById(categoryId) {
            return this.categories.find(cat => cat.id === categoryId);
        }

        saveCategories() {
            this.saveToStorage('categories', this.categories);
        }

        // ========== الملاحظات ==========
        addNote(note) {
            if (!note.id) note.id = Date.now().toString();
            note.createdAt = new Date().toISOString();
            note.updatedAt = note.createdAt;
            this.notes.push(note);
            this.saveNotes();
            return note;
        }

        updateNote(noteId, updatedData) {
            const index = this.notes.findIndex(note => note.id === noteId);
            if (index !== -1) {
                updatedData.updatedAt = new Date().toISOString();
                this.notes[index] = { ...this.notes[index], ...updatedData };
                this.saveNotes();
                return this.notes[index];
            }
            return null;
        }

        deleteNote(noteId) {
            this.notes = this.notes.filter(note => note.id !== noteId);
            this.saveNotes();
        }

        getNotes() {
            return [...this.notes].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }

        getNoteById(noteId) {
            return this.notes.find(note => note.id === noteId);
        }

        saveNotes() {
            this.saveToStorage('notes', this.notes);
        }

        // ========== التذكيرات ==========
        addReminder(taskId, reminder) {
            reminder.id = Date.now().toString();
            reminder.taskId = taskId;
            reminder.createdAt = new Date().toISOString();
            this.reminders.push(reminder);
            this.saveReminders();
            return reminder;
        }

        getTaskReminders(taskId) {
            return this.reminders.filter(reminder => reminder.taskId === taskId);
        }

        deleteReminder(reminderId) {
            this.reminders = this.reminders.filter(r => r.id !== reminderId);
            this.saveReminders();
        }

        saveReminders() {
            this.saveToStorage('reminders', this.reminders);
        }

        // ========== الثيمات ==========
        setTheme(themeName) {
            this.currentTheme = themeName;
            this.saveToStorage('theme', themeName);
            return themeName;
        }

        getTheme() {
            return this.currentTheme;
        }

        // ========== حالة الفئات ==========
        getCategoryStatus(categoryId) {
            const category = this.getCategoryById(categoryId);
            if (!category) return null;
            
            const today = this.getTodayDate();
            const categoryTasks = this.tasks.filter(task => 
                task.categoryId === categoryId && 
                task.startDate === today
            );
            
            const totalTasks = categoryTasks.length;
            const completedTasks = categoryTasks.filter(task => task.completed).length;
            const usedTime = categoryTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
            const percentage = category.timeLimit ? Math.min(100, Math.round((usedTime / category.timeLimit) * 100)) : 0;
            
            let status = '';
            let message = '';
            
            if (totalTasks === 0) {
                status = 'empty';
                message = category.emptyMessage;
            } else if (completedTasks === totalTasks && totalTasks > 0) {
                status = 'completed';
                message = category.completedMessage;
            } else if (percentage >= 100) {
                status = 'full';
                message = category.fullMessage;
            } else {
                status = 'progress';
                message = 'في تقدم...';
            }
            
            return {
                status,
                message,
                categoryName: category.name,
                totalTasks,
                completedTasks,
                usedTime,
                percentage,
                limit: category.timeLimit,
                color: category.color
            };
        }

        getAllCategoryStatuses() {
            const categories = this.getCategories();
            const statuses = [];
            
            categories.forEach(category => {
                const status = this.getCategoryStatus(category.id);
                if (status && status.totalTasks > 0) {
                    statuses.push(status);
                }
            });
            
            return statuses;
        }
    }

    // ========== واجهة المستخدم ==========
    class UI {
        constructor(taskManager) {
            this.taskManager = taskManager;
            this.currentView = 'tasks';
            this.currentCalendarRange = 'daily';
            this.currentCalendarDate = new Date();
            this.editingCategoryId = null;
            this.editingTaskId = null;
            this.editingNoteId = null;
            this.currentFilters = {
                dateFilter: 'all',
                statusFilter: 'all',
                categoryFilter: 'all'
            };
            this.showCategoryStatus = false;
            
            this.initializeElements();
            this.setupEventListeners();
            this.initializeApp();
        }

        initializeElements() {
            this.elements = {
                currentDate: document.getElementById('current-date'),
                currentViewTitle: document.getElementById('current-view-title'),
                addTaskBtn: document.getElementById('add-task-btn'),
                addNoteBtn: document.getElementById('add-note-btn'),
                
                // الثيمات
                themeButtons: document.querySelectorAll('.theme-btn'),
                
                // المهام
                addTaskModal: document.getElementById('add-task-modal'),
                closeTaskModal: document.getElementById('close-task-modal'),
                saveTaskBtn: document.getElementById('save-task'),
                taskTitle: document.getElementById('task-title'),
                taskDescription: document.getElementById('task-description'),
                taskCategory: document.getElementById('task-category'),
                taskDuration: document.getElementById('task-duration'),
                taskStartDate: document.getElementById('task-start-date'),
                taskEndDate: document.getElementById('task-end-date'),
                taskStartTime: document.getElementById('task-start-time'),
                taskEndTime: document.getElementById('task-end-time'),
                cancelTask: document.getElementById('cancel-task'),
                timeCheckResult: document.getElementById('time-check-result'),
                
                // حالة الفئات
                toggleCategoryStatus: document.getElementById('toggle-category-status'),
                categoryStatusMessages: document.getElementById('category-status-messages'),
                
                // إعدادات المهمة
                taskSettingsModal: document.getElementById('task-settings-modal'),
                closeTaskSettings: document.getElementById('close-task-settings'),
                taskSettingsTitle: document.getElementById('task-settings-title'),
                settingsTaskId: document.getElementById('settings-task-id'),
                settingsTitle: document.getElementById('settings-title'),
                settingsDescription: document.getElementById('settings-description'),
                settingsCategory: document.getElementById('settings-category'),
                settingsDuration: document.getElementById('settings-duration'),
                settingsPriority: document.getElementById('settings-priority'),
                settingsStartDate: document.getElementById('settings-start-date'),
                settingsEndDate: document.getElementById('settings-end-date'),
                settingsStartTime: document.getElementById('settings-start-time'),
                settingsEndTime: document.getElementById('settings-end-time'),
                settingsRecurrence: document.getElementById('settings-recurrence'),
                deleteTaskBtn: document.getElementById('delete-task-btn'),
                cancelTaskSettings: document.getElementById('cancel-task-settings'),
                saveTaskSettings: document.getElementById('save-task-settings'),
                
                // التذكيرات
                reminderType: document.getElementById('reminder-type'),
                reminderTime: document.getElementById('reminder-time'),
                addReminderBtn: document.getElementById('add-reminder-btn'),
                remindersList: document.getElementById('reminders-list'),
                
                // التبويبات
                tabButtons: document.querySelectorAll('.tab-btn'),
                tabContents: document.querySelectorAll('.tab-content'),
                
                // الفئات
                categoryModal: document.getElementById('category-modal'),
                categoryModalTitle: document.getElementById('category-modal-title'),
                closeCategoryModal: document.getElementById('close-category-modal'),
                saveCategoryBtn: document.getElementById('save-category'),
                categoryId: document.getElementById('category-id'),
                categoryName: document.getElementById('category-name'),
                categoryColor: document.getElementById('category-color'),
                categoryTimeLimit: document.getElementById('category-time-limit'),
                categoryIcon: document.getElementById('category-icon'),
                categoryEmptyMessage: document.getElementById('category-empty-message'),
                categoryFullMessage: document.getElementById('category-full-message'),
                categoryCompletedMessage: document.getElementById('category-completed-message'),
                cancelCategory: document.getElementById('cancel-category'),
                addCategoryBtn: document.getElementById('add-category-btn'),
                
                // الفلاتر
                dateFilter: document.getElementById('date-filter'),
                statusFilter: document.getElementById('status-filter'),
                categoryFilter: document.getElementById('category-filter'),
                clearFilters: document.getElementById('clear-filters'),
                
                // الجدول
                timeNavigation: document.getElementById('time-navigation'),
                timeButtons: document.querySelectorAll('.time-btn'),
                calendarTitle: document.getElementById('calendar-title'),
                prevPeriod: document.getElementById('prev-period'),
                currentPeriod: document.getElementById('current-period'),
                nextPeriod: document.getElementById('next-period'),
                calendarBody: document.getElementById('calendar-body'),
                
                // الملاحظات
                notesEditor: document.getElementById('notes-editor'),
                editorToolbar: document.getElementById('editor-toolbar'),
                notesContent: document.getElementById('notes-content'),
                notesList: document.getElementById('notes-list'),
                noteModal: document.getElementById('note-modal'),
                noteModalTitle: document.getElementById('note-modal-title'),
                closeNoteModal: document.getElementById('close-note-modal'),
                modalNotesContent: document.getElementById('modal-notes-content'),
                cancelNote: document.getElementById('cancel-note'),
                saveNote: document.getElementById('save-note'),
                
                // أدوات المحرر
                editorButtons: document.querySelectorAll('.editor-btn[data-command]'),
                fontSize: document.getElementById('font-size'),
                textAlign: document.getElementById('text-align'),
                clearFormat: document.getElementById('clear-format'),
                modalFontSize: document.getElementById('modal-font-size'),
                modalTextAlign: document.getElementById('modal-text-align'),
                modalClearFormat: document.getElementById('modal-clear-format'),
                
                // القوائم
                navItems: document.querySelectorAll('.nav-item'),
                views: document.querySelectorAll('.view'),
                tasksList: document.getElementById('tasks-list'),
                statsGrid: document.getElementById('stats-grid'),
                categoriesList: document.getElementById('categories-list'),
                
                // العناصر العامة
                taskTooltip: document.getElementById('task-tooltip')
            };
        }

        setupEventListeners() {
            // التنقل
            this.elements.navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchView(item.dataset.view);
                });
            });

            // الثيمات
            this.elements.themeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const theme = e.currentTarget.dataset.theme;
                    this.applyTheme(theme);
                });
            });

            // إضافة مهمة
            this.elements.addTaskBtn.addEventListener('click', () => this.openAddTaskModal());
            this.elements.closeTaskModal.addEventListener('click', () => this.closeModal('add-task-modal'));
            this.elements.saveTaskBtn.addEventListener('click', () => this.saveTask());
            this.elements.cancelTask.addEventListener('click', () => this.closeModal('add-task-modal'));
            
            // الملاحظات
            this.elements.addNoteBtn.addEventListener('click', () => this.openNoteModal());
            this.elements.closeNoteModal.addEventListener('click', () => this.closeModal('note-modal'));
            this.elements.saveNote.addEventListener('click', () => this.saveNote());
            this.elements.cancelNote.addEventListener('click', () => this.closeModal('note-modal'));
            
            // حالة الفئات
            this.elements.toggleCategoryStatus.addEventListener('click', () => this.toggleCategoryStatus());
            
            // التحقق من الوقت
            this.elements.taskCategory.addEventListener('change', () => this.checkTimeAvailability());
            this.elements.taskDuration.addEventListener('input', () => this.checkTimeAvailability());
            this.elements.taskStartDate.addEventListener('change', () => this.checkTimeAvailability());
            
            // تحديث تاريخ الانتهاء
            this.elements.taskStartDate.addEventListener('change', () => {
                this.elements.taskEndDate.min = this.elements.taskStartDate.value;
                if (this.elements.taskEndDate.value < this.elements.taskStartDate.value) {
                    this.elements.taskEndDate.value = this.elements.taskStartDate.value;
                }
            });
            
            // إعدادات المهمة
            this.elements.closeTaskSettings.addEventListener('click', () => this.closeModal('task-settings-modal'));
            this.elements.deleteTaskBtn.addEventListener('click', () => this.deleteTask());
            this.elements.cancelTaskSettings.addEventListener('click', () => this.closeModal('task-settings-modal'));
            this.elements.saveTaskSettings.addEventListener('click', () => this.saveTaskSettings());
            
            // التبويبات
            this.elements.tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    this.switchTab(tabId);
                });
            });
            
            // التذكيرات
            this.elements.addReminderBtn.addEventListener('click', () => this.addReminder());
            
            // الفئات
            this.elements.addCategoryBtn.addEventListener('click', () => this.openCategoryModal());
            this.elements.closeCategoryModal.addEventListener('click', () => this.closeModal('category-modal'));
            this.elements.saveCategoryBtn.addEventListener('click', () => this.saveCategory());
            this.elements.cancelCategory.addEventListener('click', () => this.closeModal('category-modal'));
            
            // الفلاتر
            this.elements.dateFilter.addEventListener('change', () => this.applyFilters());
            this.elements.statusFilter.addEventListener('change', () => this.applyFilters());
            this.elements.categoryFilter.addEventListener('change', () => this.applyFilters());
            this.elements.clearFilters.addEventListener('click', () => this.clearAllFilters());
            
            // الجدول الزمني
            this.elements.timeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    this.currentCalendarRange = btn.dataset.range;
                    this.elements.timeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.loadCalendarView();
                });
            });
            
            this.elements.prevPeriod.addEventListener('click', () => this.navigateCalendar(-1));
            this.elements.nextPeriod.addEventListener('click', () => this.navigateCalendar(1));
            this.elements.currentPeriod.addEventListener('click', () => this.resetCalendar());
            
            // أدوات المحرر
            this.setupEditorListeners();
        }

        setupEditorListeners() {
            // أزرار التنسيق
            this.elements.editorButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = e.currentTarget.dataset.command;
                    document.execCommand(command, false, null);
                });
            });
            
            // حجم الخط
            this.elements.fontSize.addEventListener('change', (e) => {
                document.execCommand('fontSize', false, e.target.value);
            });
            
            this.elements.modalFontSize.addEventListener('change', (e) => {
                document.execCommand('fontSize', false, e.target.value);
            });
            
            // محاذاة النص
            this.elements.textAlign.addEventListener('change', (e) => {
                document.execCommand('justifyLeft', false, null);
                document.execCommand('justifyCenter', false, null);
                document.execCommand('justifyRight', false, null);
                document.execCommand('justifyFull', false, null);
                
                if (e.target.value === 'left') document.execCommand('justifyLeft', false, null);
                else if (e.target.value === 'center') document.execCommand('justifyCenter', false, null);
                else if (e.target.value === 'right') document.execCommand('justifyRight', false, null);
                else if (e.target.value === 'justify') document.execCommand('justifyFull', false, null);
            });
            
            this.elements.modalTextAlign.addEventListener('change', (e) => {
                document.execCommand('justifyLeft', false, null);
                document.execCommand('justifyCenter', false, null);
                document.execCommand('justifyRight', false, null);
                document.execCommand('justifyFull', false, null);
                
                if (e.target.value === 'left') document.execCommand('justifyLeft', false, null);
                else if (e.target.value === 'center') document.execCommand('justifyCenter', false, null);
                else if (e.target.value === 'right') document.execCommand('justifyRight', false, null);
                else if (e.target.value === 'justify') document.execCommand('justifyFull', false, null);
            });
            
            // مسح التنسيق
            this.elements.clearFormat.addEventListener('click', () => {
                document.execCommand('removeFormat', false, null);
            });
            
            this.elements.modalClearFormat.addEventListener('click', () => {
                document.execCommand('removeFormat', false, null);
            });
        }

        initializeApp() {
            console.log("تهيئة التطبيق...");
            this.updateDate();
            this.applyTheme(this.taskManager.getTheme());
            this.switchView('tasks');
            
            // تعيين التواريخ الافتراضية
            const today = new Date().toISOString().split('T')[0];
            this.elements.taskStartDate.value = today;
            this.elements.taskEndDate.value = today;
            this.elements.taskStartDate.min = today;
            this.elements.taskEndDate.min = today;
        }

        updateDate() {
            const now = new Date();
            const arabicDate = now.toLocaleDateString('ar-SA', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            this.elements.currentDate.textContent = arabicDate;
        }

        applyTheme(themeName) {
            // تحديث الأزرار
            this.elements.themeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });
            
            // تطبيق الثيم
            const root = document.documentElement;
            const sidebar = document.querySelector('.sidebar');
            
            switch(themeName) {
                case 'light':
                    root.style.setProperty('--bg-color', '#f5f7fb');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--text-color', '#424242');
                    root.style.setProperty('--border-color', '#dee2e6');
                    root.style.setProperty('--hover-bg', '#f8f9fa');
                    root.style.setProperty('--dark', '#424242');
                    root.style.setProperty('--sidebar-gradient', 'linear-gradient(180deg, #4361ee, #3a0ca3)');
                    sidebar.style.background = 'linear-gradient(180deg, #4361ee, #3a0ca3)';
                    break;
                case 'dark':
                    root.style.setProperty('--bg-color', '#121212');
                    root.style.setProperty('--card-bg', '#1e1e1e');
                    root.style.setProperty('--text-color', '#e0e0e0');
                    root.style.setProperty('--border-color', '#424242');
                    root.style.setProperty('--hover-bg', '#2d2d2d');
                    root.style.setProperty('--dark', '#e0e0e0');
                    root.style.setProperty('--sidebar-gradient', 'linear-gradient(180deg, #2d2d2d, #1a1a1a)');
                    sidebar.style.background = 'linear-gradient(180deg, #2d2d2d, #1a1a1a)';
                    break;
                case 'blue':
                    root.style.setProperty('--bg-color', '#e7f5ff');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--text-color', '#1c7ed6');
                    root.style.setProperty('--border-color', '#a5d8ff');
                    root.style.setProperty('--hover-bg', '#d0ebff');
                    root.style.setProperty('--dark', '#1c7ed6');
                    root.style.setProperty('--sidebar-gradient', 'linear-gradient(180deg, #1c7ed6, #1864ab)');
                    sidebar.style.background = 'linear-gradient(180deg, #1c7ed6, #1864ab)';
                    break;
                case 'light-blue':
                    root.style.setProperty('--bg-color', '#f0f9ff');
                    root.style.setProperty('--card-bg', '#ffffff');
                    root.style.setProperty('--text-color', '#0ea5e9');
                    root.style.setProperty('--border-color', '#7dd3fc');
                    root.style.setProperty('--hover-bg', '#e0f2fe');
                    root.style.setProperty('--dark', '#0ea5e9');
                    root.style.setProperty('--sidebar-gradient', 'linear-gradient(180deg, #38b6ff, #0ea5e9)');
                    sidebar.style.background = 'linear-gradient(180deg, #38b6ff, #0ea5e9)';
                    break;
            }
            
            this.taskManager.setTheme(themeName);
        }

        toggleCategoryStatus() {
            this.showCategoryStatus = !this.showCategoryStatus;
            
            if (this.showCategoryStatus) {
                this.elements.toggleCategoryStatus.innerHTML = '<i class="fas fa-times"></i> إخفاء حالة الفئات';
                this.loadCategoryStatus();
            } else {
                this.elements.toggleCategoryStatus.innerHTML = '<i class="fas fa-chart-bar"></i> عرض حالة الفئات';
                this.elements.categoryStatusMessages.style.display = 'none';
            }
        }

        loadCategoryStatus() {
            const statuses = this.taskManager.getAllCategoryStatuses();
            const container = this.elements.categoryStatusMessages;
            
            if (statuses.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 15px;">لا توجد فئات تحتوي على مهام اليوم</p>';
                container.style.display = 'block';
                return;
            }
            
            let html = '';
            
            statuses.forEach(status => {
                const statusClass = `status-${status.status}`;
                const icon = status.status === 'empty' ? 'fas fa-inbox' :
                           status.status === 'progress' ? 'fas fa-hourglass-half' :
                           status.status === 'completed' ? 'fas fa-check-circle' :
                           'fas fa-exclamation-triangle';
                
                html += `
                    <div class="status-message ${statusClass}">
                        <i class="${icon} fa-lg"></i>
                        <div>
                            <strong>${status.categoryName}:</strong> ${status.message}
                            <div style="font-size: 0.85rem; margin-top: 5px; color: inherit; opacity: 0.9;">
                                ${status.totalTasks} مهمة • ${status.completedTasks} مكتملة • ${status.usedTime}/${status.limit} دقيقة
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            container.style.display = 'block';
        }

        switchView(viewName) {
            this.currentView = viewName;
            
            // تحديث التنقل
            this.elements.navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === viewName) {
                    item.classList.add('active');
                }
            });
            
            // تحديث العنوان
            const titles = {
                tasks: 'المهام',
                calendar: 'الجدول الزمني',
                notes: 'الملاحظات',
                stats: 'الإحصائيات',
                categories: 'إدارة الفئات'
            };
            this.elements.currentViewTitle.textContent = titles[viewName];
            
            // التحكم بالأزرار
            this.elements.addTaskBtn.style.display = (viewName === 'tasks') ? 'inline-flex' : 'none';
            this.elements.addNoteBtn.style.display = (viewName === 'notes') ? 'inline-flex' : 'none';
            
            // التحكم بشريط الوقت
            this.elements.timeNavigation.style.display = (viewName === 'calendar') ? 'flex' : 'none';
            
            // إعادة تعيين حالة الفئات
            this.showCategoryStatus = false;
            this.elements.toggleCategoryStatus.innerHTML = '<i class="fas fa-chart-bar"></i> عرض حالة الفئات';
            this.elements.categoryStatusMessages.style.display = 'none';
            
            // إظهار/إخفاء العروض
            this.elements.views.forEach(view => {
                view.classList.remove('active-view');
                if (view.id === `${viewName}-view`) {
                    view.classList.add('active-view');
                }
            });
            
            // تحميل المحتوى
            switch(viewName) {
                case 'tasks':
                    this.loadTasksView();
                    break;
                case 'calendar':
                    this.loadCalendarView();
                    break;
                case 'notes':
                    this.loadNotesView();
                    break;
                case 'stats':
                    this.loadStatsView();
                    break;
                case 'categories':
                    this.loadCategoriesView();
                    break;
            }
        }

        switchTab(tabId) {
            this.elements.tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });
            
            this.elements.tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                }
            });
        }

        // تحميل المهام
        loadTasksView() {
            this.updateFilterOptions();
            
            const tasks = this.taskManager.getTasks(this.currentFilters);
            
            if (!tasks || tasks.length === 0) {
                this.elements.tasksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks fa-3x"></i>
                        <h4>لا توجد مهام</h4>
                        <p>اضغط على "إضافة مهمة" لإنشاء مهمتك الأولى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            const today = this.taskManager.getTodayDate();
            
            tasks.forEach(task => {
                const category = this.taskManager.getCategoryById(task.categoryId);
                
                let timeStatus = '';
                if (task.completed) {
                    timeStatus = `<span class="time-indicator" style="background: #38b000; color: white;">مكتملة</span>`;
                } else if (task.endDate < today) {
                    timeStatus = `<span class="time-indicator time-overdue">متأخرة</span>`;
                } else if (task.startDate === today) {
                    timeStatus = `<span class="time-indicator time-soon">اليوم</span>`;
                } else if (task.startDate > today) {
                    const daysDiff = Math.ceil((new Date(task.startDate) - new Date(today)) / (1000 * 60 * 60 * 24));
                    timeStatus = `<span class="time-indicator time-future">بعد ${daysDiff} يوم</span>`;
                }
                
                html += `
                    <div class="task-item ${task.completed ? 'completed' : ''}" data-id="${task.id}" style="border-right-color: ${category?.color || '#4361ee'}">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                        <div class="task-content">
                            <div class="task-title">${task.title || 'بدون عنوان'} ${timeStatus}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-meta">
                                <span><i class="fas fa-tag" style="color: ${category?.color || '#000'}"></i> ${category?.name || 'عام'}</span>
                                <span><i class="fas fa-clock"></i> ${task.duration || 30} دقيقة</span>
                                <span><i class="fas fa-calendar"></i> ${this.formatArabicDate(task.startDate)}</span>
                                ${task.startTime ? `<span><i class="fas fa-clock"></i> ${task.startTime}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-sm btn-info edit-task" data-id="${task.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-task" data-id="${task.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            this.elements.tasksList.innerHTML = html;
            
            // أحداث المهام
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const taskId = e.target.closest('.task-item').dataset.id;
                    this.taskManager.toggleTaskCompletion(taskId);
                    this.loadTasksView();
                    if (this.showCategoryStatus) {
                        this.loadCategoryStatus();
                    }
                });
            });
            
            document.querySelectorAll('.delete-task').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
                        this.taskManager.deleteTask(taskId);
                        this.loadTasksView();
                        if (this.showCategoryStatus) {
                            this.loadCategoryStatus();
                        }
                    }
                });
            });
            
            document.querySelectorAll('.edit-task').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const taskId = e.target.closest('button').dataset.id;
                    this.openTaskSettings(taskId);
                });
            });
            
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.task-actions') && !e.target.classList.contains('task-checkbox')) {
                        const taskId = item.dataset.id;
                        this.openTaskSettings(taskId);
                    }
                });
            });
        }

        updateFilterOptions() {
            const categorySelect = this.elements.categoryFilter;
            categorySelect.innerHTML = '<option value="all">جميع الفئات</option>';
            
            const categories = this.taskManager.getCategories();
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                option.selected = this.currentFilters.categoryFilter === category.id;
                categorySelect.appendChild(option);
            });
            
            this.elements.dateFilter.value = this.currentFilters.dateFilter;
            this.elements.statusFilter.value = this.currentFilters.statusFilter;
        }

        applyFilters() {
            this.currentFilters = {
                dateFilter: this.elements.dateFilter.value,
                statusFilter: this.elements.statusFilter.value,
                categoryFilter: this.elements.categoryFilter.value
            };
            
            this.loadTasksView();
        }

        clearAllFilters() {
            this.currentFilters = {
                dateFilter: 'all',
                statusFilter: 'all',
                categoryFilter: 'all'
            };
            
            this.loadTasksView();
        }

        // تحميل الجدول الزمني
        loadCalendarView() {
            let title = '';
            let content = '';
            
            switch(this.currentCalendarRange) {
                case 'daily':
                    title = this.getArabicDateString(this.currentCalendarDate);
                    content = this.generateDailyView(this.currentCalendarDate);
                    break;
                case 'weekly':
                    const weekRange = this.getWeekRange(this.currentCalendarDate);
                    title = `أسبوع ${this.formatArabicDate(weekRange.start)} - ${this.formatArabicDate(weekRange.end)}`;
                    content = this.generateWeeklyView(this.currentCalendarDate);
                    break;
                case 'monthly':
                    const monthName = this.currentCalendarDate.toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' });
                    title = monthName;
                    content = this.generateMonthlyView(this.currentCalendarDate);
                    break;
            }
            
            this.elements.calendarTitle.textContent = title;
            this.elements.currentPeriod.textContent = this.currentCalendarRange === 'daily' ? 'اليوم' : 
                                                   this.currentCalendarRange === 'weekly' ? 'هذا الأسبوع' : 'هذا الشهر';
            this.elements.calendarBody.innerHTML = content;
            
            this.addCalendarTaskEvents();
        }

        generateDailyView(date) {
            const dateStr = date.toISOString().split('T')[0];
            const tasks = this.taskManager.getTasks({ dateFilter: 'today' }).filter(task => 
                task.startDate === dateStr || task.endDate === dateStr
            );
            
            let html = '<div class="daily-view">';
            
            for (let hour = 0; hour < 24; hour++) {
                const timeLabel = `${hour.toString().padStart(2, '0')}:00`;
                const hourTasks = tasks.filter(task => {
                    if (!task.startTime) return false;
                    const taskHour = parseInt(task.startTime.split(':')[0]);
                    return taskHour === hour;
                });
                
                html += `
                    <div class="time-slot">
                        <div class="time-label">${timeLabel}</div>
                        <div class="time-tasks">
                            ${hourTasks.map(task => {
                                const category = this.taskManager.getCategoryById(task.categoryId);
                                const completedClass = task.completed ? 'completed' : '';
                                return `
                                    <div class="calendar-task ${completedClass}" 
                                         data-id="${task.id}"
                                         style="background: ${category?.color || '#4361ee'}"
                                         onmouseover="ui.showTaskTooltip(event, '${task.id}')"
                                         onmouseout="ui.hideTaskTooltip()">
                                        ${task.title} (${task.duration} دقيقة)
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        generateWeeklyView(date) {
            const weekStart = new Date(date);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const today = new Date().toISOString().split('T')[0];
            
            let html = '<div class="weekly-view">';
            
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(weekStart);
                currentDay.setDate(currentDay.getDate() + i);
                const dateStr = currentDay.toISOString().split('T')[0];
                const dayName = days[i];
                const isToday = dateStr === today;
                
                const dayTasks = this.taskManager.getTasks().filter(task => task.startDate === dateStr);
                
                html += `
                    <div class="day-column ${isToday ? 'day-today' : ''}">
                        <div class="day-header">
                            ${dayName}<br>
                            <small>${currentDay.getDate()}/${currentDay.getMonth() + 1}</small>
                        </div>
                        <div class="day-tasks">
                            ${dayTasks.map(task => {
                                const category = this.taskManager.getCategoryById(task.categoryId);
                                const completedClass = task.completed ? 'completed' : '';
                                return `
                                    <div class="calendar-task ${completedClass}" 
                                         data-id="${task.id}"
                                         style="background: ${category?.color || '#4361ee'}; margin-bottom: 5px;"
                                         onmouseover="ui.showTaskTooltip(event, '${task.id}')"
                                         onmouseout="ui.hideTaskTooltip()">
                                        ${task.title} ${task.startTime ? `(${task.startTime})` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        generateMonthlyView(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date().toISOString().split('T')[0];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            
            let html = '<div class="monthly-view">';
            
            const dayHeaders = ['أحد', 'إثنين', 'ثلاثاء', 'أربعاء', 'خميس', 'جمعة', 'سبت'];
            dayHeaders.forEach(day => {
                html += `<div class="month-day-header" style="text-align: center; font-weight: 600;">${day}</div>`;
            });
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="month-day other-month">${day}</div>`;
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                
                const dayTasks = this.taskManager.getTasks().filter(task => task.startDate === dateStr);
                
                html += `
                    <div class="month-day">
                        <div class="month-day-header">
                            <span class="day-number">${day}</span>
                            ${isToday ? '<span class="today-indicator">'+day+'</span>' : ''}
                        </div>
                        ${dayTasks.slice(0, 3).map(task => {
                            const category = this.taskManager.getCategoryById(task.categoryId);
                            const completedClass = task.completed ? 'completed' : '';
                            return `
                                <div class="calendar-task ${completedClass}" 
                                     data-id="${task.id}"
                                     style="background: ${category?.color || '#4361ee'}; 
                                            font-size: 0.7rem; 
                                            padding: 2px 5px; 
                                            margin-bottom: 2px;"
                                     onmouseover="ui.showTaskTooltip(event, '${task.id}')"
                                     onmouseout="ui.hideTaskTooltip()">
                                    ${task.title}
                                </div>
                            `;
                        }).join('')}
                        ${dayTasks.length > 3 ? `<small style="color: var(--gray);">+ ${dayTasks.length - 3} مهمة</small>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        showTaskTooltip(event, taskId) {
            const task = this.taskManager.getTaskById(taskId);
            if (!task) return;
            
            const category = this.taskManager.getCategoryById(task.categoryId);
            const tooltip = this.elements.taskTooltip;
            
            let content = `
                <h4>${task.title}</h4>
                ${task.description ? `<p>${task.description}</p>` : ''}
                <div class="tooltip-meta">
                    <span><i class="fas fa-tag" style="color: ${category?.color || '#000'}"></i> ${category?.name || 'عام'}</span>
                    <span><i class="fas fa-clock"></i> ${task.duration} دقيقة</span>
                    <span><i class="fas fa-calendar"></i> ${this.formatArabicDate(task.startDate)}</span>
                    ${task.startTime ? `<span><i class="fas fa-clock"></i> ${task.startTime}</span>` : ''}
                    <span><i class="fas ${task.completed ? 'fa-check-circle' : 'fa-hourglass-half'}"></i> ${task.completed ? 'مكتملة' : 'قيد التنفيذ'}</span>
                </div>
                <small>انقر للتعديل</small>
            `;
            
            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 10}px`;
            tooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - tooltip.offsetWidth / 2}px`;
            
            if (parseInt(tooltip.style.left) < 10) {
                tooltip.style.left = '10px';
            }
            
            if (parseInt(tooltip.style.left) + tooltip.offsetWidth > window.innerWidth) {
                tooltip.style.left = `${window.innerWidth - tooltip.offsetWidth - 10}px`;
            }
            
            event.target.addEventListener('click', () => {
                this.openTaskSettings(taskId);
            }, { once: true });
        }

        hideTaskTooltip() {
            this.elements.taskTooltip.style.display = 'none';
        }

        addCalendarTaskEvents() {
            document.querySelectorAll('.calendar-task').forEach(taskElement => {
                taskElement.addEventListener('click', (e) => {
                    const taskId = e.currentTarget.dataset.id;
                    this.openTaskSettings(taskId);
                });
            });
        }

        navigateCalendar(direction) {
            switch(this.currentCalendarRange) {
                case 'daily':
                    this.currentCalendarDate.setDate(this.currentCalendarDate.getDate() + direction);
                    break;
                case 'weekly':
                    this.currentCalendarDate.setDate(this.currentCalendarDate.getDate() + (direction * 7));
                    break;
                case 'monthly':
                    this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + direction);
                    break;
            }
            
            this.loadCalendarView();
        }

        resetCalendar() {
            this.currentCalendarDate = new Date();
            this.loadCalendarView();
        }

        getWeekRange(date) {
            const start = new Date(date);
            start.setDate(start.getDate() - start.getDay());
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            
            return {
                start: start.toISOString().split('T')[0],
                end: end.toISOString().split('T')[0]
            };
        }

        getArabicDateString(date) {
            return date.toLocaleDateString('ar-SA', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        formatArabicDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-SA');
        }

        // تحميل الملاحظات
        loadNotesView() {
            const notes = this.taskManager.getNotes();
            
            if (!notes || notes.length === 0) {
                this.elements.notesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sticky-note fa-3x"></i>
                        <h4>لا توجد ملاحظات</h4>
                        <p>اضغط على "ملاحظة جديدة" لإنشاء ملاحظتك الأولى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            notes.forEach(note => {
                const date = new Date(note.updatedAt);
                const dateStr = date.toLocaleDateString('ar-SA', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let title = note.title || 'ملاحظة بدون عنوان';
                if (!note.title && note.content) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = note.content;
                    const text = tempDiv.textContent || tempDiv.innerText || '';
                    title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
                }
                
                html += `
                    <div class="note-item" data-id="${note.id}">
                        <div class="note-header">
                            <h4 style="margin: 0; color: var(--primary);">${title}</h4>
                            <div class="note-actions">
                                <button class="btn btn-sm btn-info edit-note" data-id="${note.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-note" data-id="${note.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="note-date">آخر تعديل: ${dateStr}</div>
                        <div class="note-content">${note.content}</div>
                    </div>
                `;
            });
            
            this.elements.notesList.innerHTML = html;
            
            document.querySelectorAll('.edit-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noteId = e.target.closest('button').dataset.id;
                    this.openNoteModal(noteId);
                });
            });
            
            document.querySelectorAll('.delete-note').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noteId = e.target.closest('button').dataset.id;
                    if (confirm('هل أنت متأكد من حذف هذه الملاحظة؟')) {
                        this.taskManager.deleteNote(noteId);
                        this.loadNotesView();
                    }
                });
            });
            
            document.querySelectorAll('.note-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.note-actions')) {
                        const noteId = item.dataset.id;
                        this.openNoteModal(noteId);
                    }
                });
            });
        }

        // تحميل الفئات
        loadCategoriesView() {
            console.log("تحميل الفئات...");
            const categories = this.taskManager.getCategories();
            
            if (!categories || categories.length === 0) {
                this.elements.categoriesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tags fa-3x"></i>
                        <h4>لا توجد فئات</h4>
                        <p>اضغط على "إضافة فئة" لإنشاء فئتك الأولى</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            categories.forEach(category => {
                // حساب الوقت المستخدم اليوم
                const today = this.taskManager.getTodayDate();
                const tasks = this.taskManager.getTasks({ dateFilter: 'today' });
                const categoryTasks = tasks.filter(task => task.categoryId === category.id);
                const usedTime = categoryTasks.reduce((sum, task) => sum + (task.duration || 0), 0);
                const percentage = category.timeLimit ? Math.min(100, Math.round((usedTime / category.timeLimit) * 100)) : 0;
                
                // حساب المهام المكتملة
                const completedTasks = categoryTasks.filter(task => task.completed).length;
                const totalTasks = categoryTasks.length;
                
                // إنشاء أشرطة المهام داخل شريط التقدم
                let taskBarsHtml = '';
                let cumulativePosition = 0;
                
                categoryTasks.forEach((task, index) => {
                    const taskWidth = (task.duration / category.timeLimit) * 100;
                    const isCompleted = task.completed;
                    const taskColor = category.color;
                    
                    taskBarsHtml += `
                        <div class="category-task-bar ${isCompleted ? 'completed' : ''}" 
                             style="width: ${taskWidth}%; left: ${cumulativePosition}%; background: ${taskColor};"
                             title="${task.title} (${task.duration} دقيقة) ${isCompleted ? ' - مكتملة' : ''}">
                        </div>
                    `;
                    
                    cumulativePosition += taskWidth;
                });
                
                html += `
                    <div class="category-card" style="border-right-color: ${category.color}">
                        <div style="width: 50px; height: 50px; background: ${category.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                            <i class="${category.icon || 'fas fa-tag'}"></i>
                        </div>
                        <div class="category-info">
                            <div class="category-name">${category.name}</div>
                            <div class="category-stats">
                                <div><i class="fas fa-tasks"></i> ${totalTasks} مهمة • ${completedTasks} مكتملة</div>
                                <div><i class="fas fa-clock"></i> ${usedTime}/${category.timeLimit} دقيقة (${percentage}%)</div>
                            </div>
                            <div class="category-progress-container">
                                <div class="category-progress-bar" style="width: 100%;"></div>
                                ${taskBarsHtml}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> الفراغ: لون الخلفية | المهام: ألوان باهتة | المكتملة: أخضر
                            </div>
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-sm btn-secondary edit-category" data-id="${category.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-category" data-id="${category.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            this.elements.categoriesList.innerHTML = html;
            
            // أحداث الفئات
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.closest('button').dataset.id;
                    this.editCategory(categoryId);
                });
            });
            
            document.querySelectorAll('.delete-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.closest('button').dataset.id;
                    this.deleteCategory(categoryId);
                });
            });
        }

        // باقي الوظائف...
        openAddTaskModal() {
            this.loadCategoryOptions(this.elements.taskCategory);
            
            const today = this.taskManager.getTodayDate();
            this.elements.taskStartDate.value = today;
            this.elements.taskEndDate.value = today;
            this.elements.taskStartTime.value = '';
            this.elements.taskEndTime.value = '';
            this.elements.taskTitle.value = '';
            this.elements.taskDescription.value = '';
            this.elements.taskDuration.value = '30';
            this.elements.timeCheckResult.innerHTML = '';
            
            this.elements.addTaskModal.classList.add('active');
        }

        checkTimeAvailability() {
            const categoryId = this.elements.taskCategory.value;
            const duration = parseInt(this.elements.taskDuration.value) || 0;
            const date = this.elements.taskStartDate.value;
            
            if (!categoryId || duration <= 0 || !date) {
                this.elements.timeCheckResult.innerHTML = '';
                return;
            }
            
            const timeCheck = this.taskManager.checkCategoryTimeAvailability(categoryId, duration, date);
            const category = this.taskManager.getCategoryById(categoryId);
            
            let message = '';
            let alertClass = '';
            
            if (timeCheck.available) {
                alertClass = 'alert-success';
                message = `
                    <i class="fas fa-check-circle"></i>
                    الوقت متاح! ${timeCheck.remaining} دقيقة متبقية في فئة "${category.name}"
                `;
            } else {
                alertClass = 'alert-danger';
                message = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تجاوز الحصة!</strong> تحتاج ${duration} دقيقة لكن المتاح فقط ${timeCheck.remaining} دقيقة في فئة "${category.name}"
                `;
            }
            
            this.elements.timeCheckResult.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
        }

        loadCategoryOptions(selectElement) {
            const categories = this.taskManager.getCategories();
            selectElement.innerHTML = '';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
            
            if (categories.length === 0) {
                const option = document.createElement('option');
                option.value = 'general';
                option.textContent = 'عام';
                selectElement.appendChild(option);
            }
            
            if (selectElement === this.elements.taskCategory) {
                setTimeout(() => this.checkTimeAvailability(), 100);
            }
        }

        saveTask() {
            const title = this.elements.taskTitle.value.trim();
            if (!title) {
                alert('يرجى إدخال عنوان المهمة');
                return;
            }
            
            const duration = parseInt(this.elements.taskDuration.value) || 0;
            if (duration <= 0) {
                alert('يرجى إدخال مدة صحيحة للمهمة');
                return;
            }
            
            const categoryId = this.elements.taskCategory.value;
            if (!categoryId) {
                alert('يرجى اختيار فئة للمهمة');
                return;
            }
            
            const startDate = this.elements.taskStartDate.value;
            const endDate = this.elements.taskEndDate.value;
            
            if (!startDate || !endDate) {
                alert('يرجى إدخال تاريخي البدء والانتهاء');
                return;
            }
            
            const timeCheck = this.taskManager.checkCategoryTimeAvailability(categoryId, duration, startDate);
            if (!timeCheck.available) {
                alert(`لا يمكن إضافة المهمة. الحصة اليومية للفئة ممتلئة. الوقت المتاح: ${timeCheck.remaining} دقيقة فقط`);
                return;
            }
            
            const task = {
                id: Date.now().toString(),
                title: title,
                description: this.elements.taskDescription.value.trim(),
                categoryId: categoryId,
                duration: duration,
                startDate: startDate,
                endDate: endDate,
                startTime: this.elements.taskStartTime.value || null,
                endTime: this.elements.taskEndTime.value || null,
                completed: false,
                priority: 'medium',
                recurrence: 'none',
                createdAt: new Date().toISOString()
            };
            
            this.taskManager.addTask(task);
            this.closeModal('add-task-modal');
            
            if (this.currentView === 'tasks') {
                this.loadTasksView();
            } else if (this.currentView === 'calendar') {
                this.loadCalendarView();
            } else if (this.currentView === 'stats') {
                this.loadStatsView();
            }
            
            if (this.showCategoryStatus) {
                this.loadCategoryStatus();
            }
        }

        openTaskSettings(taskId) {
            this.editingTaskId = taskId;
            const task = this.taskManager.getTaskById(taskId);
            
            if (!task) {
                alert('المهمة غير موجودة');
                return;
            }
            
            this.elements.taskSettingsTitle.textContent = `إعدادات: ${task.title}`;
            this.elements.settingsTaskId.value = task.id;
            this.elements.settingsTitle.value = task.title;
            this.elements.settingsDescription.value = task.description || '';
            
            this.loadCategoryOptions(this.elements.settingsCategory);
            this.elements.settingsCategory.value = task.categoryId;
            
            this.elements.settingsDuration.value = task.duration || 30;
            this.elements.settingsPriority.value = task.priority || 'medium';
            this.elements.settingsStartDate.value = task.startDate;
            this.elements.settingsEndDate.value = task.endDate;
            this.elements.settingsStartTime.value = task.startTime || '';
            this.elements.settingsEndTime.value = task.endTime || '';
            this.elements.settingsRecurrence.value = task.recurrence || 'none';
            
            this.loadReminders(taskId);
            this.switchTab('basic');
            this.elements.taskSettingsModal.classList.add('active');
        }

        loadReminders(taskId) {
            const reminders = this.taskManager.getTaskReminders(taskId);
            const listElement = this.elements.remindersList;
            
            if (reminders.length === 0) {
                listElement.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 20px;">لا توجد تذكيرات</p>';
                return;
            }
            
            let html = '';
            reminders.forEach(reminder => {
                const typeText = reminder.type === 'notification' ? 'إشعار' : 
                               reminder.type === 'email' ? 'بريد إلكتروني' : 'الاثنين معاً';
                
                html += `
                    <div class="reminder-item">
                        <div class="reminder-icon" style="background: ${reminder.type === 'notification' ? '#4361ee' : reminder.type === 'email' ? '#f72585' : '#7209b7'}">
                            <i class="${reminder.type === 'notification' ? 'fas fa-bell' : 'fas fa-envelope'}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${typeText}</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">${reminder.time} دقيقة قبل الموعد</div>
                        </div>
                        <button class="btn btn-sm btn-danger delete-reminder" data-id="${reminder.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
            
            document.querySelectorAll('.delete-reminder').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const reminderId = e.target.closest('button').dataset.id;
                    this.taskManager.deleteReminder(reminderId);
                    this.loadReminders(this.editingTaskId);
                });
            });
        }

        addReminder() {
            const type = this.elements.reminderType.value;
            const time = this.elements.reminderTime.value;
            
            if (!this.editingTaskId) {
                alert('يرجى حفظ المهمة أولاً قبل إضافة تذكيرات');
                return;
            }
            
            const reminder = {
                type: type,
                time: time
            };
            
            this.taskManager.addReminder(this.editingTaskId, reminder);
            this.loadReminders(this.editingTaskId);
            
            this.elements.reminderType.value = 'notification';
            this.elements.reminderTime.value = '5';
        }

        saveTaskSettings() {
            const taskId = this.elements.settingsTaskId.value;
            const task = this.taskManager.getTaskById(taskId);
            
            if (!task) {
                alert('المهمة غير موجودة');
                return;
            }
            
            const updatedTask = {
                title: this.elements.settingsTitle.value.trim(),
                description: this.elements.settingsDescription.value.trim(),
                categoryId: this.elements.settingsCategory.value,
                duration: parseInt(this.elements.settingsDuration.value) || 30,
                priority: this.elements.settingsPriority.value,
                startDate: this.elements.settingsStartDate.value,
                endDate: this.elements.settingsEndDate.value,
                startTime: this.elements.settingsStartTime.value || null,
                endTime: this.elements.settingsEndTime.value || null,
                recurrence: this.elements.settingsRecurrence.value
            };
            
            if (updatedTask.categoryId !== task.categoryId || 
                updatedTask.startDate !== task.startDate || 
                updatedTask.duration !== task.duration) {
                
                const timeCheck = this.taskManager.checkCategoryTimeAvailability(
                    updatedTask.categoryId, 
                    updatedTask.duration, 
                    updatedTask.startDate,
                    taskId
                );
                
                if (!timeCheck.available) {
                    alert(`لا يمكن تحديث المهمة. الحصة اليومية للفئة ممتلئة. الوقت المتاح: ${timeCheck.remaining} دقيقة فقط`);
                    return;
                }
            }
            
            this.taskManager.updateTask(taskId, updatedTask);
            this.closeModal('task-settings-modal');
            
            if (this.currentView === 'tasks') {
                this.loadTasksView();
            } else if (this.currentView === 'calendar') {
                this.loadCalendarView();
            } else if (this.currentView === 'stats') {
                this.loadStatsView();
            }
            
            if (this.showCategoryStatus) {
                this.loadCategoryStatus();
            }
        }

        deleteTask() {
            const taskId = this.elements.settingsTaskId.value;
            
            if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
                this.taskManager.deleteTask(taskId);
                this.closeModal('task-settings-modal');
                
                if (this.currentView === 'tasks') {
                    this.loadTasksView();
                } else if (this.currentView === 'calendar') {
                    this.loadCalendarView();
                } else if (this.currentView === 'stats') {
                    this.loadStatsView();
                }
                
                if (this.showCategoryStatus) {
                    this.loadCategoryStatus();
                }
            }
        }

        openCategoryModal(categoryId = null) {
            this.editingCategoryId = categoryId;
            
            if (categoryId) {
                this.elements.categoryModalTitle.textContent = 'تعديل الفئة';
                const category = this.taskManager.getCategoryById(categoryId);
                if (category) {
                    this.elements.categoryId.value = category.id;
                    this.elements.categoryName.value = category.name;
                    this.elements.categoryColor.value = category.color || '#4361ee';
                    this.elements.categoryTimeLimit.value = category.timeLimit || 60;
                    this.elements.categoryIcon.value = category.icon || 'fas fa-tag';
                    this.elements.categoryEmptyMessage.value = category.emptyMessage || '';
                    this.elements.categoryFullMessage.value = category.fullMessage || '';
                    this.elements.categoryCompletedMessage.value = category.completedMessage || '';
                }
            } else {
                this.elements.categoryModalTitle.textContent = 'إضافة فئة جديدة';
                this.elements.categoryId.value = '';
                this.elements.categoryName.value = '';
                this.elements.categoryColor.value = '#4361ee';
                this.elements.categoryTimeLimit.value = 60;
                this.elements.categoryIcon.value = 'fas fa-tag';
                this.elements.categoryEmptyMessage.value = 'فارغة، أضف مهام للبدء!';
                this.elements.categoryFullMessage.value = 'الحصة اليومية ممتلئة!';
                this.elements.categoryCompletedMessage.value = 'أحسنت! جميع المهام مكتملة!';
            }
            
            this.elements.categoryModal.classList.add('active');
        }

        editCategory(categoryId) {
            this.openCategoryModal(categoryId);
        }

        saveCategory() {
            const name = this.elements.categoryName.value.trim();
            if (!name) {
                alert('يرجى إدخال اسم الفئة');
                return;
            }
            
            const timeLimit = parseInt(this.elements.categoryTimeLimit.value) || 0;
            if (timeLimit <= 0) {
                alert('يرجى إدخال حصة زمنية صحيحة');
                return;
            }
            
            const categoryData = {
                name: name,
                color: this.elements.categoryColor.value,
                timeLimit: timeLimit,
                icon: this.elements.categoryIcon.value,
                emptyMessage: this.elements.categoryEmptyMessage.value,
                fullMessage: this.elements.categoryFullMessage.value,
                completedMessage: this.elements.categoryCompletedMessage.value
            };
            
            if (this.editingCategoryId) {
                this.taskManager.updateCategory(this.editingCategoryId, categoryData);
            } else {
                categoryData.id = Date.now().toString();
                this.taskManager.addCategory(categoryData);
            }
            
            this.closeModal('category-modal');
            
            if (this.currentView === 'categories') {
                this.loadCategoriesView();
            } else if (this.currentView === 'stats') {
                this.loadStatsView();
            } else if (this.currentView === 'tasks') {
                this.loadTasksView();
            }
            
            this.editingCategoryId = null;
        }

        deleteCategory(categoryId) {
            const result = this.taskManager.deleteCategory(categoryId);
            
            if (result.success) {
                this.loadCategoriesView();
                this.loadCategoryOptions(this.elements.taskCategory);
                this.loadCategoryOptions(this.elements.settingsCategory);
                this.updateFilterOptions();
            } else {
                alert(result.message);
            }
        }

        openNoteModal(noteId = null) {
            this.editingNoteId = noteId;
            
            if (noteId) {
                const note = this.taskManager.getNoteById(noteId);
                if (note) {
                    this.elements.noteModalTitle.textContent = 'تعديل الملاحظة';
                    this.elements.modalNotesContent.innerHTML = note.content;
                }
            } else {
                this.elements.noteModalTitle.textContent = 'ملاحظة جديدة';
                this.elements.modalNotesContent.innerHTML = '';
            }
            
            this.elements.noteModal.classList.add('active');
        }

        saveNote() {
            const content = this.elements.modalNotesContent.innerHTML.trim();
            
            if (!content) {
                alert('يرجى إدخال محتوى للملاحظة');
                return;
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const text = tempDiv.textContent || tempDiv.innerText || '';
            const title = text.substring(0, 30) + (text.length > 30 ? '...' : '');
            
            const noteData = {
                title: title,
                content: content
            };
            
            if (this.editingNoteId) {
                this.taskManager.updateNote(this.editingNoteId, noteData);
            } else {
                this.taskManager.addNote(noteData);
            }
            
            this.closeModal('note-modal');
            this.loadNotesView();
            this.editingNoteId = null;
        }

        closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
    }

    // ========== بدء التطبيق ==========
    let taskManager, ui;
    
    document.addEventListener('DOMContentLoaded', () => {
        console.log("بدء تحميل التطبيق...");
        
        try {
            taskManager = new TaskManager();
            ui = new UI(taskManager);
            
            console.log("✅ تم تحميل التطبيق بنجاح!");
            
            // جعل ui متاحاً عالمياً للاستخدام في الأحداث
            window.ui = ui;
            
            console.log("=========================================");
            console.log("🎯 تطبيق إدارة المهام المحسن!");
            console.log("📱 الميزات الجديدة:");
            console.log("   - الشريط الجانبي يتبع لون الثيم");
            console.log("   - ألوان أفتح وأكثر راحة للنظر");
            console.log("   - نظام إشعارات مبسط (3 رسائل فقط)");
            console.log("   - عرض الفئات مع ألوان باهتة للمهام");
            console.log("   - المهام المكتملة تظهر باللون الأخضر");
            console.log("=========================================");
            
        } catch (error) {
            console.error("❌ خطأ في تحميل التطبيق:", error);
            alert('حدث خطأ في تحميل التطبيق. يرجى تحديث الصفحة.');
        }
    });
    </script>
</body>
</html>
